<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RealityLottery - Admin Panel</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background:#121212; color:#fff; min-height:100vh; display:flex; justify-content:center; align-items:center; }
    .admin-container{ width:100%; max-width:1200px; padding:20px; }
    .login-form{ background:rgba(0,0,0,0.8); border:1px solid #ffd700; border-radius:10px; padding:40px; max-width:500px; margin:0 auto; box-shadow:0 10px 30px rgba(0,0,0,0.5); text-align:center; }
    .login-form h1{ color:#ffd700; margin-bottom:30px; font-size:28px; }
    .form-group{ margin-bottom:20px; text-align:left; }
    .form-group label{ display:block; margin-bottom:8px; color:#ffd700; }
    .form-group input{ width:100%; padding:12px 15px; border-radius:5px; border:1px solid #444; background:#222; color:#fff; font-size:16px; }
    .login-btn{ background:linear-gradient(45deg,#ffd700,#ffa500); color:#000; border:none; padding:12px 30px; border-radius:5px; font-weight:bold; font-size:16px; cursor:pointer; transition:all .3s; width:100%; margin-top:10px;}
    .login-btn:hover{ transform:translateY(-3px); box-shadow:0 5px 15px rgba(255,215,0,0.4); }
    .admin-panel{ display:none; background:rgba(0,0,0,0.8); border:1px solid #ffd700; border-radius:10px; padding:30px; box-shadow:0 10px 30px rgba(0,0,0,0.5); }
    .admin-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; padding-bottom:20px; border-bottom:1px solid rgba(255,215,0,0.3); }
    .admin-title{ color:#ffd700; font-size:24px; }
    .logout-btn{ background:transparent; color:#ff6b6b; border:1px solid #ff6b6b; padding:8px 15px; border-radius:5px; cursor:pointer; transition:all .3s; }
    .logout-btn:hover{ background:rgba(255,107,107,0.1); }
    .admin-sections{ display:grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap:20px; }
    .admin-section{ background:rgba(255,215,0,0.05); border:1px solid rgba(255,215,0,0.3); border-radius:10px; padding:20px; }
    .section-title{ color:#ffd700; margin-bottom:15px; font-size:18px; display:flex; align-items:center; gap:10px; }
    .form-control{ width:100%; padding:10px; margin-bottom:15px; background:#222; border:1px solid #444; color:#fff; border-radius:5px; }
    textarea.form-control{ min-height:100px; resize:vertical; }
    .save-btn{ background:linear-gradient(45deg,#ffd700,#ffa500); color:#000; border:none; padding:10px 20px; border-radius:5px; font-weight:bold; cursor:pointer; transition:all .3s; width:100%; }
    .save-btn:hover{ transform:translateY(-3px); box-shadow:0 5px 15px rgba(255,215,0,0.4); }
    .error-message{ color:#ff6b6b; margin-top:10px; text-align:center; display:none; }
    .user-list{ max-height:200px; overflow-y:auto; margin-bottom:15px; border:1px solid rgba(255,215,0,0.3); border-radius:5px; padding:10px; }
    .user-item{ display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.1); }
    .user-item:last-child{ border-bottom:none; }
    .user-actions a{ color:#ff6b6b; margin-left:10px; cursor:pointer; }
    .user-actions a.edit-user{ color:#ffd700; }
    
    /* إضافات جديدة لإدارة المحتوى */
    .content-management { margin-bottom: 20px; }
    .content-item { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,215,0,0.2); }
    .content-item:last-child { border-bottom: none; }
    .content-key { font-weight: bold; color: #ffd700; margin-bottom: 5px; }
    .image-upload-container { 
      border: 2px dashed rgba(255, 215, 0, 0.5); 
      padding: 20px; 
      text-align: center; 
      border-radius: 8px; 
      margin-bottom: 15px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .image-upload-container:hover {
      border-color: #ffd700;
      background: rgba(255, 215, 0, 0.05);
    }
    .image-upload-container p {
      margin-bottom: 10px;
      color: #ffd700;
    }
    .image-preview {
      max-width: 100%;
      max-height: 200px;
      margin-top: 10px;
      display: none;
      border-radius: 5px;
    }
    .status-message {
      text-align: center;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
      display: none;
    }
    .status-success {
      background: rgba(46, 204, 113, 0.2);
      color: #2ecc71;
      border: 1px solid #2ecc71;
    }
    .status-error {
      background: rgba(231, 76, 60, 0.2);
      color: #e74c3c;
      border: 1px solid #e74c3c;
    }
    .add-content-form {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid rgba(255,215,0,0.3);
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <div class="login-form" id="loginForm">
      <h1><i class="fas fa-lock"></i> Admin Login</h1>
      <div class="form-group">
        <label for="username">Username</label>
        <input type="text" id="username" placeholder="Enter admin username">
      </div>
      <div class="form-group">
        <label for="password">Password</label>
        <input type="password" id="password" placeholder="Enter admin password">
      </div>
      <button class="login-btn" onclick="login()">Login</button>
      <div class="error-message" id="errorMessage">Invalid credentials. Please try again.</div>
    </div>

    <div class="admin-panel" id="adminPanel">
      <div class="admin-header">
        <h2 class="admin-title"><i class="fas fa-cog"></i> RealityLottery Admin Panel</h2>
        <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
      </div>

      <div class="admin-sections">
        <!-- إدارة المحتوى القابل للتعديل -->
        <div class="admin-section">
          <h3 class="section-title"><i class="fas fa-edit"></i> Content Management</h3>
          <div id="contentManagement" class="content-management">
            <!-- سيتم ملؤها ديناميكياً -->
          </div>
          
          <div class="add-content-form">
            <h3 class="section-title"><i class="fas fa-plus"></i> Add New Content</h3>
            <div class="form-group">
              <label for="newContentKey">Content Key</label>
              <input type="text" class="form-control" id="newContentKey" placeholder="Example: heroTitle">
            </div>
            <div class="form-group">
              <label for="newContentValue">Content Value</label>
              <textarea class="form-control" id="newContentValue" placeholder="Enter content..."></textarea>
            </div>
            <button class="save-btn" onclick="addContentItem()">Add Content Item</button>
          </div>
          <div id="contentStatus" class="status-message"></div>
        </div>

        <!-- إدارة الصور -->
        <div class="admin-section">
          <h3 class="section-title"><i class="fas fa-images"></i> Image Management</h3>
          
          <div class="form-group">
            <label>Homepage Background Image</label>
            <div class="image-upload-container" onclick="document.getElementById('heroImageInput').click()">
              <p>Click to upload image (max 5MB)</p>
              <img id="heroImagePreview" class="image-preview" src="" alt="Hero Image Preview">
              <input type="file" id="heroImageInput" accept="image/*" style="display: none" onchange="previewImage(this, 'heroImagePreview')">
            </div>
          </div>
          
          <div class="form-group">
            <label>About Us Image</label>
            <div class="image-upload-container" onclick="document.getElementById('aboutImageInput').click()">
              <p>Click to upload image (max 5MB)</p>
              <img id="aboutImagePreview" class="image-preview" src="" alt="About Image Preview">
              <input type="file" id="aboutImageInput" accept="image/*" style="display: none" onchange="previewImage(this, 'aboutImagePreview')">
            </div>
          </div>
          
          <button class="save-btn" onclick="saveImages()">Save Images</button>
          <div id="imageStatus" class="status-message"></div>
        </div>

        <!-- Homepage Content (القديم) -->
        <div class="admin-section">
          <h3 class="section-title"><i class="fas fa-home"></i> Homepage Content</h3>
          <div class="form-group">
            <label>Main Title</label>
            <input type="text" class="form-control" id="mainTitle" value="Dream Big, Win Bigger!">
          </div>
          <div class="form-group">
            <label>Subtitle</label>
            <textarea class="form-control" id="mainSubtitle">Join millions of players worldwide for a chance to win life-changing prizes.</textarea>
          </div>
          <div class="form-group">
            <label>Button Text</label>
            <input type="text" class="form-control" id="mainButton" value="Play Now">
          </div>
          <button class="save-btn">Save Changes</button>
        </div>

        <!-- Carousel Management (القديم) -->
        <div class="admin-section">
          <h3 class="section-title"><i class="fas fa-images"></i> Carousel Slides</h3>
          <div class="form-group">
            <label>Slide 1 Image URL</label>
            <input type="text" class="form-control" id="slide1Url" value="https://images.unsplash.com/photo-1516245834210-c4c142a335d3?auto=format&fit=crop&w=1200&q=80">
          </div>
          <div class="form-group">
            <label>Slide 1 Title</label>
            <input type="text" class="form-control" id="slide1Title" value="Dream Big, Win Bigger!">
          </div>
          <div class="form-group">
            <label>Slide 2 Image URL</label>
            <input type="text" class="form-control" id="slide2Url" value="https://images.unsplash.com/photo-1585314062604-1a357de8b000?auto=format&fit=crop&w=1200&q=80">
          </div>
          <div class="form-group">
            <label>Slide 2 Title</label>
            <input type="text" class="form-control" id="slide2Title" value="Your Chance to Become a Millionaire">
          </div>
          <button class="save-btn">Save Slides</button>
        </div>

        <!-- User Management (القديم) -->
        <div class="admin-section">
          <h3 class="section-title"><i class="fas fa-users"></i> User Management</h3>
          <div class="user-list" id="userList">
            <!-- سيتم ملؤها عبر JS عند طلب /api/admin/users -->
          </div>
          <div class="form-group">
            <label>Add New User</label>
            <input type="text" class="form-control" id="newUsername" placeholder="Enter username">
          </div>
          <button class="save-btn" onclick="addUser()">Add User</button>
        </div>

        <!-- Lottery Settings (القديم) -->
        <div class="admin-section">
          <h3 class="section-title"><i class="fas fa-ticket-alt"></i> Lottery Settings</h3>
          <div class="form-group">
            <label>Jackpot Amount ($)</label>
            <input type="number" class="form-control" id="jackpotAmount" value="1000000">
          </div>
          <div class="form-group">
            <label>Next Draw Date</label>
            <input type="datetime-local" class="form-control" id="nextDrawDate">
          </div>
          <div class="form-group">
            <label>Ticket Price ($)</label>
            <input type="number" class="form-control" id="ticketPrice" value="5" step="0.01">
          </div>
          <button class="save-btn">Update Settings</button>
        </div>

        <!-- Countries (القديم) -->
        <div class="admin-section">
          <h3 class="section-title"><i class="fas fa-globe"></i> Countries</h3>
          <div class="form-group">
            <label>Add Country</label>
            <select class="form-control" id="countrySelect">
              <option value="">Select a country</option>
              <option value="US">United States</option>
              <option value="GB">United Kingdom</option>
              <option value="CA">Canada</option>
              <option value="AU">Australia</option>
              <option value="DE">Germany</option>
              <option value="FR">France</option>
              <option value="ES">Spain</option>
              <option value="IT">Italy</option>
            </select>
          </div>
          <div class="form-group">
            <label>Participants Count</label>
            <input type="number" class="form-control" id="participantsCount" placeholder="Enter number of participants">
          </div>
          <button class="save-btn">Add Country</button>
        </div>

        <!-- Partners (القديم) -->
        <div class="admin-section">
          <h3 class="section-title"><i class="fas fa-handshake"></i> Partners</h3>
          <div class="form-group">
            <label>Partner Name</label>
            <input type="text" class="form-control" id="partnerName" placeholder="Enter partner name">
          </div>
          <div class="form-group">
            <label>Partner Logo URL</label>
            <input type="text" class="form-control" id="partnerLogo" placeholder="Enter logo URL">
          </div>
          <button class="save-btn">Add Partner</button>
        </div>

      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'https://realitylottery.koyeb.app';
    let contentData = {};

    // Admin login via backend
    function login() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const errorMessage = document.getElementById('errorMessage');

      fetch(API_BASE + '/api/admin/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      }).then(async r => {
        const body = await r.json();
        if (!r.ok) {
          errorMessage.style.display = 'block';
          errorMessage.textContent = body.message || 'Invalid credentials';
          document.getElementById('password').value = '';
        } else {
          localStorage.setItem('rl_admin_token', body.token);
          document.getElementById('loginForm').style.display = 'none';
          document.getElementById('adminPanel').style.display = 'block';
          setCurrentDateTime();
          fetchUsers();
          fetchContent(); // جلب المحتوى بعد تسجيل الدخول
        }
      }).catch(err => {
        console.error(err);
        alert('Network error');
      });
    }

    function logout() {
      localStorage.removeItem('rl_admin_token');
      document.getElementById('loginForm').style.display = 'block';
      document.getElementById('adminPanel').style.display = 'none';
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
      document.getElementById('errorMessage').style.display = 'none';
    }

    function setCurrentDateTime() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const input = document.getElementById('nextDrawDate');
      if (input) input.value = `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    async function fetchUsers() {
      const token = localStorage.getItem('rl_admin_token');
      if (!token) return;
      try {
        const res = await fetch(API_BASE + '/api/admin/users', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();
        if (!res.ok) {
          alert(data.message || 'Failed to fetch users');
          return;
        }
        const list = document.getElementById('userList');
        list.innerHTML = '';
        data.users.forEach(u => {
          const div = document.createElement('div');
          div.className = 'user-item';
          div.innerHTML = `<span>${u.fullName} (${u.username})</span>
            <div class="user-actions">
              <a class="edit-user" onclick="editUser('${u._id}')"><i class="fas fa-edit"></i></a>
              <a class="delete-user" onclick="deleteUser('${u._id}')"><i class="fas fa-trash"></i></a>
            </div>`;
          list.appendChild(div);
        });
      } catch (err) {
        console.error(err);
      }
    }

    // جلب المحتوى القابل للتعديل
    async function fetchContent() {
      const token = localStorage.getItem('rl_admin_token');
      if (!token) return;
      
      try {
        const res = await fetch(API_BASE + '/api/content', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        
        if (!res.ok) {
          throw new Error('Failed to fetch content');
        }
        
        contentData = await res.json();
        renderContentItems();
      } catch (err) {
        console.error('Error fetching content:', err);
        showStatus('contentStatus', 'Error loading content: ' + err.message, 'error');
      }
    }

    // عرض عناصر المحتوى
    function renderContentItems() {
      const container = document.getElementById('contentManagement');
      container.innerHTML = '';
      
      Object.entries(contentData).forEach(([key, value]) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'content-item';
        
        itemDiv.innerHTML = `
          <div class="content-key">${key}</div>
          <div class="form-group">
            <textarea class="form-control content-value" data-key="${key}" 
                      placeholder="Enter value">${value}</textarea>
          </div>
          <button class="save-btn" onclick="updateContentItem('${key}')">Update</button>
        `;
        
        container.appendChild(itemDiv);
      });
    }

    // تحديث عنصر محتوى
    async function updateContentItem(key) {
      const token = localStorage.getItem('rl_admin_token');
      if (!token) return;
      
      const value = document.querySelector(`.content-value[data-key="${key}"]`).value;
      
      try {
        const res = await fetch(API_BASE + '/api/admin/content', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ [key]: value })
        });
        
        if (!res.ok) {
          throw new Error('Failed to update content');
        }
        
        showStatus('contentStatus', `"${key}" updated successfully!`, 'success');
        // تحديث البيانات المحلية
        contentData[key] = value;
      } catch (err) {
        console.error('Error updating content:', err);
        showStatus('contentStatus', 'Error updating content: ' + err.message, 'error');
      }
    }

    // إضافة عنصر محتوى جديد
    async function addContentItem() {
      const token = localStorage.getItem('rl_admin_token');
      if (!token) return;
      
      const key = document.getElementById('newContentKey').value.trim();
      const value = document.getElementById('newContentValue').value.trim();
      
      if (!key || !value) {
        showStatus('contentStatus', 'Both key and value are required', 'error');
        return;
      }
      
      try {
        const res = await fetch(API_BASE + '/api/admin/content', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ [key]: value })
        });
        
        if (!res.ok) {
          throw new Error('Failed to add content item');
        }
        
        // تحديث الواجهة
        contentData[key] = value;
        renderContentItems();
        
        // مسح حقول الإدخال
        document.getElementById('newContentKey').value = '';
        document.getElementById('newContentValue').value = '';
        
        showStatus('contentStatus', `"${key}" added successfully!`, 'success');
      } catch (err) {
        console.error('Error adding content item:', err);
        showStatus('contentStatus', 'Error adding item: ' + err.message, 'error');
      }
    }

    // معاينة الصورة قبل الرفع
    function previewImage(input, previewId) {
      const file = input.files[0];
      if (!file) return;
      
      // التحقق من حجم الملف
      if (file.size > 5 * 1024 * 1024) {
        showStatus('imageStatus', 'File size exceeds 5MB limit', 'error');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const preview = document.getElementById(previewId);
        preview.src = e.target.result;
        preview.style.display = 'block';
      }
      reader.readAsDataURL(file);
    }

    // حفظ الصور
    async function saveImages() {
      const token = localStorage.getItem('rl_admin_token');
      if (!token) return;
      
      const heroImageFile = document.getElementById('heroImageInput').files[0];
      const aboutImageFile = document.getElementById('aboutImageInput').files[0];
      
      if (!heroImageFile && !aboutImageFile) {
        showStatus('imageStatus', 'No images selected', 'error');
        return;
      }
      
      try {
        let heroImagePath = '';
        let aboutImagePath = '';
        
        // رفع صورة الخلفية إذا تم اختيارها
        if (heroImageFile) {
          const formData = new FormData();
          formData.append('image', heroImageFile);
          
          const res = await fetch(API_BASE + '/api/admin/upload', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token },
            body: formData
          });
          
          if (!res.ok) {
            throw new Error('Failed to upload hero image');
          }
          
          const data = await res.json();
          heroImagePath = data.imagePath;
        }
        
        // رفع صورة "من نحن" إذا تم اختيارها
        if (aboutImageFile) {
          const formData = new FormData();
          formData.append('image', aboutImageFile);
          
          const res = await fetch(API_BASE + '/api/admin/upload', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token },
            body: formData
          });
          
          if (!res.ok) {
            throw new Error('Failed to upload about image');
          }
          
          const data = await res.json();
          aboutImagePath = data.imagePath;
        }
        
        // تحديث المسارات في قاعدة البيانات
        const updates = {};
        if (heroImagePath) updates.heroImage = heroImagePath;
        if (aboutImagePath) updates.aboutImage = aboutImagePath;
        
        if (Object.keys(updates).length > 0) {
          await fetch(API_BASE + '/api/admin/content', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify(updates)
          });
        }
        
        showStatus('imageStatus', 'Images saved successfully!', 'success');
        setTimeout(() => {
          document.getElementById('imageStatus').style.display = 'none';
        }, 3000);
        
      } catch (err) {
        console.error('Error saving images:', err);
        showStatus('imageStatus', 'Error: ' + err.message, 'error');
      }
    }

    // عرض رسائل الحالة
    function showStatus(elementId, message, type) {
      const statusElement = document.getElementById(elementId);
      statusElement.textContent = message;
      statusElement.className = `status-message status-${type}`;
      statusElement.style.display = 'block';
      
      // إخفاء الرسالة بعد 5 ثواني
      setTimeout(() => {
        statusElement.style.display = 'none';
      }, 5000);
    }

    function addUser() {
      alert('This demo adds user UI-only. Implement create-user API in backend if desired.');
    }

    function editUser(id) {
      alert('Edit user: ' + id + '. Implement edit function as needed.');
    }

    function deleteUser(id) {
      if (!confirm('Are you sure you want to delete this user?')) return;
      alert('Implement delete endpoint on server to delete user ' + id);
    }

    // Initialize
    window.onload = function() {
      const token = localStorage.getItem('rl_admin_token');
      if (token) {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'block';
        setCurrentDateTime();
        fetchUsers();
        fetchContent(); // جلب المحتوى عند التهيئة
      }
      // Enter key to login
      document.getElementById('password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') login();
      });
    };
  </script>
</body>
</html>
