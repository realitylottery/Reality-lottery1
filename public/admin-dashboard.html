<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>RealityLottery — Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
/>
<style>
  :root{
    --bg:#000; --panel:#0f0f0f; --muted:#b9b9b9; --gold:#ffd700; --gold2:#ffa500; --red:#ff5252; --green:#23d18b;
  }
  *{box-sizing:border-box; font-family: Arial, Helvetica, sans-serif;}
  body{margin:0; background:var(--bg); color:#fff; min-height:100vh; display:flex; flex-direction:column;}
  header{border-bottom:2px solid var(--gold); background:#111; padding:16px 20px; display:flex; align-items:center; justify-content:space-between;}
  .brand{font-weight:800; letter-spacing:1px; color:var(--gold); font-size:20px;}
  .admin-state{font-size:14px; color:var(--muted);}
  .wrap{display:flex; flex:1; min-height:0;}
  aside{width:280px; background:var(--panel); border-right:1px solid rgba(255,215,0,0.25); padding:14px; overflow:auto;}
  main{flex:1; padding:16px; overflow:auto;}
  .section{background:#111; border:1px solid rgba(255,215,0,0.25); border-radius:10px; padding:16px; margin-bottom:16px;}
  .title{font-weight:700; color:var(--gold); margin-bottom:10px; display:flex; align-items:center; gap:10px;}
  .muted{color:var(--muted); font-size:13px;}
  .btn{background:linear-gradient(45deg, var(--gold), var(--gold2)); color:#000; font-weight:700; border:none; border-radius:8px; padding:10px 14px; cursor:pointer; transition:transform .15s ease, box-shadow .15s ease; box-shadow:0 4px 12px rgba(255,215,0,.25);}
  .btn:hover{transform:translateY(-1px); box-shadow:0 6px 14px rgba(255,215,0,.35);}
  .btn-outline{background:transparent; border:1px solid var(--gold); color:var(--gold);}
  .btn-danger{background:#2b0000; border:1px solid #900; color:#f88;}
  .btn-ok{background:#092; border:1px solid #0f6; color:#eaffea;}
  .row{display:flex; gap:12px; flex-wrap:wrap;}
  .col{flex:1 1 240px; min-width:220px;}
  input, select, textarea{
    width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,215,0,.25);
    background:#0f0f0f; color:#fff; outline:none;
  }
  textarea{min-height:120px; resize:vertical;}
  label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px;}
  table{width:100%; border-collapse:collapse; overflow:auto;}
  th, td{border-bottom:1px solid rgba(255,215,0,.15); padding:10px; text-align:left; font-size:14px;}
  th{color:var(--gold);}
  .chip{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid rgba(255,215,0,.35); color:var(--gold);}
  .grid{display:grid; gap:12px;}
  .grid-2{grid-template-columns:repeat(2, minmax(0, 1fr));}
  .grid-3{grid-template-columns:repeat(3, minmax(0, 1fr));}
  .grid-4{grid-template-columns:repeat(4, minmax(0, 1fr));}
  .stat{background:#0f0f0f; border:1px solid rgba(255,215,0,.2); border-radius:10px; padding:14px;}
  .stat .label{color:var(--muted); font-size:12px;}
  .stat .value{color:#fff; font-size:22px; margin-top:6px;}
  .hidden{display:none !important;}
  .danger{color:#ff8b8b}
  .ok{color:#9effb3}
  .notice{background:#141414; border:1px dashed rgba(255,215,0,.35); border-radius:10px; padding:10px; color:var(--muted); font-size:13px;}
  .top-actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  .small{font-size:12px;}
  .card{border:1px solid rgba(255,215,0,.2); background:#0e0e0e; border-radius:10px; padding:12px;}
  .img-preview{width:100%; max-height:140px; object-fit:cover; border-radius:8px; border:1px solid rgba(255,215,0,.25); background:#000;}
  .pill{border:1px solid rgba(255,215,0,.25); padding:4px 10px; border-radius:999px; font-size:12px; color:var(--muted)}
  .divider{height:1px; background:rgba(255,215,0,.2); margin:10px 0;}
  footer{border-top:1px solid rgba(255,215,0,.25); padding:10px 16px; color:var(--muted); text-align:center; background:#111;}
  .navbtn{width:100%; text-align:left; background:transparent; border:1px solid rgba(255,215,0,.25); color:#fff; padding:10px 12px; border-radius:8px; cursor:pointer; margin-bottom:8px;}
  .navbtn.active{border-color:var(--gold); color:var(--gold); background:#151515;}
  .inline{display:inline-flex; gap:8px; align-items:center;}
  .nowrap{white-space:nowrap;}
  .right{margin-left:auto}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
</style>
</head>
<body>
<header>
  <div class="brand"><i class="fa-solid fa-crown"></i> RealityLottery Admin</div>
  <div class="inline">
    <span id="adminState" class="admin-state">Not signed in</span>
    <button id="btnLogout" class="btn btn-outline hidden"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
  </div>
</header>

<div class="wrap">
  <aside>
    <button class="navbtn active" data-tab="tab-login"><i class="fa-solid fa-lock"></i> Admin Sign-in</button>
    <button class="navbtn" data-tab="tab-stats"><i class="fa-solid fa-chart-line"></i> Stats</button>
    <button class="navbtn" data-tab="tab-users"><i class="fa-solid fa-users"></i> Users</button>
    <button class="navbtn" data-tab="tab-withdrawals"><i class="fa-solid fa-wallet"></i> Withdrawals</button>
    <button class="navbtn" data-tab="tab-news"><i class="fa-solid fa-newspaper"></i> News</button>
    <button class="navbtn" data-tab="tab-content"><i class="fa-solid fa-pen-ruler"></i> Site Content</button>
    <div class="divider"></div>
    <div class="small muted">All actions require admin token.</div>
  </aside>

  <main>
    <!-- LOGIN -->
    <section id="tab-login" class="section">
      <div class="title"><i class="fa-solid fa-lock"></i> Admin Sign-in</div>
      <div class="row">
        <div class="col card">
          <label>Admin Username</label>
          <input id="adminUser" placeholder="admin" />
          <label style="margin-top:8px">Admin Password</label>
          <input id="adminPass" type="password" placeholder="Your strong password" />
          <div class="row" style="margin-top:12px">
            <button class="btn" id="btnLoginAdmin"><i class="fa-solid fa-right-to-bracket"></i> Sign in</button>
            <span id="loginMsg" class="muted"></span>
          </div>
          <div class="notice" style="margin-top:12px">
            Default (as per server): <span class="mono">a</span>. Y <span class="mono">ADMIN_USER</span> and <span class="mono">ADMIN_PASS</span>.
          </div>
        </div>
        <div class="col">
          <div class="notice">
            Your token is stored in <span class="mono">localStorage.rl_admin_token</span> and attached as <span class="mono">Authorization: Bearer &lt;token&gt;</span> to all admin API calls on the same origin.
          </div>
        </div>
      </div>
    </section>

    <!-- STATS -->
    <section id="tab-stats" class="section hidden">
      <div class="title"><i class="fa-solid fa-chart-line"></i> Platform Stats</div>
      <div id="statsWrap" class="grid grid-4">
        <!-- cards injected -->
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn" id="btnRefreshStats"><i class="fa-solid fa-rotate"></i> Refresh</button>
        <span class="muted">If endpoint is not ready, you'll see a gentle message instead of an error.</span>
      </div>
    </section>

    <!-- USERS -->
    <section id="tab-users" class="section hidden">
      <div class="title"><i class="fa-solid fa-users"></i> Users Management</div>
      <div class="row top-actions">
        <input id="userSearch" placeholder="Search by username or email..." class="col" />
        <button class="btn" id="btnReloadUsers"><i class="fa-solid fa-rotate"></i> Reload</button>
        <span class="pill">Tip: use the inline actions to set balance, subscription, and task progress.</span>
      </div>
      <div class="row" style="margin-top:12px; overflow:auto">
        <table>
          <thead>
            <tr>
              <th>username</th>
              <th>Email</th>
              <th>Balance</th>
              <th>Subscription</th>
              <th>Task Progress</th>
              <th class="nowrap">Save</th>
            </tr>
          </thead>
          <tbody id="usersTbody">
            <tr><td colspan="6" class="muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- WITHDRAWALS -->
    <section id="tab-withdrawals" class="section hidden">
      <div class="title"><i class="fa-solid fa-wallet"></i> Withdrawals</div>
      <div class="row top-actions">
        <button class="btn" id="btnReloadWithdrawals"><i class="fa-solid fa-rotate"></i> Reload</button>
        <span class="pill">Approve or reject user withdrawal requests.</span>
      </div>
      <div class="row" style="margin-top:12px; overflow:auto">
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Amount</th>
              <th>Wallet Address</th>
              <th>Status</th>
              <th class="nowrap">Actions</th>
            </tr>
          </thead>
          <tbody id="withdrawalsTbody">
            <tr><td colspan="5" class="muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>
      <div class="notice" style="margin-top:10px">
        This expects endpoints <span class="mono">GET /api/admin/withdrawals</span>, <span class="mono">POST /api/admin/withdrawals/:id/approve</span> and <span class="mono">POST /api/admin/withdrawals/:id/reject</span>.
        If not implemented yet, you'll see an informational message instead of an error.
      </div>
    </section>

    <!-- NEWS -->
    <section id="tab-news" class="section hidden">
      <div class="title"><i class="fa-solid fa-newspaper"></i> News Management</div>

      <div class="grid grid-2">
        <div class="card">
          <div class="title" style="font-size:16px"><i class="fa-solid fa-plus"></i> New News Item</div>
          <div class="row">
            <div class="col">
              <label>Title</label>
              <input id="newsTitle" placeholder="Headline…" />
            </div>
            <div class="col">
              <label>Button Text</label>
              <input id="newsBtnText" placeholder="Read more" />
            </div>
          </div>
          <label style="margin-top:8px">Body</label>
          <textarea id="newsBody" placeholder="Short description…"></textarea>
          <div class="row" style="margin-top:8px">
            <div class="col">
              <label>Image URL</label>
              <input id="newsImage" placeholder="https://…" />
            </div>
            <div class="col">
              <label>Button Link URL</label>
              <input id="newsBtnLink" placeholder="https://…" />
            </div>
          </div>
          <div class="row" style="margin-top:10px; align-items:flex-start">
            <div class="col"><img id="newsPreview" class="img-preview" alt="Preview" /></div>
            <div class="col">
              <button class="btn" id="btnCreateNews"><i class="fa-solid fa-floppy-disk"></i> Create</button>
              <div class="small muted" id="newsCreateMsg" style="margin-top:6px;"></div>
            </div>
          </div>
          <div class="notice" style="margin-top:12px">
            Image uploads are via URL for now. If you later add file uploads on the server, you can wire it here easily.
          </div>
        </div>

        <div class="card">
          <div class="title" style="font-size:16px"><i class="fa-solid fa-list"></i> Existing News</div>
          <div id="newsList" class="grid" style="grid-template-columns:1fr; gap:10px;">
            <div class="muted">Loading…</div>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="btnReloadNews"><i class="fa-solid fa-rotate"></i> Reload</button>
          </div>
          <div class="small muted" style="margin-top:8px">
            Endpoints expected: <span class="mono">GET/POST /api/admin/news</span>, <span class="mono">PUT/DELETE /api/admin/news/:id</span>.
          </div>
        </div>
      </div>
    </section>

    <!-- CONTENT -->
    <section id="tab-content" class="section hidden">
      <div class="title"><i class="fa-solid fa-pen-ruler"></i> Site Content Controls</div>
      <div class="grid grid-2">
        <div class="card">
          <div class="title" style="font-size:16px"><i class="fa-solid fa-bullhorn"></i> News Ticker</div>
          <label>Ticker Text</label>
          <textarea id="tickerText" placeholder="Set the scrolling ticker text shown on the homepage…"></textarea>
          <div class="row" style="margin-top:8px">
            <button class="btn" id="btnSaveTicker"><i class="fa-solid fa-floppy-disk"></i> Save</button>
            <span id="tickerMsg" class="muted"></span>
          </div>
        </div>
        <div class="card">
          <div class="title" style="font-size:16px"><i class="fa-solid fa-image"></i> Homepage Slides</div>
          <div class="row">
            <div class="col">
              <label>Slide 1 Image URL</label>
              <input id="slide1Url" placeholder="https://…" />
              <label style="margin-top:6px">Slide 1 Title</label>
              <input id="slide1Title" placeholder="…" />
            </div>
            <div class="col">
              <label>Slide 2 Image URL</label>
              <input id="slide2Url" placeholder="https://…" />
              <label style="margin-top:6px">Slide 2 Title</label>
              <input id="slide2Title" placeholder="…" />
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <button class="btn" id="btnSaveSlides"><i class="fa-solid fa-floppy-disk"></i> Save</button>
            <span id="slidesMsg" class="muted"></span>
          </div>
          <div class="small muted" style="margin-top:8px">
            Endpoint expected: <span class="mono">GET/PUT /api/admin/content</span> (and public <span class="mono">GET /api/content</span> for the homepage).
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<footer>
  <div>© <span id="year"></span> RealityLottery — Admin. All rights reserved.</div>
</footer>

<script>
  // ========= CONFIG =========
  const API_BASE = ''; // same domain
  const LS_TOKEN = 'rl_admin_token';

  const $ = (q)=>document.querySelector(q);
  const $$ = (q)=>Array.from(document.querySelectorAll(q));
  const year = new Date().getFullYear(); $('#year').textContent = year;

  // ========= NAV =========
  $$('.navbtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      $$('.navbtn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      $$('main .section').forEach(s=>s.classList.add('hidden'));
      document.getElementById(tab).classList.remove('hidden');
    });
  });

  // ========= AUTH =========
  const adminState = $('#adminState');
  const btnLogout = $('#btnLogout');

  function getToken(){ return localStorage.getItem(LS_TOKEN) || ''; }
  function setToken(t){
    if (t) localStorage.setItem(LS_TOKEN, t);
    updateAuthUI();
  }
  function clearToken(){
    localStorage.removeItem(LS_TOKEN);
    updateAuthUI();
  }
  function isSigned(){ return !!getToken(); }

  function updateAuthUI(){
    if (isSigned()){
      adminState.innerHTML = '<span class="ok">Signed in</span> — token stored';
      btnLogout.classList.remove('hidden');
    } else {
      adminState.innerHTML = 'Not signed in';
      btnLogout.classList.add('hidden');
    }
  }
  btnLogout.addEventListener('click', ()=>{ clearToken(); info('Signed out.'); });

  // ========= HELPERS =========
  function authHeaders(json=true){
    const h = { 'Authorization':'Bearer ' + getToken() };
    if (json) h['Content-Type'] = 'application/json';
    return h;
  }
  function info(msg){ console.log(msg); }
  function humanErr(e){
    if (e && e.message) return e.message;
    return 'Endpoint not available yet';
  }
  async function safeFetch(url, opts={}){
    try{
      const res = await fetch(url, opts);
      const ct = res.headers.get('content-type') || '';
      const data = ct.includes('application/json') ? await res.json() : await res.text();
      if (!res.ok){
        throw new Error((data && data.message) ? data.message : ('HTTP ' + res.status));
      }
      return data;
    }catch(e){
      console.warn('Fetch error', url, e);
      return { _error: true, message: humanErr(e) };
    }
  }
  function el(tag, attrs={}, children=[]){
    const n = document.createElement(tag);
    Object.entries(attrs||{}).forEach(([k,v])=>{
      if (k==='class') n.className = v;
      else if (k==='html') n.innerHTML = v;
      else n.setAttribute(k,v);
    });
    (children||[]).forEach(c=>{
      if (typeof c==='string') n.appendChild(document.createTextNode(c));
      else if (c) n.appendChild(c);
    });
    return n;
  }

  // ========= LOGIN =========
  $('#btnLoginAdmin').addEventListener('click', async ()=>{
    const username = $('#adminUser').value.trim();
    const password = $('#adminPass').value.trim();
    $('#loginMsg').textContent = 'Signing in…';
    const r = await safeFetch(API_BASE + '/api/admin/login', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ username, password })
    });
    if (r._error){
      $('#loginMsg').innerHTML = '<span class="danger">'+ r.message +'</span>';
    } else {
      setToken(r.token);
      $('#loginMsg').innerHTML = '<span class="ok">Success</span>';
    }
  });

  // ========= STATS =========
  async function loadStats(){
    const wrap = $('#statsWrap');
    wrap.innerHTML = '';
    const r = await safeFetch(API_BASE + '/api/admin/stats', { headers: authHeaders(false) });
    if (r._error){
      wrap.appendChild(el('div', {class:'notice'}, [r.message]));
      return;
    }
    const items = [
      { label:'Total Users', value: r.totalUsers },
      { label:'Paid Users', value: r.paidUsers },
      { label:'Wheel Spins', value: r.spins },
      { label:'Successful Invites', value: r.successfulInvites },
      { label:'Total Withdrawals', value: r.totalWithdrawals },
      { label:'Pending Withdrawals', value: r.pendingWithdrawals },
    ];
    items.forEach(it=>{
      const card = el('div', {class:'stat'}, [
        el('div', {class:'label'}, [it.label]),
        el('div', {class:'value'}, [String(it.value ?? 0)])
      ]);
      wrap.appendChild(card);
    });
  }
  $('#btnRefreshStats').addEventListener('click', loadStats);

  // ========= USERS =========
  async function loadUsers(){
    const tb = $('#usersTbody');
    tb.innerHTML = '<tr><td colspan="6" class="muted">Loading…</td></tr>';
    const r = await safeFetch(API_BASE + '/api/admin/users', { headers: authHeaders(false) });
    if (r._error){
      tb.innerHTML = '<tr><td colspan="6"><div class="notice">'+ r.message +'</div></td></tr>';
      return;
    }
    const users = (r.users || []);
    if (!users.length){
      tb.innerHTML = '<tr><td colspan="6" class="muted">No users yet.</td></tr>';
      return;
    }
    const q = $('#userSearch').value.trim().toLowerCase();
    const filtered = q ? users.filter(u=>{
      const x = (u.username||'') + ' ' + (u.email||'');
      return x.toLowerCase().includes(q);
    }) : users;

    tb.innerHTML = '';
    filtered.forEach(u=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <div><strong>${u.username||'-'}</strong></div>
          <div class="small muted mono">${u._id||''}</div>
        </td>
        <td>${u.email||'-'}</td>
        <td>
          <input data-field="balance" data-id="${u._id}" value="${Number(u.balance||0)}" />
        </td>
        <td>
          <select data-field="subscriptionType" data-id="${u._id}">
            <option value="">None</option>
            <option value="Basic"${u.subscriptionType==='Basic'?' selected':''}>Basic</option>
            <option value="Pro"${u.subscriptionType==='Pro'?' selected':''}>Pro</option>
            <option value="VIP"${u.subscriptionType==='VIP'?' selected':''}>VIP</option>
          </select>
        </td>
        <td>
          <select data-field="taskProgress" data-id="${u._id}">
            ${[0,1,2,3,4,5,6].map(n=>`<option value="${n}"${Number(u.taskProgress||0)===n?' selected':''}>${n}/6</option>`).join('')}
          </select>
        </td>
        <td class="nowrap">
          <button class="btn small" data-action="save" data-id="${u._id}"><i class="fa-solid fa-floppy-disk"></i> Save</button>
        </td>
      `;
      tb.appendChild(tr);
    });

    tb.querySelectorAll('button[data-action="save"]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const id = btn.dataset.id;
        const balance = Number(tb.querySelector(`input[data-field="balance"][data-id="${id}"]`).value || 0);
        const subscriptionType = tb.querySelector(`select[data-field="subscriptionType"][data-id="${id}"]`).value;
        const taskProgress = Number(tb.querySelector(`select[data-field="taskProgress"][data-id="${id}"]`).value || 0);

        btn.disabled = true; btn.textContent = 'Saving…';
        const r = await safeFetch(API_BASE + '/api/admin/users/' + id, {
          method: 'PUT',
          headers: authHeaders(true),
          body: JSON.stringify({ balance, subscriptionType, taskProgress })
        });
        btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Save';
        if (r._error){
          alert('Update failed: ' + r.message);
        } else {
          alert('Saved!');
        }
      });
    });
  }
  $('#btnReloadUsers').addEventListener('click', loadUsers);
  $('#userSearch').addEventListener('input', loadUsers);

  
  
  // ========= WITHDRAWALS =========
  async function loadWithdrawals(){
    const tb = $('#withdrawalsTbody');
    tb.innerHTML = '<tr><td colspan="5" class="muted">Loading…</td></tr>';
    const r = await safeFetch(API_BASE + '/api/admin/withdrawals', { headers: authHeaders(false) });
    if (r._error){
      tb.innerHTML = '<tr><td colspan="5"><div class="notice">'+ r.message +'</div></td></tr>';
      return;
    }
    const rows = r.withdrawals || [];
    if (!rows.length){
      tb.innerHTML = '<tr><td colspan="5" class="muted">No withdrawal requests.</td></tr>';
      return;
    }
    tb.innerHTML = '';
    rows.forEach(w=>{
      const tr = document.createElement('tr');
tr.innerHTML = `
  <td><strong>${w.userId?.username || '-'}</strong></td>
<td>${Number(w.amount || 0)}</td>
<td class="mono">${w.walletAddress || '-'}</td>
<td>${getStatusChip(w.status)}</td>
  <td class="nowrap">
    <button class="btn-ok small" data-approve="${w._id}">
      <i class="fa-solid fa-check"></i> Approve
    </button>
    <button class="btn-danger small" data-reject="${w._id}">
      <i class="fa-solid fa-xmark"></i> Reject
    </button>
  </td>
`;
tb.appendChild(tr);
    });

    tb.querySelectorAll('button[data-approve]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id = b.dataset.approve;
        b.disabled = true; b.textContent = 'Approving…';
        const r = await safeFetch(API_BASE + '/api/admin/withdrawals/'+id+'/approve', {
          method:'POST', headers: authHeaders(false)
        });
        b.disabled = false; b.innerHTML = '<i class="fa-solid fa-check"></i> Approve';
        if (r._error) alert('Approve failed: ' + r.message);
        else { alert('Approved'); loadWithdrawals(); }
      });
    });
    tb.querySelectorAll('button[data-reject]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id = b.dataset.reject;
        b.disabled = true; b.textContent = 'Rejecting…';
        const r = await safeFetch(API_BASE + '/api/admin/withdrawals/'+id+'/reject', {
          method:'POST', headers: authHeaders(false)
        });
        b.disabled = false; b.innerHTML = '<i class="fa-solid fa-xmark"></i> Reject';
        if (r._error) alert('Reject failed: ' + r.message);
        else { alert('Rejected'); loadWithdrawals(); }
      });
    });
  }
  $('#btnReloadWithdrawals').addEventListener('click', loadWithdrawals);

  // ========= NEWS =========
  function updateNewsPreview(){
    const url = $('#newsImage').value.trim();
    $('#newsPreview').src = url || '';
  }
  $('#newsImage').addEventListener('input', updateNewsPreview);
  updateNewsPreview();

  async function loadNewsList(){
    const list = $('#newsList');
    list.innerHTML = '<div class="muted">Loading…</div>';
    const r = await safeFetch(API_BASE + '/api/admin/news', { headers: authHeaders(false) });
    if (r._error){
      list.innerHTML = '';
      list.appendChild(el('div',{class:'notice'},[r.message]));
      return;
    }
    const items = r.news || [];
    if (!items.length){
      list.innerHTML = '<div class="muted">No news yet.</div>';
      return;
    }
    list.innerHTML = '';
    items.forEach(n=>{
      const card = el('div', {class:'card'}, [
        el('div', {class:'row'}, [
          el('div', {class:'col'}, [
            el('div', {class:'title', style:'font-size:15px'}, [n.title || '(no title)']),
            el('div', {class:'muted small'}, [n._id || '']),
            el('div', {style:'margin-top:6px'}, [n.body || ''])
          ]),
          el('div', {class:'col'}, [
            n.imageUrl ? el('img', {src:n.imageUrl, class:'img-preview'}) : el('div', {class:'muted small'}, ['No image']),
            el('div', {class:'small muted', style:'margin-top:6px'}, ['Button: ', (n.buttonText||'-'), ' → ', (n.buttonLink||'-')])
          ])
        ]),
        el('div', {class:'row', style:'margin-top:8px'}, [
          el('button', {class:'btn small', 'data-edit': n._id}, [el('i',{class:'fa-solid fa-pen'}), document.createTextNode(' Edit')]),
          el('button', {class:'btn-danger small', 'data-del': n._id}, [el('i',{class:'fa-solid fa-trash'}), document.createTextNode(' Delete')])
        ])
      ]);
      list.appendChild(card);
    });

    list.querySelectorAll('button[data-del]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        if (!confirm('Delete this news item?')) return;
        const id = b.getAttribute('data-del');
        b.disabled = true; b.textContent = 'Deleting…';
        const r = await safeFetch(API_BASE + '/api/admin/news/'+id, {
          method:'DELETE', headers: authHeaders(false)
        });
        if (r._error) alert('Delete failed: ' + r.message);
        loadNewsList();
      });
    });

    list.querySelectorAll('button[data-edit]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id = b.getAttribute('data-edit');
        const title = prompt('Title?'); if (title===null) return;
        const body = prompt('Body?'); if (body===null) return;
        const imageUrl = prompt('Image URL? (optional)', '') ?? '';
        const buttonText = prompt('Button text?', 'Read more') ?? '';
        const buttonLink = prompt('Button link URL?', 'https://') ?? '';
        b.disabled = true; b.textContent = 'Saving…';
        const r = await safeFetch(API_BASE + '/api/admin/news/'+id, {
          method:'PUT', headers: authHeaders(true),
          body: JSON.stringify({ title, body, imageUrl, buttonText, buttonLink })
        });
        if (r._error) alert('Update failed: ' + r.message);
        b.disabled = false; b.innerHTML = '<i class="fa-solid fa-pen"></i> Edit';
        loadNewsList();
      });
    });
  }
  $('#btnCreateNews').addEventListener('click', async ()=>{
    const title = $('#newsTitle').value.trim();
    const body = $('#newsBody').value.trim();
    const imageUrl = $('#newsImage').value.trim();
    const buttonText = $('#newsBtnText').value.trim();
    const buttonLink = $('#newsBtnLink').value.trim();
    $('#newsCreateMsg').textContent = 'Creating…';
    const r = await safeFetch(API_BASE + '/api/admin/news', {
      method:'POST', headers: authHeaders(true),
      body: JSON.stringify({ title, body, imageUrl, buttonText, buttonLink })
    });
    if (r._error) $('#newsCreateMsg').innerHTML = '<span class="danger">'+ r.message +'</span>';
    else {
      $('#newsCreateMsg').innerHTML = '<span class="ok">Created</span>';
      $('#newsTitle').value = ''; $('#newsBody').value=''; $('#newsImage').value=''; $('#newsBtnText').value=''; $('#newsBtnLink').value='';
      updateNewsPreview();
      loadNewsList();
    }
  });
  $('#btnReloadNews').addEventListener('click', loadNewsList);

  // ========= CONTENT =========
  async function loadContentAdmin(){
    const r = await safeFetch(API_BASE + '/api/admin/content', { headers: authHeaders(false) });
    if (r._error){
      $('#tickerMsg').textContent = r.message;
      $('#slidesMsg').textContent = r.message;
      return;
    }
    $('#tickerText').value = r.tickerText || '';
    $('#slide1Url').value = r.slide1Url || '';
    $('#slide1Title').value = r.slide1Title || '';
    $('#slide2Url').value = r.slide2Url || '';
    $('#slide2Title').value = r.slide2Title || '';
  }
  $('#btnSaveTicker').addEventListener('click', async ()=>{
    const r = await safeFetch(API_BASE + '/api/admin/content', {
      method:'PUT', headers: authHeaders(true),
      body: JSON.stringify({ tickerText: $('#tickerText').value })
    });
    $('#tickerMsg').textContent = r._error ? r.message : 'Saved';
  });
  $('#btnSaveSlides').addEventListener('click', async ()=>{
    const payload = {
      slide1Url: $('#slide1Url').value.trim(),
      slide1Title: $('#slide1Title').value.trim(),
      slide2Url: $('#slide2Url').value.trim(),
      slide2Title: $('#slide2Title').value.trim(),
    };
    const r = await safeFetch(API_BASE + '/api/admin/content', {
      method:'PUT', headers: authHeaders(true),
      body: JSON.stringify(payload)
    });
    $('#slidesMsg').textContent = r._error ? r.message : 'Saved';
  });

  // ========= INIT =========
  updateAuthUI();

  // Auto-load after login if token exists
  if (isSigned()){
    loadStats();
    loadUsers();
    loadWithdrawals();
    loadNewsList();
    loadContentAdmin();
  }

  // If the admin navigates into tabs while not signed, we keep UI friendly
  document.addEventListener('click', (e)=>{
    const tab = e.target.closest('.navbtn')?.dataset?.tab || '';
    const needAuthTabs = ['tab-stats','tab-users','tab-withdrawals','tab-news','tab-content'];
    if (tab && needAuthTabs.includes(tab) && !isSigned()){
      setTimeout(()=>{ alert('Please sign in as admin first.'); }, 0);
    }
  });
</script>
</body>
</html>
