<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>RealityLottery ‚Äî Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
/>
<style>
  :root{
    --bg:#000; --panel:#0f0f0f; --muted:#b9b9b9; --gold:#ffd700; --gold2:#ffa500; --red:#ff5252; --green:#23d18b; --blue:#4f8ff7;
  }
  *{box-sizing:border-box; font-family: Arial, Helvetica, sans-serif;}
  body{margin:0; background:var(--bg); color:#fff; min-height:100vh; display:flex; flex-direction:column;}
  header{border-bottom:2px solid var(--gold); background:#111; padding:16px 20px; display:flex; align-items:center; justify-content:space-between;}
  .brand{font-weight:800; letter-spacing:1px; color:var(--gold); font-size:20px;}
  .admin-state{font-size:14px; color:var(--muted);}
  .wrap{display:flex; flex:1; min-height:0;}
  aside{width:280px; background:var(--panel); border-right:1px solid rgba(255,215,0,0.25); padding:14px; overflow:auto;}
  main{flex:1; padding:16px; overflow:auto;}
  .section{background:#111; border:1px solid rgba(255,215,0,0.25); border-radius:10px; padding:16px; margin-bottom:16px;}
  .title{font-weight:700; color:var(--gold); margin-bottom:10px; display:flex; align-items:center; gap:10px;}
  .muted{color:var(--muted); font-size:13px;}
  .btn{background:linear-gradient(45deg, var(--gold), var(--gold2)); color:#000; font-weight:700; border:none; border-radius:8px; padding:10px 14px; cursor:pointer; transition:transform .15s ease, box-shadow .15s ease; box-shadow:0 4px 12px rgba(255,215,0,.25);}
  .btn:hover{transform:translateY(-1px); box-shadow:0 6px 14px rgba(255,215,0,.35);}
  .btn-outline{background:transparent; border:1px solid var(--gold); color:var(--gold);}
  .btn-danger{background:#2b0000; border:1px solid #900; color:#f88;}
  .btn-ok{background:#092; border:1px solid #0f6; color:#eaffea;}
  .btn-info{background:#004080; border:1px solid #4f8ff7; color:#e0f0ff;}
  .row{display:flex; gap:12px; flex-wrap:wrap;}
  .col{flex:1 1 240px; min-width:220px;}
  input, select, textarea{
    width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,215,0,.25);
    background:#0f0f0f; color:#fff; outline:none;
  }
  textarea{min-height:120px; resize:vertical;}
  label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px;}
  table{width:100%; border-collapse:collapse; overflow:auto;}
  th, td{border-bottom:1px solid rgba(255,215,0,.15); padding:10px; text-align:left; font-size:14px;}
  th{color:var(--gold);}
  .chip{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid rgba(255,215,0,.35); color:var(--gold);}
  .grid{display:grid; gap:12px;}
  .grid-2{grid-template-columns:repeat(2, minmax(0, 1fr));}
  .grid-3{grid-template-columns:repeat(3, minmax(0, 1fr));}
  .grid-4{grid-template-columns:repeat(4, minmax(0, 1fr));}
  .stat{background:#0f0f0f; border:1px solid rgba(255,215,0,.2); border-radius:10px; padding:14px;}
  .stat .label{color:var(--muted); font-size:12px;}
  .stat .value{color:#fff; font-size:22px; margin-top:6px;}
  .hidden{display:none !important;}
  .danger{color:#ff8b8b}
  .ok{color:#9effb3}
  .info{color:#4f8ff7}
  .notice{background:#141414; border:1px dashed rgba(255,215,0,.35); border-radius:10px; padding:10px; color:var(--muted); font-size:13px;}
  .top-actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  .small{font-size:12px;}
  .card{border:1px solid rgba(255,215,0,.2); background:#0e0e0e; border-radius:10px; padding:12px;}
  .img-preview{width:100%; max-height:140px; object-fit:cover; border-radius:8px; border:1px solid rgba(255,215,0,.25); background:#000;}
  .pill{border:1px solid rgba(255,215,0,.25); padding:4px 10px; border-radius:999px; font-size:12px; color:var(--muted)}
  .divider{height:1px; background:rgba(255,215,0,.2); margin:10px 0;}
  footer{border-top:1px solid rgba(255,215,0,.25); padding:10px 16px; color:var(--muted); text-align:center; background:#111;}
  .navbtn{width:100%; text-align:left; background:transparent; border:1px solid rgba(255,215,0,.25); color:#fff; padding:10px 12px; border-radius:8px; cursor:pointer; margin-bottom:8px;}
  .navbtn.active{border-color:var(--gold); color:var(--gold); background:#151515;}
  .inline{display:inline-flex; gap:8px; align-items:center;}
  .nowrap{white-space:nowrap;}
  .right{margin-left:auto}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  .filter-bar{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:12px;}
  .filter-select{background:#0f0f0f; border:1px solid rgba(255,215,0,.25); color:#fff; padding:6px 10px; border-radius:6px;}
</style>
</head>
<body>
<header>
  <div class="brand"><i class="fa-solid fa-crown"></i> RealityLottery Admin</div>
  <div class="inline">
    <span id="adminState" class="admin-state">Not signed in</span>
    <button id="btnLogout" class="btn btn-outline hidden"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
  </div>
</header>

<div class="wrap">
  <aside>
    <button class="navbtn active" data-tab="tab-login"><i class="fa-solid fa-lock"></i> Admin Sign-in</button>
    <button class="navbtn" data-tab="tab-stats"><i class="fa-solid fa-chart-line"></i> Stats</button>
    <button class="navbtn" data-tab="tab-users"><i class="fa-solid fa-users"></i> Users</button>
    <button class="navbtn" data-tab="tab-payments"><i class="fa-solid fa-credit-card"></i> Payments</button>
    <button class="navbtn" data-tab="tab-withdrawals"><i class="fa-solid fa-wallet"></i> Withdrawals</button>
    <button class="navbtn" data-tab="tab-invites"><i class="fa-solid fa-user-plus"></i> Invites & Subscriptions</button>
    <button class="navbtn" data-tab="tab-news"><i class="fa-solid fa-newspaper"></i> News</button>
    <button class="navbtn" data-tab="tab-banners"><i class="fa-solid fa-image"></i> Banners</button>
    <button class="navbtn" data-tab="tab-tickers"><i class="fa-solid fa-scroll"></i> News Tickers</button>
    <button class="navbtn" data-tab="tab-notifications">
  <i class="fa-solid fa-bell"></i> Notifications</button>
    <div class="divider"></div>
    <div class="small muted">All actions require admin token.</div>
  </aside>

  <main>
    <!-- LOGIN -->
    <section id="tab-login" class="section">
      <div class="title"><i class="fa-solid fa-lock"></i> Admin Sign-in</div>
      <div class="row">
        <div class="col card">
          <label>Admin Username</label>
          <input id="adminUser" placeholder="admin" />
          <label style="margin-top:8px">Admin Password</label>
          <input id="adminPass" type="password" placeholder="Your strong password" />
          <div class="row" style="margin-top:12px">
            <button class="btn" id="btnLoginAdmin"><i class="fa-solid fa-right-to-bracket"></i> Sign in</button>
            <span id="loginMsg" class="muted"></span>
          </div>
          <div class="notice" style="margin-top:12px">
            Default (as per server): <span class="mono">a</span>. Y <span class="mono">ADMIN_USER</span> and <span class="mono">ADMIN_PASS</span>.
          </div>
        </div>
        <div class="col">
          <div class="notice">
            Your token is stored in <span class="mono">localStorage.rl_admin_token</span> and attached as <span class="mono">Authorization: Bearer &lt;token&gt;</span> to all admin API calls on the same origin.
          </div>
        </div>
      </div>
    </section>

    <!-- STATS -->
    <section id="tab-stats" class="section hidden">
      <div class="title"><i class="fa-solid fa-chart-line"></i> Platform Stats</div>
      <div id="statsWrap" class="grid grid-4">
        <!-- cards injected -->
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn" id="btnRefreshStats"><i class="fa-solid fa-rotate"></i> Refresh</button>
        <span class="muted">If endpoint is not ready, you'll see a gentle message instead of an error.</span>
      </div>
       <section class="card" style="margin-top:12px">
  <div class="title"><i class="fa-solid fa-ticket"></i> Lottery</div>
  <div class="muted">
    List of users and their Lottery Entries.
  </div>
  <div id="lotteryList" style="margin-top:10px">
    Loading...
  </div>
    </section>
    
    <section id="tab-notifications" class="section hidden">
  <div class="title"><i class="fa-solid fa-bell"></i> Notification Management</div>
  
  <div class="grid grid-2">
    <div class="card">
      <div class="title" style="font-size:16px"><i class="fa-solid fa-plus"></i> Create New Notification</div>
      
      <label>Notification Title</label>
      <input id="notificationTitle" placeholder="Notification title" />
      
      <label style="margin-top:8px">Notification Message</label>
      <textarea id="notificationMessage" placeholder="Notification message..." rows="3"></textarea>
      
      <div class="row" style="margin-top:8px">
        <div class="col">
          <label>Link (Optional)</label>
          <input id="notificationLink" placeholder="https://..." />
        </div>
        <div class="col">
          <label>Link Text (Optional)</label>
          <input id="notificationLinkText" placeholder="Link text" />
        </div>
      </div>
      
      <div class="row" style="margin-top:8px">
        <div class="col">
          <label>Priority</label>
          <input id="notificationPriority" type="number" value="1" min="1" max="10" />
        </div>
        <div class="col">
          <label>Status</label>
          <select id="notificationStatus">
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>
        </div>
      </div>
      
      <div class="row" style="margin-top:12px">
        <button class="btn" id="btnCreateNotification">
          <i class="fa-solid fa-plus"></i> Create Notification
        </button>
        <span id="notificationCreateMsg" class="muted"></span>
      </div>
    </div>

    <div class="card">
      <div class="title" style="font-size:16px"><i class="fa-solid fa-list"></i> Current Notifications</div>
      <div id="notificationsList" class="grid" style="grid-template-columns:1fr; gap:10px;">
        <div class="muted">Loading notifications...</div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnReloadNotifications">
          <i class="fa-solid fa-rotate"></i> Reload
        </button>
        <button class="btn btn-outline" id="btnClearDismissed">
          <i class="fa-solid fa-trash"></i> Clear Dismissed Records
        </button>
      </div>
    </div>
  </div>
    </section>
    
    <!-- DEBUG -->
<section id="tab-debug" class="section hidden">
  <div class="title"><i class="fa-solid fa-bug"></i> Debug & Testing</div>
  
  <div class="grid grid-2">
    <div class="card">
      <div class="title" style="font-size:16px"><i class="fa-solid fa-database"></i> Database Debug</div>
      
      <label>User ID to Test</label>
      <input id="debugUserId" placeholder="Enter user ID" />
      
      <div class="row" style="margin-top:12px">
        <button class="btn" id="btnDebugUser"><i class="fa-solid fa-magnifying-glass"></i> Check User Data</button>
        <button class="btn btn-outline" id="btnDebugAllUsers"><i class="fa-solid fa-users"></i> Check All Users</button>
      </div>
      
      <div id="debugResult" class="notice" style="margin-top:12px; max-height:200px; overflow:auto;">
        Results will appear here...
      </div>
    </div>
    
    <div class="card">
      <div class="title" style="font-size:16px"><i class="fa-solid fa-wrench"></i> Server Testing</div>
      
      <label>Test Endpoint</label>
      <select id="debugEndpoint">
        <option value="/api/admin/users">GET /api/admin/users</option>
        <option value="/api/admin/users/ID">PUT /api/admin/users/ID</option>
        <option value="/api/debug/fields">Debug User Fields</option>
      </select>
      
      <label style="margin-top:8px">Test Data (JSON)</label>
      <textarea id="debugData" placeholder='{"completedTasks": 5}' style="height:60px;"></textarea>
      
      <div class="row" style="margin-top:12px">
        <button class="btn" id="btnTestEndpoint"><i class="fa-solid fa-play"></i> Test Endpoint</button>
      </div>
      
      <div id="debugEndpointResult" class="notice" style="margin-top:12px; max-height:200px; overflow:auto;">
        Endpoint results will appear here...
      </div>
    </div>
  </div>
</section>
    
    <!-- USERS -->
    <section id="tab-users" class="section hidden">
      <div class="title"><i class="fa-solid fa-users"></i> Users Management</div>
      <div class="row top-actions">
        <input id="userSearch" placeholder="Search by username or email..." class="col" />
        <button class="btn" id="btnReloadUsers"><i class="fa-solid fa-rotate"></i> Reload</button>
        <span class="pill">Tip: use the inline actions to set balance, subscription, and task progress.</span>
      </div>
      <div class="row" style="margin-top:12px; overflow:auto">
        <table>
          <thead>
            <tr>
              <th>username</th>
              <th>Email</th>
              <th>Balance</th>
              <th>Subscription</th>
              <th class="nowrap">Save</th>
            </tr>
          </thead>
          <tbody id="usersTbody">
            <tr><td colspan="6" class="muted">Loading‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- PAYMENTS -->
    <section id="tab-payments" class="section hidden">
      <div class="title"><i class="fa-solid fa-credit-card"></i> Payment Management</div>
      
      <div class="filter-bar">
        <select id="paymentFilter" class="filter-select">
          <option value="all">All Payments</option>
          <option value="pending">Pending</option>
          <option value="verified">Verified</option>
          <option value="rejected">Rejected</option>
        </select>
        <input id="paymentSearch" placeholder="Search by user or transaction ID..." />
        <button class="btn" id="btnReloadPayments"><i class="fa-solid fa-rotate"></i> Reload</button>
      </div>
      
      <div class="row" style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Plan</th>
              <th>Amount</th>
              <th>Transaction ID</th>
              <th>Phone</th>
              <th>Date</th>
              <th>Status</th>
              <th class="nowrap">Actions</th>
            </tr>
          </thead>
          <tbody id="paymentsTbody">
            <tr><td colspan="8" class="muted">Loading‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
      
      <div class="notice" style="margin-top:12px">
        This section allows you to manage user payment verifications. Verify payments to activate user subscriptions.
      </div>
    </section>

    <!-- WITHDRAWALS -->
    <section id="tab-withdrawals" class="section hidden">
      <div class="title"><i class="fa-solid fa-wallet"></i> Withdrawals</div>
      <div class="row top-actions">
        <button class="btn" id="btnReloadWithdrawals"><i class="fa-solid fa-rotate"></i> Reload</button>
        <span class="pill">Approve or reject user withdrawal requests.</span>
      </div>
      <div class="row" style="margin-top:12px; overflow:auto">
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Amount</th>
              <th>Wallet Address</th>
              <th>Status</th>
              <th class="nowrap">Actions</th>
            </tr>
          </thead>
          <tbody id="withdrawalsTbody">
            <tr><td colspan="5" class="muted">Loading‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
      <div class="notice" style="margin-top:10px">
        This expects endpoints <span class="mono">GET /api/admin/withdrawals</span>, <span class="mono">POST /api/admin/withdrawals/:id/approve</span> and <span class="mono">POST /api/admin/withdrawals/:id/reject</span>.
        If not implemented yet, you'll see an informational message instead of an error.
      </div>
    </section>

    <!-- ÿ£ÿ∂ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÇÿ≥ŸÖ ÿ®ÿπÿØ ŸÇÿ≥ŸÖ Withdrawals -->
<section id="tab-invites" class="section hidden">
  <div class="title"><i class="fa-solid fa-user-plus"></i> Invites & Subscriptions</div>
  
  <div class="filter-bar">
    <select id="invitesFilter" class="filter-select">
      <option value="all">All Users</option>
      <option value="withInvites">With Invites</option>
      <option value="withSubscriptions">With Subscriptions</option>
    </select>
    <input id="invitesSearch" placeholder="Search by username..." />
    <button class="btn" id="btnReloadInvites"><i class="fa-solid fa-rotate"></i> Reload</button>
  </div>
  
  <div class="row" style="overflow:auto">
    <table>
      <thead>
        <tr>
          <th>Username</th>
          <th>Email</th>
          <th>Total Invites</th>
          <th>Successful Invites</th>
          <th>Subscription Type</th>
          <th>Subscription Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="invitesTbody">
        <tr><td colspan="7" class="muted">Loading‚Ä¶</td></tr>
      </tbody>
    </table>
  </div>
  
  <div class="notice" style="margin-top:12px">
    This section shows detailed information about user invites and subscriptions.
  </div>
</section>
    
    <!-- NEWS -->
    <section id="tab-news" class="section hidden">
      <div class="title"><i class="fa-solid fa-newspaper"></i> News Management</div>

      <div class="grid grid-2">
        <div class="card">
          <div class="title" style="font-size:16px"><i class="fa-solid fa-plus"></i> New News Item</div>
          <div class="row">
            <div class="col">
              <label>Title</label>
              <input id="newsTitle" placeholder="Headline‚Ä¶" />
            </div>
            <div class="col">
              <label>Button Text</label>
              <input id="newsBtnText" placeholder="Read more" />
            </div>
          </div>
          <label style="margin-top:8px">Body</label>
          <textarea id="newsBody" placeholder="Short description‚Ä¶"></textarea>
          <div class="row" style="margin-top:8px">
            <div class="col">
              <label>Image URL</label>
              <input id="newsImage" placeholder="https://‚Ä¶" />
            </div>
            <div class="col">
              <label>Button Link URL</label>
              <input id="newsBtnLink" placeholder="https://‚Ä¶" />
            </div>
          </div>
          <div class="row" style="margin-top:10px; align-items:flex-start">
            <div class="col"><img id="newsPreview" class="img-preview" alt="Preview" /></div>
            <div class="col">
              <button class="btn" id="btnCreateNews"><i class="fa-solid fa-floppy-disk"></i> Create</button>
              <div class="small muted" id="newsCreateMsg" style="margin-top:6px;"></div>
            </div>
          </div>
          <div class="notice" style="margin-top:12px">
            Image uploads are via URL for now. If you later add file uploads on the server, you can wire it here easily.
          </div>
        </div>

        <div class="card">
          <div class="title" style="font-size:16px"><i class="fa-solid fa-list"></i> Existing News</div>
          <div id="newsList" class="grid" style="grid-template-columns:1fr; gap:10px;">
            <div class="muted">Loading‚Ä¶</div>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="btnReloadNews"><i class="fa-solid fa-rotate"></i> Reload</button>
          </div>
          <div class="small muted" style="margin-top:8px">
            Endpoints expected: <span class="mono">GET/POST /api/admin/news</span>, <span class="mono">PUT/DELETE /api/admin/news/:id</span>.
          </div>
        </div>
      </div>
    </section>

    <!-- BANNERS -->
    <section id="tab-banners" class="section hidden">
      <div class="title"><i class="fa-solid fa-image"></i> Banner Management</div>

      <div class="grid grid-2">
        <div class="card">
          <div class="title" style="font-size:16px"><i class="fa-solid fa-plus"></i> New Banner</div>
          <div class="row">
            <div class="col">
              <label>Title</label>
              <input id="bannerTitle" placeholder="Banner title‚Ä¶" />
            </div>
            <div class="col">
              <label>Button Text</label>
              <input id="bannerBtnText" placeholder="Click here" />
            </div>
          </div>
          <label style="margin-top:8px">Description</label>
          <textarea id="bannerDescription" placeholder="Banner description‚Ä¶"></textarea>
          <div class="row" style="margin-top:8px">
            <div class="col">
              <label>Image URL</label>
              <input id="bannerImage" placeholder="https://‚Ä¶" />
            </div>
            <div class="col">
              <label>Button Link URL</label>
              <input id="bannerBtnLink" placeholder="https://‚Ä¶" />
            </div>
          </div>
          <div class="row" style="margin-top:10px; align-items:flex-start">
            <div class="col"><img id="bannerPreview" class="img-preview" alt="Preview" /></div>
            <div class="col">
              <button class="btn" id="btnCreateBanner"><i class="fa-solid fa-floppy-disk"></i> Create</button>
              <div class="small muted" id="bannerCreateMsg" style="margin-top:6px;"></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="title" style="font-size:16px"><i class="fa-solid fa-list"></i> Existing Banners</div>
          <div id="bannerList" class="grid" style="grid-template-columns:1fr; gap:10px;">
            <div class="muted">Loading‚Ä¶</div>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="btnReloadBanners"><i class="fa-solid fa-rotate"></i> Reload</button>
          </div>
        </div>
      </div>
    </section>
     
    <section id="tab-tickers" class="section hidden">
  <div class="title"><i class="fa-solid fa-scroll"></i> News Tickers Management</div>
  
  <div class="grid grid-2">
    <div class="card">
      <div class="title" style="font-size:16px"><i class="fa-solid fa-plus"></i> Add New Ticker</div>
      
      <label>Ticker Text</label>
      <textarea id="tickerText" placeholder="Enter ticker text..." rows="3"></textarea>
      
      <div class="row" style="margin-top:8px">
        <div class="col">
          <label>Priority</label>
          <input id="tickerPriority" type="number" value="1" min="1" max="10" />
        </div>
        <div class="col">
          <label>Status</label>
          <select id="tickerStatus">
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>
        </div>
      </div>
      
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnCreateTicker"><i class="fa-solid fa-plus"></i> Add Ticker</button>
        <span id="tickerCreateMsg" class="muted"></span>
      </div>
    </div>

    <div class="card">
      <div class="title" style="font-size:16px"><i class="fa-solid fa-list"></i> Current Tickers</div>
      <div id="tickersList" class="grid" style="grid-template-columns:1fr; gap:10px;">
        <div class="muted">Loading tickers...</div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnReloadTickers"><i class="fa-solid fa-rotate"></i> Reload</button>
      </div>
    </div>
  </div>
    </section>
  </main>
</div>

<footer>
  <div>¬© <span id="year"></span> RealityLottery ‚Äî Admin. All rights reserved.</div>
</footer>

<script>
  // ========= CONFIG =========
  const API_BASE = 'https://realitylottery.koyeb.app';
  const LS_TOKEN = 'rl_admin_token';

  const $ = (q)=>document.querySelector(q);
  const $$ = (q)=>Array.from(document.querySelectorAll(q));
  const year = new Date().getFullYear(); $('#year').textContent = year;

  // ========= NAV =========
  $$('.navbtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      $$('.navbtn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      $$('main .section').forEach(s=>s.classList.add('hidden'));
      document.getElementById(tab).classList.remove('hidden');
    });
  });

  // ========= AUTH =========
  const adminState = $('#adminState');
  const btnLogout = $('#btnLogout');

  function getToken(){ return localStorage.getItem(LS_TOKEN) || ''; }
  function setToken(t){
    if (t) localStorage.setItem(LS_TOKEN, t);
    updateAuthUI();
  }
  function clearToken(){
    localStorage.removeItem(LS_TOKEN);
    updateAuthUI();
  }
  function isSigned(){ return !!getToken(); }

  function updateAuthUI(){
    if (isSigned()){
      adminState.innerHTML = '<span class="ok">Signed in</span> ‚Äî token stored';
      btnLogout.classList.remove('hidden');
    } else {
      adminState.innerHTML = 'Not signed in';
      btnLogout.classList.add('hidden');
    }
  }
  btnLogout.addEventListener('click', ()=>{ clearToken(); info('Signed out.'); });

  // ========= HELPERS =========
  function authHeaders(json=true){
    const h = { 'Authorization':'Bearer ' + getToken() };
    if (json) h['Content-Type'] = 'application/json';
    return h;
  }
  function info(msg){ console.log(msg); }
  function humanErr(e){
    if (e && e.message) return e.message;
    return 'Endpoint not available yet';
  }
  async function safeFetch(url, opts={}){
    try{
      const res = await fetch(url, opts);
      const ct = res.headers.get('content-type') || '';
      const data = ct.includes('application/json') ? await res.json() : await res.text();
      if (!res.ok){
        // Handle 403 Forbidden specifically
        if (res.status === 403) {
          return { _error: true, message: 'Access forbidden. Please check your admin privileges or token.' };
        }
        throw new Error((data && data.message) ? data.message : ('HTTP ' + res.status));
      }
      return data;
    }catch(e){
      console.warn('Fetch error', url, e);
      return { _error: true, message: humanErr(e) };
    }
  }
  function el(tag, attrs={}, children=[]){
    const n = document.createElement(tag);
    Object.entries(attrs||{}).forEach(([k,v])=>{
      if (k==='class') n.className = v;
      else if (k==='html') n.innerHTML = v;
      else n.setAttribute(k,v);
    });
    (children||[]).forEach(c=>{
      if (typeof c==='string') n.appendChild(document.createTextNode(c));
      else if (c) n.appendChild(c);
    });
    return n;
  }

  // ========= LOGIN =========
  $('#btnLoginAdmin').addEventListener('click', async ()=>{
    const username = $('#adminUser').value.trim();
    const password = $('#adminPass').value.trim();
    $('#loginMsg').textContent = 'Signing in‚Ä¶';
    const r = await safeFetch(API_BASE + '/api/admin/login', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ username, password })
    });
    if (r._error){
      $('#loginMsg').innerHTML = '<span class="danger">'+ r.message +'</span>';
    } else {
      setToken(r.token);
      $('#loginMsg').innerHTML = '<span class="ok">Success</span>';
      // Auto-load data after successful login
      loadStats();
      loadUsers();
      loadPayments();
      loadWithdrawals();
      loadNewsList();
      loadBannerList();
      loadContentAdmin();
    }
  });

  // ========= DEBUG FUNCTIONS =========
async function debugUserData(userId) {
  const resultDiv = $('#debugResult');
  resultDiv.innerHTML = 'Loading user data...';
  
  try {
    const r = await safeFetch(API_BASE + '/api/admin/users/' + userId, { 
      headers: authHeaders(false) 
    });
    
    if (r._error) {
      resultDiv.innerHTML = `<span class="danger">Error: ${r.message}</span>`;
      return;
    }
    
    const user = r.user || r;
    let debugInfo = `
      <strong>User Data for ${user.username || 'Unknown'}:</strong><br>
      <pre style="font-size:12px; overflow:auto;">${JSON.stringify(user, null, 2)}</pre>
      <br>
      <strong>Field Analysis:</strong><br>
    `;
    
    
    // Check for taskProgress field
    if (user.taskProgress !== undefined) {
      debugInfo += `<span class="info">taskProgress: ${user.taskProgress}</span><br>`;
    } else {
      debugInfo += `<span class="muted">taskProgress: UNDEFINED</span><br>`;
    }
    
    resultDiv.innerHTML = debugInfo;
    
  } catch (error) {
    resultDiv.innerHTML = `<span class="danger">Exception: ${error.message}</span>`;
  }
}

async function debugAllUsers() {
  const resultDiv = $('#debugResult');
  resultDiv.innerHTML = 'Loading all users data...';
  
  try {
    const r = await safeFetch(API_BASE + '/api/admin/users', { 
      headers: authHeaders(false) 
    });
    
    if (r._error) {
      resultDiv.innerHTML = `<span class="danger">Error: ${r.message}</span>`;
      return;
    }
    
    const users = r.users || [];
    let debugInfo = `
      <strong>Users Analysis (${users.length} users):</strong><br>
    `;
    
    let hasTaskProgress = 0;
    
    users.forEach(user => {
      if (user.taskProgress !== undefined) hasTaskProgress++;
    });
    
    debugInfo += `
      <span class="${hasTaskProgress > 0 ? 'info' : 'muted'}">
        Users with taskProgress: ${hasTaskProgress}/${users.length}
      </span><br>
      <br>
      <strong>Sample User Fields:</strong><br>
    `;
    
    // Show first 3 users as sample
    users.slice(0, 3).forEach(user => {
      debugInfo += `
        ${user.username}: 
        completedTasks=${user.completedTasks !== undefined ? user.completedTasks : 'UNDEFINED'}, 
        taskProgress=${user.taskProgress !== undefined ? user.taskProgress : 'UNDEFINED'}<br>
      `;
    });
    
    resultDiv.innerHTML = debugInfo;
    
  } catch (error) {
    resultDiv.innerHTML = `<span class="danger">Exception: ${error.message}</span>`;
  }
}

async function loadLotteryList() {
  const listEl = document.getElementById('lotteryList');
  try {
    const users = await safeFetch(API_BASE + '/api/admin/users', {
      headers: { 'Authorization': 'Bearer ' + getToken() }
    });

    if (!users || users.length === 0) {
      listEl.textContent = "No users found.";
      return;
    }

    const table = document.createElement('table');
    table.style.width = "100%";
    table.style.borderCollapse = "collapse";
    table.innerHTML = `
      <thead>
        <tr>
          <th style="text-align:left; padding:6px; border-bottom:1px solid rgba(255,215,0,.25)">Username</th>
          <th style="text-align:right; padding:6px; border-bottom:1px solid rgba(255,215,0,.25)">Lottery Entries</th>
        </tr>
      </thead>
      <tbody>
        ${users.map(u => `
          <tr>
            <td style="padding:6px; border-bottom:1px solid rgba(255,215,0,.1)">${u.username}</td>
            <td style="padding:6px; text-align:right; border-bottom:1px solid rgba(255,215,0,.1)">${u.lotteryEntries || 0}</td>
          </tr>
        `).join('')}
      </tbody>
    `;
    listEl.innerHTML = "";
    listEl.appendChild(table);

  } catch(err) {
    console.error(err);
    listEl.textContent = "Failed to load data.";
  }
} // <-- ŸáŸÜÿß Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÜÿ™ŸáŸä ÿßŸÑÿØÿßŸÑÿ© ŸÅŸÇÿ∑



async function testEndpoint() {
  const endpoint = $('#debugEndpoint').value;
  const data = $('#debugData').value;
  const resultDiv = $('#debugEndpointResult');
  resultDiv.innerHTML = 'Testing endpoint...';
  
  try {
    let url = API_BASE + endpoint;
    let options = { headers: authHeaders(true) };
    
    // Replace ID placeholder if needed
    if (endpoint.includes('ID')) {
      const userId = $('#debugUserId').value.trim();
      if (!userId) {
        resultDiv.innerHTML = '<span class="danger">Please enter a User ID first</span>';
        return;
      }
      url = url.replace('ID', userId);
    }
    
    if (data && data.trim() !== '') {
      options.method = 'POST';
      options.body = data;
    } else if (endpoint.startsWith('PUT')) {
      options.method = 'PUT';
      options.body = JSON.stringify({ completedTasks: 5 }); // Default test
    }
    
    const r = await safeFetch(url, options);
    
    let resultHtml = `
      <strong>Endpoint:</strong> ${url}<br>
      <strong>Method:</strong> ${options.method || 'GET'}<br>
      <strong>Status:</strong> ${r._error ? '<span class="danger">ERROR</span>' : '<span class="ok">SUCCESS</span>'}<br>
      <br>
      <strong>Response:</strong><br>
      <pre style="font-size:12px; overflow:auto;">${JSON.stringify(r, null, 2)}</pre>
    `;
    
    resultDiv.innerHTML = resultHtml;
    
  } catch (error) {
    resultDiv.innerHTML = `<span class="danger">Exception: ${error.message}</span>`;
  }
}

// ========= EVENT LISTENERS FOR DEBUG =========
$('#btnDebugUser').addEventListener('click', () => {
  const userId = $('#debugUserId').value.trim();
  if (!userId) {
    $('#debugResult').innerHTML = '<span class="danger">Please enter a User ID</span>';
    return;
  }
  debugUserData(userId);
});

$('#btnDebugAllUsers').addEventListener('click', debugAllUsers);
$('#btnTestEndpoint').addEventListener('click', testEndpoint);

// ========= ENHANCED USER LOADING WITH DEBUG INFO =========
async function loadUsersWithDebug(){
  const tb = $('#usersTbody');
  tb.innerHTML = '<tr><td colspan="7" class="muted">Loading‚Ä¶</td></tr>';
  
  try {
    const r = await safeFetch(API_BASE + '/api/admin/users', { 
      headers: authHeaders(false) 
    });
    
    if (r._error){
      tb.innerHTML = '<tr><td colspan="7"><div class="notice">'+ r.message +'</div></td></tr>';
      return;
    }
    
    const users = (r.users || []);
    if (!users.length){
      tb.innerHTML = '<tr><td colspan="7" class="muted">No users yet.</td></tr>';
      return;
    }
    
    // Debug: log what fields we're receiving
    console.log('Users API Response:', users[0]);
    
    const q = $('#userSearch').value.trim().toLowerCase();
    const filtered = q ? users.filter(u => {
      const searchText = (u.username || '') + ' ' + (u.email || '') + ' ' + (u.fullName || '');
      return searchText.toLowerCase().includes(q);
    }) : users;

    tb.innerHTML = '';
    
    filtered.forEach(u => {
       const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <div><strong>${u.username || '-'}</strong></div>
          <div class="small muted mono">${u._id || ''}</div>
        </td>
        <td>${u.email || '-'}</td>
        <td>
          <input type="number" data-field="balance" data-id="${u._id}" value="${Number(u.balance || 0)}" />
        </td>
        <td>
          <select data-field="subscriptionType" data-id="${u._id}">
            <option value="">None</option>
            <option value="BASIC" ${u.subscriptionType === 'BASIC' ? 'selected' : ''}>BASIC</option>
            <option value="PRO" ${u.subscriptionType === 'PRO' ? 'selected' : ''}>PRO</option>
            <option value="VIP" ${u.subscriptionType === 'VIP' ? 'selected' : ''}>VIP</option>
          </select>
        </td>
        <td>
          <div class="muted small">Invites: ${u.successfulInvites || 0}/${u.totalInvites || 0}</div>
          <div class="muted small">Sub: ${u.subscriptionType || 'None'}</div>
        </td>
        <td class="nowrap">
          <button class="btn small" data-action="save" data-id="${u._id}">
            <i class="fa-solid fa-floppy-disk"></i> Save
          </button>
        </td>
      `;
      tb.appendChild(tr);
    });

    // ÿ•ÿ∂ÿßŸÅÿ© event listeners ŸÑÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ≠ŸÅÿ∏
    tb.querySelectorAll('button[data-action="save"]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        const balance = Number(tb.querySelector(`input[data-field="balance"][data-id="${id}"]`).value || 0);
        const subscriptionType = tb.querySelector(`select[data-field="subscriptionType"][data-id="${id}"]`).value;

        btn.disabled = true; 
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving‚Ä¶';
        
        try {
          console.log('Sending update:', { balance, subscriptionType });
          
          const r = await safeFetch(API_BASE + '/api/admin/users/' + id, {
            method: 'PUT',
            headers: authHeaders(true),
            body: JSON.stringify({ balance, subscriptionType })
          });
          
          console.log('Update response:', r);
          
          if (r._error) {
            alert('Update failed: ' + r.message);
          } else {
            alert('Saved successfully!');
            loadUsersWithDebug(); // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
          }
        } catch (error) {
          console.error('Update error:', error);
          alert('Error: ' + error.message);
        } finally {
          btn.disabled = false; 
          btn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Save';
        }
      });
    });
    
  } catch (error) {
    console.error('Error loading users:', error);
    tb.innerHTML = '<tr><td colspan="7"><div class="notice">Error loading users: ' + error.message + '</div></td></tr>';
      }
}

// ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ÿØÿßŸÑÿ© loadUsers ÿßŸÑÿ£ÿµŸÑŸäÿ© ÿ®ÿßŸÑÿØÿßŸÑÿ© ÿßŸÑŸÖÿ≠ÿ≥ŸÜÿ©
$('#btnReloadUsers').addEventListener('click', loadUsersWithDebug);
$('#userSearch').addEventListener('input', loadUsersWithDebug);

  
  // ========= STATS =========
  async function loadStats(){
    const wrap = $('#statsWrap');
    wrap.innerHTML = '';
    const r = await safeFetch(API_BASE + '/api/admin/stats', { headers: authHeaders(false) });
    if (r._error){
      wrap.appendChild(el('div', {class:'notice'}, [r.message]));
      return;
    }
    const items = [
      { label:'Total Users', value: r.totalUsers },
      { label:'Paid Users', value: r.paidUsers },
      { label:'Wheel Spins', value: r.spins },
      { label:'Successful Invites', value: r.successfulInvites },
      { label:'Total Withdrawals', value: r.totalWithdrawals },
      { label:'Pending Withdrawals', value: r.pendingWithdrawals },
      { label:'Total Payments', value: r.totalPayments || 0 },
      { label:'Pending Payments', value: r.pendingPayments || 0 },
    ];
    items.forEach(it=>{
      const card = el('div', {class:'stat'}, [
        el('div', {class:'label'}, [it.label]),
        el('div', {class:'value'}, [String(it.value ?? 0)])
      ]);
      wrap.appendChild(card);
    });
  }
  $('#btnRefreshStats').addEventListener('click', loadStats);

 // ========= USERS =========
async function loadUsers(){
  const tb = $('#usersTbody');
  tb.innerHTML = '<tr><td colspan="7" class="muted">Loading‚Ä¶</td></tr>';
  const r = await safeFetch(API_BASE + '/api/admin/users', { headers: authHeaders(false) });
  
  if (r._error){
    tb.innerHTML = '<tr><td colspan="7"><div class="notice">'+ r.message +'</div></td></tr>';
    return;
  }
  
  const users = (r.users || []);
  if (!users.length){
    tb.innerHTML = '<tr><td colspan="7" class="muted">No users yet.</td></tr>';
    return;
  }
  
  const q = $('#userSearch').value.trim().toLowerCase();
  const filtered = q ? users.filter(u => {
    const searchText = (u.username || '') + ' ' + (u.email || '') + ' ' + (u.fullName || '');
    return searchText.toLowerCase().includes(q);
  }) : users;

  tb.innerHTML = '';
  
  filtered.forEach(u => {
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <div><strong>${u.username || '-'}</strong></div>
        <div class="small muted mono">${u._id || ''}</div>
      </td>
      <td>${u.email || '-'}</td>
      <td>
        <input type="number" data-field="balance" data-id="${u._id}" value="${Number(u.balance || 0)}" />
      </td>
      <td>
        <select data-field="subscriptionType" data-id="${u._id}">
          <option value="">None</option>
          <option value="BASIC" ${u.subscriptionType === 'BASIC' ? 'selected' : ''}>BASIC</option>
          <option value="PRO" ${u.subscriptionType === 'PRO' ? 'selected' : ''}>PRO</option>
          <option value="VIP" ${u.subscriptionType === 'VIP' ? 'selected' : ''}>VIP</option>
        </select>
      </td>
      <td>
        <div class="muted small">Invites: ${u.successfulInvites || 0}/${u.totalInvites || 0}</div>
        <div class="muted small">Sub: ${u.subscriptionType || 'None'}</div>
      </td>
      <td class="nowrap">
        <button class="btn small" data-action="save" data-id="${u._id}">
          <i class="fa-solid fa-floppy-disk"></i> Save
        </button>
      </td>
    `;
    tb.appendChild(tr);
  });

  // ÿ•ÿ∂ÿßŸÅÿ© event listeners ŸÑÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ≠ŸÅÿ∏
  tb.querySelectorAll('button[data-action="save"]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.dataset.id;
      const balance = Number(tb.querySelector(`input[data-field="balance"][data-id="${id}"]`).value || 0);
      const subscriptionType = tb.querySelector(`select[data-field="subscriptionType"][data-id="${id}"]`).value;
      

      btn.disabled = true; 
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving‚Ä¶';
      
      try {
        const r = await safeFetch(API_BASE + '/api/admin/users/' + id, {
          method: 'PUT',
          headers: authHeaders(true),
          body: JSON.stringify({ balance, subscriptionType })
        });
        
        if (r._error) {
          alert('Update failed: ' + r.message);
        } else {
          alert('Saved successfully!');
        }
      } catch (error) {
        alert('Error: ' + error.message);
      } finally {
        btn.disabled = false; 
        btn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Save';
      }
    });
  });
}

$('#btnReloadUsers').addEventListener('click', loadUsers);
$('#userSearch').addEventListener('input', loadUsers);
  
  // ========= PAYMENTS =========
  function getPaymentStatusChip(status) {
    switch(status) {
      case 'pending': return '<span class="chip" style="color:#ffa500">Pending</span>';
      case 'verified': return '<span class="chip" style="color:#23d18b">Verified</span>';
      case 'rejected': return '<span class="chip" style="color:#ff5252">Rejected</span>';
      default: return '<span class="chip">' + status + '</span>';
    }
  }

  async function loadPayments(){
    const tb = $('#paymentsTbody');
    tb.innerHTML = '<tr><td colspan="8" class="muted">Loading‚Ä¶</td></tr>';
    const r = await safeFetch(API_BASE + '/api/admin/payments', { headers: authHeaders(false) });
    if (r._error){
      tb.innerHTML = '<tr><td colspan="8"><div class="notice">'+ r.message +'</div></td></tr>';
      return;
    }
    const payments = (r.payments || []);
    if (!payments.length){
      tb.innerHTML = '<tr><td colspan="8" class="muted">No payment records yet.</td></tr>';
      return;
    }
    
    const statusFilter = $('#paymentFilter').value;
    const searchQuery = $('#paymentSearch').value.trim().toLowerCase();
    
    const filtered = payments.filter(p => {
      const matchesStatus = statusFilter === 'all' || p.status === statusFilter;
      const matchesSearch = !searchQuery || 
        (p.userId?.username || '').toLowerCase().includes(searchQuery) ||
        (p.transactionId || '').toLowerCase().includes(searchQuery);
      return matchesStatus && matchesSearch;
    });

    tb.innerHTML = '';
    filtered.forEach(p=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><strong>${p.userId?.username || p.userId || 'Unknown'}</strong></td>
        <td>${p.plan || '-'}</td>
        <td>$${Number(p.amount || 0)}</td>
        <td class="mono small">${p.transactionId || 'No ID'}</td>
        <td>${p.phone || '-'}</td>
        <td class="small">${new Date(p.createdAt || Date.now()).toLocaleDateString()}</td>
        <td>${getPaymentStatusChip(p.status || 'pending')}</td>
        <td class="nowrap">
          ${p.status === 'pending' ? `
            <button class="btn-ok small" data-verify-payment="${p._id}">
              <i class="fa-solid fa-check"></i> Verify
            </button>
            <button class="btn-danger small" data-reject-payment="${p._id}">
              <i class="fa-solid fa-xmark"></i> Reject
            </button>
          ` : '<span class="muted small">No actions</span>'}
        </td>
      `;
      tb.appendChild(tr);
    });

    // Add event listeners for payment actions
    // --- VERIFY PAYMENT ---
tb.querySelectorAll('button[data-verify-payment]').forEach(b => {
  b.addEventListener('click', async () => {
    if (!confirm("Verify this payment? This will activate the user's subscription.")) return;

    const id = b.dataset.verifyPayment;
    b.disabled = true;
    b.textContent = 'Verifying‚Ä¶';

    try {
      const r = await safeFetch(API_BASE + '/api/admin/payments/' + id + '/verify', {
        method: 'POST',
        headers: authHeaders(true)
      });

      console.log("VERIFY RESPONSE:", r);

      if (!r.payment) {
        alert('‚ùå Verification failed: ' + (r.message || 'Unknown error'));
      } else {
        alert('‚úÖ Payment verified! Subscription activated.');
        loadPayments();
        loadUsers();
      }
    } catch (err) {
      console.error("Verify request error:", err);
      alert('Verification failed: ' + err.message);
    }

    b.disabled = false;
    b.innerHTML = '<i class="fa-solid fa-check"></i> Verify';
  });
});


// --- REJECT PAYMENT ---
tb.querySelectorAll('button[data-reject-payment]').forEach(b => {
  b.addEventListener('click', async () => {
    const reason = prompt("Enter rejection reason (optional):") || "No reason provided";
    if (!confirm("Are you sure you want to reject this payment?")) return;

    const id = b.dataset.rejectPayment;
    b.disabled = true;
    b.textContent = 'Rejecting‚Ä¶';

    try {
      const r = await safeFetch(API_BASE + '/api/admin/payments/' + id + '/reject', {
        method: 'POST',
        headers: {
          ...authHeaders(true),
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ reason })
      });

      console.log("REJECT RESPONSE:", r);

      if (!r.payment) {
        alert('‚ùå Rejection failed: ' + (r.message || 'Unknown error'));
      } else {
        alert('üö´ Payment rejected successfully.');
        loadPayments();
      }
    } catch (err) {
      console.error("Reject request error:", err);
      alert('Rejection failed: ' + err.message);
    }

    b.disabled = false;
    b.innerHTML = '<i class="fa-solid fa-xmark"></i> Reject';
  });
    });
  }
  $('#btnReloadPayments').addEventListener('click', loadPayments);
  $('#paymentFilter').addEventListener('change', loadPayments);
  $('#paymentSearch').addEventListener('input', loadPayments);

  // ========= WITHDRAWALS =========
  function getStatusChip(status) {
    switch(status) {
      case 'pending': return '<span class="chip" style="color:#ffa500">Pending</span>';
      case 'approved': return '<span class="chip" style="color:#23d18b">Approved</span>';
      case 'rejected': return '<span class="chip" style="color:#ff5252">Rejected</span>';
      default: return '<span class="chip">' + status + '</span>';
    }
  }

  async function loadWithdrawals(){
    const tb = $('#withdrawalsTbody');
    tb.innerHTML = '<tr><td colspan="5" class="muted">Loading‚Ä¶</td></tr>';
    const r = await safeFetch(API_BASE + '/api/admin/withdrawals', { headers: authHeaders(false) });
    if (r._error){
      tb.innerHTML = '<tr><td colspan="5"><div class="notice">'+ r.message +'</div></td></tr>';
      return;
    }
    const rows = r.withdrawals || [];
    if (!rows.length){
      tb.innerHTML = '<tr><td colspan="5" class="muted">No withdrawal requests.</td></tr>';
      return;
    }
    tb.innerHTML = '';
    rows.forEach(w=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><strong>${w.userId?.username || '-'}</strong></td>
        <td>${Number(w.amount || 0)}</td>
        <td class="mono">${w.walletAddress || '-'}</td>
        <td>${getStatusChip(w.status)}</td>
        <td class="nowrap">
          <button class="btn-ok small" data-approve="${w._id}">
            <i class="fa-solid fa-check"></i> Approve
          </button>
                    <button class="btn-danger small" data-reject="${w._id}">
            <i class="fa-solid fa-xmark"></i> Reject
          </button>
        </td>
      `;
      tb.appendChild(tr);
    });

    tb.querySelectorAll('button[data-approve]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id = b.dataset.approve;
        b.disabled = true; b.textContent = 'Approving‚Ä¶';
        const r = await safeFetch(API_BASE + '/api/admin/withdrawals/'+id+'/approve', {
          method:'POST', headers: authHeaders(true)
        });
        b.disabled = false; b.innerHTML = '<i class="fa-solid fa-check"></i> Approve';
        if (r._error) alert('Approve failed: ' + r.message);
        else { alert('Approved'); loadWithdrawals(); }
      });
    });
    tb.querySelectorAll('button[data-reject]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id = b.dataset.reject;
        b.disabled = true; b.textContent = 'Rejecting‚Ä¶';
        const r = await safeFetch(API_BASE + '/api/admin/withdrawals/'+id+'/reject', {
          method:'POST', headers: authHeaders(true)
        });
        b.disabled = false; b.innerHTML = '<i class="fa-solid fa-xmark"></i> Reject';
        if (r._error) alert('Reject failed: ' + r.message);
        else { alert('Rejected'); loadWithdrawals(); }
      });
    });
  }
  $('#btnReloadWithdrawals').addEventListener('click', loadWithdrawals);

  // ========= NEWS =========
  function updateNewsPreview(){
    const url = $('#newsImage').value.trim();
    $('#newsPreview').src = url || '';
  }
  $('#newsImage').addEventListener('input', updateNewsPreview);
  updateNewsPreview();

  async function loadNewsList(){
  const list = $('#newsList');
  list.innerHTML = '<div class="muted">Loading‚Ä¶</div>';
  
  try {
    // ÿßŸÑÿ™ÿπÿØŸäŸÑ 1: ÿ™ÿ∫ŸäŸäÿ± ŸÜŸÇÿ∑ÿ© ÿßŸÑŸÜŸáÿßŸäÿ©
    const r = await safeFetch(API_BASE + '/api/news');
    console.log('News API response:', r); // ŸÑŸÑÿ™ÿµÿ≠Ÿäÿ≠
    
    if (r._error){
      list.innerHTML = '';
      list.appendChild(el('div',{class:'notice'},[r.message]));
      return;
    }
    
    // ÿßŸÑÿ™ÿπÿØŸäŸÑ 2: ŸÖÿπÿßŸÑÿ¨ÿ© ŸáŸäŸÉŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿÆÿ™ŸÑŸÅ
    const items = Array.isArray(r) ? r : (r.news || []);
    
    if (!items.length){
      list.innerHTML = '<div class="muted">No news yet.</div>';
      return;
    }
    
    list.innerHTML = '';
    items.forEach(n=>{
      const card = el('div', {class:'card'}, [
        el('div', {class:'row'}, [
          el('div', {class:'col'}, [
            el('div', {class:'title', style:'font-size:15px'}, [n.title || '(no title)']),
            el('div', {class:'muted small'}, [n._id || '']),
            // ÿßŸÑÿ™ÿπÿØŸäŸÑ 3: ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ≠ŸÇŸÑ ÿßŸÑÿµÿ≠Ÿäÿ≠ ŸÑŸÑŸÜÿµ
            el('div', {style:'margin-top:6px'}, [n.text || n.body || n.content || ''])
          ]),
          el('div', {class:'col'}, [
            // ÿßŸÑÿ™ÿπÿØŸäŸÑ 4: ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ≠ŸÇŸÑ ÿßŸÑÿµÿ≠Ÿäÿ≠ ŸÑŸÑÿµŸàÿ±ÿ©
            n.image ? el('img', {src:n.image, class:'img-preview'}) : 
            n.imageUrl ? el('img', {src:n.imageUrl, class:'img-preview'}) : 
            el('div', {class:'muted small'}, ['No image']),
            el('div', {class:'small muted', style:'margin-top:6px'}, ['Button: ', (n.buttonText||'-'), ' ‚Üí ', (n.buttonLink||'-')])
          ])
        ]),
        el('div', {class:'row', style:'margin-top:8px'}, [
          el('button', {class:'btn small', 'data-edit-news': n._id}, [el('i',{class:'fa-solid fa-pen'}), document.createTextNode(' Edit')]),
          el('button', {class:'btn-danger small', 'data-del-news': n._id}, [el('i',{class:'fa-solid fa-trash'}), document.createTextNode(' Delete')])
        ])
      ]);
      list.appendChild(card);
    });

      // Add event listeners
      list.querySelectorAll('button[data-del-news]').forEach(b=>{
        b.addEventListener('click', async ()=>{
          if (!confirm('Delete this news item?')) return;
          const id = b.getAttribute('data-del-news');
          b.disabled = true; 
          b.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Deleting‚Ä¶';
          
          const r = await safeFetch(API_BASE + '/api/admin/news/' + id, {
            method: 'DELETE', 
            headers: authHeaders(false)
          });
          
          if (r._error) {
            alert('Delete failed: ' + r.message);
            b.disabled = false;
            b.innerHTML = '<i class="fa-solid fa-trash"></i> Delete';
          } else {
            loadNewsList();
          }
        });
      });

      list.querySelectorAll('button[data-edit-news]').forEach(b=>{
        b.addEventListener('click', async ()=>{
          const id = b.getAttribute('data-edit-news');
          const newsItem = items.find(item => item._id === id);
          
          if (!newsItem) return;
          
          // Fill form with existing data
          $('#newsTitle').value = newsItem.title || '';
          $('#newsBody').value = newsItem.body || '';
          $('#newsImage').value = newsItem.imageUrl || '';
          $('#newsBtnText').value = newsItem.buttonText || '';
          $('#newsBtnLink').value = newsItem.buttonLink || '';
          updateNewsPreview();
          
          // Change create button to update button temporarily
          const createBtn = $('#btnCreateNews');
          const originalHtml = createBtn.innerHTML;
          createBtn.innerHTML = '<i class="fa-solid fa-pen"></i> Update';
          
          const originalHandler = createBtn.onclick;
          createBtn.onclick = async () => {
            const title = $('#newsTitle').value.trim();
            const body = $('#newsBody').value.trim();
            const imageUrl = $('#newsImage').value.trim();
            const buttonText = $('#newsBtnText').value.trim();
            const buttonLink = $('#newsBtnLink').value.trim();
            
            const r = await safeFetch(API_BASE + '/api/admin/news/' + id, {
              method: 'PUT',
              headers: authHeaders(true),
              body: JSON.stringify({ title, body, imageUrl, buttonText, buttonLink })
            });
            
            if (r._error) {
              alert('Update failed: ' + r.message);
            } else {
              alert('News updated successfully!');
              // Reset form and button
              $('#newsTitle').value = '';
              $('#newsBody').value = '';
              $('#newsImage').value = '';
              $('#newsBtnText').value = '';
              $('#newsBtnLink').value = '';
              updateNewsPreview();
              createBtn.innerHTML = originalHtml;
              createBtn.onclick = originalHandler;
              loadNewsList();
            }
          };
        });
      });
      
    } catch (error) {
    console.error('Error loading news:', error);
    list.innerHTML = '<div class="notice">Error loading news: ' + error.message + '</div>';
  }
  }

  $('#btnCreateNews').addEventListener('click', async ()=>{
    const title = $('#newsTitle').value.trim();
    const body = $('#newsBody').value.trim();
    const imageUrl = $('#newsImage').value.trim();
    const buttonText = $('#newsBtnText').value.trim();
    const buttonLink = $('#newsBtnLink').value.trim();
    $('#newsCreateMsg').textContent = 'Creating‚Ä¶';
    const r = await safeFetch(API_BASE + '/api/admin/news', {
      method:'POST', headers: authHeaders(true),
      body: JSON.stringify({ title, body, imageUrl, buttonText, buttonLink })
    });
    if (r._error) $('#newsCreateMsg').innerHTML = '<span class="danger">'+ r.message +'</span>';
    else {
      $('#newsCreateMsg').innerHTML = '<span class="ok">Created</span>';
      $('#newsTitle').value = ''; $('#newsBody').value=''; $('#newsImage').value=''; $('#newsBtnText').value=''; $('#newsBtnLink').value='';
      updateNewsPreview();
      loadNewsList();
    }
  });
  $('#btnReloadNews').addEventListener('click', loadNewsList);

  // ========= INVITES & SUBSCRIPTIONS =========
async function loadInvites() {
  const tb = $('#invitesTbody');
  tb.innerHTML = '<tr><td colspan="7" class="muted">Loading‚Ä¶</td></tr>';
  const r = await safeFetch(API_BASE + '/api/admin/invites', { headers: authHeaders(false) });
  if (r._error) {
    tb.innerHTML = '<tr><td colspan="7"><div class="notice">'+ r.message +'</div></td></tr>';
    return;
  }
  
  const users = (r.users || []);
  if (!users.length) {
    tb.innerHTML = '<tr><td colspan="7" class="muted">No user data available.</td></tr>';
    return;
  }
  
  const filter = $('#invitesFilter').value;
  const search = $('#invitesSearch').value.trim().toLowerCase();
  
  const filtered = users.filter(u => {
    // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑŸÅŸÑÿ™ÿ±
    if (filter === 'withInvites' && (!u.totalInvites || u.totalInvites === 0)) return false;
    if (filter === 'withSubscriptions' && (!u.subscriptionType || u.subscriptionType === 'none')) return false;
    
    // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ®ÿ≠ÿ´
    if (search && !u.username.toLowerCase().includes(search)) return false;
    
    return true;
  });
  
  if (!filtered.length) {
    tb.innerHTML = '<tr><td colspan="7" class="muted">No matching users found.</td></tr>';
    return;
  }
  
  tb.innerHTML = '';
  filtered.forEach(u => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${u.username || '-'}</strong></td>
      <td>${u.email || '-'}</td>
      <td>${u.totalInvites || 0}</td>
      <td>${u.successfulInvites || 0}</td>
      <td>${u.subscriptionType || 'None'}</td>
      <td>${u.subscriptionStatus || 'Inactive'}</td>
      <td class="nowrap">
        <button class="btn small" data-action="viewDetails" data-id="${u._id}">
          <i class="fa-solid fa-eye"></i> Details
        </button>
      </td>
    `;
    tb.appendChild(tr);
  });
  
  // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ŸÖÿπŸä ÿßŸÑÿ£ÿ≠ÿØÿßÿ´ ŸÑŸÑÿ£ÿ≤ÿ±ÿßÿ±
  tb.querySelectorAll('button[data-action="viewDetails"]').forEach(btn => {
    btn.addEventListener('click', () => {
      const userId = btn.dataset.id;
      viewUserDetails(userId);
    });
  });
}

// ÿØÿßŸÑÿ© ŸÑÿπÿ±ÿ∂ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
async function viewUserDetails(userId) {
  const r = await safeFetch(API_BASE + '/api/admin/users/' + userId, { headers: authHeaders(false) });
  if (r._error) {
    alert('Error loading user details: ' + r.message);
    return;
  }
  
  const user = r.user;
  const message = `
    Username: ${user.username}
    Email: ${user.email}
    Total Invites: ${user.totalInvites || 0}
    Successful Invites: ${user.successfulInvites || 0}
    Subscription: ${user.subscriptionType || 'None'} (${user.subscriptionStatus || 'Inactive'})
    Join Date: ${new Date(user.createdAt).toLocaleDateString()}
  `;
  
  alert(message);
}

// ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ŸÖÿπŸä ÿßŸÑÿ£ÿ≠ÿØÿßÿ´
$('#btnReloadInvites').addEventListener('click', loadInvites);
$('#invitesFilter').addEventListener('change', loadInvites);
$('#invitesSearch').addEventListener('input', loadInvites);
  
  // ========= BANNERS =========
function updateBannerPreview() {
  const url = document.querySelector('#bannerImage').value.trim();
  document.querySelector('#bannerPreview').src =
    url || 'https://via.placeholder.com/300x150?text=Banner+Preview';
}
document.querySelector('#bannerImage').addEventListener('input', updateBannerPreview);
updateBannerPreview();

// ÿ™ÿ≠ŸÖŸäŸÑ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ®ÿßŸÜÿ±ÿßÿ™
async function loadBannerList() {
  const list = document.querySelector('#bannerList');
  list.innerHTML = '<div class="muted">Loading‚Ä¶</div>';

  try {
    const r = await safeFetch(API_BASE + '/api/admin/banners', {
      headers: authHeaders(false),
    });

    if (r._error) {
      list.innerHTML = '<div class="notice">' + r.message + '</div>';
      return;
    }

    const items = r.banners || r || [];
    if (!items.length) {
      list.innerHTML = '<div class="muted">No banners yet.</div>';
      return;
    }

    list.innerHTML = '';
    items.forEach((banner) => {
      const card = document.createElement('div');
      card.className = 'card';

      card.innerHTML = `
        <div class="row">
          <div class="col">
            <div class="title" style="font-size:15px">${banner.title || '(no title)'}</div>
            <div class="muted small">${banner._id || ''}</div>
            <div style="margin-top:6px">${banner.description || ''}</div>
          </div>
          <div class="col">
            ${banner.image ? `<img src="${banner.image}" class="img-preview"/>` : '<div class="muted small">No image</div>'}
            <div class="small muted" style="margin-top:6px">
              Button: ${banner.buttonText || '-'} ‚Üí ${banner.buttonLink || '-'}
            </div>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn small" data-edit-banner="${banner._id}"><i class="fa-solid fa-pen"></i> Edit</button>
          <button class="btn-danger small" data-del-banner="${banner._id}"><i class="fa-solid fa-trash"></i> Delete</button>
        </div>
      `;

      list.appendChild(card);
    });

    // ÿ£ÿ≠ÿØÿßÿ´ ÿßŸÑÿ≠ÿ∞ŸÅ
    list.querySelectorAll('button[data-del-banner]').forEach((b) => {
      b.addEventListener('click', async () => {
        if (!confirm('Delete this banner?')) return;
        const id = b.getAttribute('data-del-banner');
        b.disabled = true;
        b.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Deleting‚Ä¶';

        const r = await safeFetch(API_BASE + '/api/admin/banners/' + id, {
          method: 'DELETE',
          headers: authHeaders(false),
        });

        if (r._error) {
          alert('Delete failed: ' + r.message);
          b.disabled = false;
          b.innerHTML = '<i class="fa-solid fa-trash"></i> Delete';
        } else {
          loadBannerList();
        }
      });
    });

    // ÿ£ÿ≠ÿØÿßÿ´ ÿßŸÑÿ™ÿπÿØŸäŸÑ
    list.querySelectorAll('button[data-edit-banner]').forEach((b) => {
      b.addEventListener('click', async () => {
        const id = b.getAttribute('data-edit-banner');
        const banner = items.find((item) => item._id === id);

        if (!banner) return;

        // ÿ™ÿπÿ®ÿ¶ÿ© ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨
        document.querySelector('#bannerTitle').value = banner.title || '';
        document.querySelector('#bannerDescription').value = banner.description || '';
        document.querySelector('#bannerImage').value = banner.image || '';
        document.querySelector('#bannerBtnText').value = banner.buttonText || '';
        document.querySelector('#bannerBtnLink').value = banner.buttonLink || '';
        updateBannerPreview();

        // ÿ™ÿ≠ŸàŸäŸÑ ÿ≤ÿ± ÿßŸÑÿ•ŸÜÿ¥ÿßÿ° ÿ•ŸÑŸâ ÿ™ÿ≠ÿØŸäÿ´
        const createBtn = document.querySelector('#btnCreateBanner');
        const originalHtml = createBtn.innerHTML;
        createBtn.innerHTML = '<i class="fa-solid fa-pen"></i> Update';
        createBtn.onclick = async () => {
          const title = document.querySelector('#bannerTitle').value.trim();
          const description = document.querySelector('#bannerDescription').value.trim();
          const image = document.querySelector('#bannerImage').value.trim();
          const buttonText = document.querySelector('#bannerBtnText').value.trim();
          const buttonLink = document.querySelector('#bannerBtnLink').value.trim();

          const r = await safeFetch(API_BASE + '/api/admin/banners/' + id, {
            method: 'PUT',
            headers: authHeaders(true),
            body: JSON.stringify({ title, description, image, buttonText, buttonLink }),
          });

          if (r._error) {
            alert('Update failed: ' + r.message);
          } else {
            alert('Banner updated successfully!');
            document.querySelector('#bannerTitle').value = '';
            document.querySelector('#bannerDescription').value = '';
            document.querySelector('#bannerImage').value = '';
            document.querySelector('#bannerBtnText').value = '';
            document.querySelector('#bannerBtnLink').value = '';
            updateBannerPreview();
            createBtn.innerHTML = originalHtml;
            createBtn.onclick = createBannerHandler;
            loadBannerList();
          }
        };
      });
    });
  } catch (error) {
    list.innerHTML = '<div class="notice">Error loading banners: ' + error.message + '</div>';
  }
}

// ÿ•ŸÜÿ¥ÿßÿ° ÿ®ÿßŸÜÿ± ÿ¨ÿØŸäÿØ
async function createBannerHandler() {
  const title = document.querySelector('#bannerTitle').value.trim();
  const description = document.querySelector('#bannerDescription').value.trim();
  const image = document.querySelector('#bannerImage').value.trim();
  const buttonText = document.querySelector('#bannerBtnText').value.trim();
  const buttonLink = document.querySelector('#bannerBtnLink').value.trim();

  document.querySelector('#bannerCreateMsg').textContent = 'Creating‚Ä¶';

  const r = await safeFetch(API_BASE + '/api/admin/banners', {
    method: 'POST',
    headers: authHeaders(true),
    body: JSON.stringify({ title, description, image, buttonText, buttonLink }),
  });

  if (r._error) {
    document.querySelector('#bannerCreateMsg').innerHTML =
      '<span class="danger">' + r.message + '</span>';
  } else {
    document.querySelector('#bannerCreateMsg').innerHTML =
      '<span class="ok">Banner created successfully!</span>';
    document.querySelector('#bannerTitle').value = '';
    document.querySelector('#bannerDescription').value = '';
    document.querySelector('#bannerImage').value = '';
    document.querySelector('#bannerBtnText').value = '';
    document.querySelector('#bannerBtnLink').value = '';
    updateBannerPreview();
    loadBannerList();

    setTimeout(() => {
      document.querySelector('#bannerCreateMsg').textContent = '';
    }, 3000);
  }
}

document.querySelector('#btnCreateBanner').addEventListener('click', createBannerHandler);
document.querySelector('#btnReloadBanners').addEventListener('click', loadBannerList);

  // ========= NOTIFICATION MANAGEMENT =========
async function loadNotificationsList() {
  const list = $('#notificationsList');
  list.innerHTML = '<div class="muted">Loading notifications...</div>';
  
  try {
    const r = await safeFetch(API_BASE + '/api/admin/notifications', {
      headers: authHeaders(false)
    });
    
    if (r._error) {
      list.innerHTML = '<div class="notice">' + r.message + '</div>';
      return;
    }
    
    const notifications = Array.isArray(r) ? r : (r.notifications || []);
    
    if (!notifications.length) {
      list.innerHTML = '<div class="muted">No notifications yet.</div>';
      return;
    }
    
    list.innerHTML = '';
    notifications.forEach(notification => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="row">
          <div class="col">
            <div class="${notification.isActive ? 'ok' : 'muted'}">
              <strong>${notification.title || 'No title'}</strong>
            </div>
            <div class="small muted">${notification.message}</div>
            <div class="small muted">Priority: ${notification.priority || 1}</div>
            ${notification.link ? `
              <div class="small muted">
                Link: <a href="${notification.link}" target="_blank">${notification.linkText || notification.link}</a>
              </div>
            ` : ''}
          </div>
          <div class="col right">
            <div class="small muted">${new Date(notification.createdAt).toLocaleDateString()}</div>
            <div class="row" style="margin-top:8px">
              <button class="btn small" data-edit-notification="${notification._id}">
                <i class="fa-solid fa-pen"></i> Edit
              </button>
              <button class="btn-danger small" data-delete-notification="${notification._id}">
                <i class="fa-solid fa-trash"></i> Delete
              </button>
            </div>
          </div>
        </div>
      `;
      list.appendChild(card);
    });
    
    // Add event listeners
    list.querySelectorAll('[data-delete-notification]').forEach(btn => {
      btn.addEventListener('click', () => deleteNotification(btn.dataset.deleteNotification));
    });
    
    list.querySelectorAll('[data-edit-notification]').forEach(btn => {
      btn.addEventListener('click', () => editNotification(btn.dataset.editNotification, notifications));
    });
    
  } catch (error) {
    list.innerHTML = '<div class="notice">Error loading notifications: ' + error.message + '</div>';
  }
}

async function createNotification() {
  const title = $('#notificationTitle').value.trim();
  const message = $('#notificationMessage').value.trim();
  const link = $('#notificationLink').value.trim();
  const linkText = $('#notificationLinkText').value.trim();
  const priority = parseInt($('#notificationPriority').value) || 1;
  const isActive = $('#notificationStatus').value === 'true';
  
  if (!title || !message) {
    $('#notificationCreateMsg').innerHTML = '<span class="danger">Title and message are required</span>';
    return;
  }
  
  $('#notificationCreateMsg').innerHTML = '<span class="muted">Creating...</span>';
  
  try {
    console.log('Creating notification with data:', { title, message, link, linkText, priority, isActive });
    
    const r = await safeFetch(API_BASE + '/api/admin/notifications', {
      method: 'POST',
      headers: authHeaders(true),
      body: JSON.stringify({ title, message, link, linkText, priority, isActive })
    });
    
    console.log('Notification creation response:', r);
    
    if (r._error) {
      $('#notificationCreateMsg').innerHTML = '<span class="danger">' + r.message + '</span>';
      
      // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿÆÿ∑ÿ£ ŸÖÿ™ÿπŸÑŸÇŸãÿß ÿ®ÿßŸÑŸÖÿµÿßÿØŸÇÿ©ÿå ÿßÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ÿ™Ÿàÿ∂Ÿäÿ≠Ÿäÿ©
      if (r.message.includes('token') || r.message.includes('auth') || r.message.includes('session')) {
        $('#notificationCreateMsg').innerHTML += '<br><span class="muted small">Please try logging out and back in.</span>';
      }
    } else {
      $('#notificationCreateMsg').innerHTML = '<span class="ok">Notification created successfully!</span>';
      // Clear form
      $('#notificationTitle').value = '';
      $('#notificationMessage').value = '';
      $('#notificationLink').value = '';
      $('#notificationLinkText').value = '';
      $('#notificationPriority').value = '1';
      
      // Reload list
      loadNotificationsList();
      
      setTimeout(() => {
        $('#notificationCreateMsg').innerHTML = '';
      }, 3000);
    }
  } catch (error) {
    console.error('Error creating notification:', error);
    $('#notificationCreateMsg').innerHTML = '<span class="danger">Error creating notification: ' + error.message + '</span>';
  }
}

async function deleteNotification(id) {
  if (!confirm('Are you sure you want to delete this notification?')) return;
  
  try {
    const r = await safeFetch(API_BASE + '/api/admin/notifications/' + id, {
      method: 'DELETE',
      headers: authHeaders(false)
    });
    
    if (r._error) {
      alert('Delete failed: ' + r.message);
    } else {
      alert('Notification deleted successfully!');
      loadNotificationsList();
    }
  } catch (error) {
    alert('Error deleting notification: ' + error.message);
  }
}

function clearDismissedNotifications() {
  if (confirm('Clear all dismissed notification records? Users will see these notifications again.')) {
    localStorage.removeItem('dismissedNotifications');
    alert('Dismissed notifications cleared!');
  }
}

// Add event listeners
$('#btnCreateNotification').addEventListener('click', createNotification);
$('#btnReloadNotifications').addEventListener('click', loadNotificationsList);
$('#btnClearDismissed').addEventListener('click', clearDismissedNotifications);

// Load notifications when tab is opened
document.querySelector('[data-tab="tab-notifications"]').addEventListener('click', () => {
  if (isSigned()) {
    loadNotificationsList();
  }
});
  
// ========= NEWS TICKERS MANAGEMENT =========
async function loadTickers() {
  const list = $('#tickersList');
  list.innerHTML = '<div class="muted">Loading tickers...</div>';
  
  try {
    const r = await safeFetch(API_BASE + '/api/newstickers');
    
    if (r._error) {
      list.innerHTML = '<div class="notice">' + r.message + '</div>';
      return;
    }
    
    const tickers = Array.isArray(r) ? r : [];
    
    if (!tickers.length) {
      list.innerHTML = '<div class="muted">No tickers yet.</div>';
      return;
    }
    
    list.innerHTML = '';
    tickers.forEach(ticker => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="row">
          <div class="col">
            <div class="${ticker.isActive ? 'ok' : 'muted'}">${ticker.text}</div>
            <div class="small muted">Priority: ${ticker.priority || 1}</div>
          </div>
          <div class="col right">
            <div class="small muted">${new Date(ticker.createdAt).toLocaleDateString()}</div>
            <div class="row" style="margin-top:8px">
              <button class="btn small" data-edit-ticker="${ticker._id}">
                <i class="fa-solid fa-pen"></i> Edit
              </button>
              <button class="btn-danger small" data-delete-ticker="${ticker._id}">
                <i class="fa-solid fa-trash"></i> Delete
              </button>
            </div>
          </div>
        </div>
      `;
      list.appendChild(card);
    });
    
    // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿπÿßŸÑÿ¨ÿßÿ™ ÿßŸÑÿ£ÿ≠ÿØÿßÿ´
    list.querySelectorAll('[data-delete-ticker]').forEach(btn => {
      btn.addEventListener('click', () => deleteTicker(btn.dataset.deleteTicker));
    });
    
    list.querySelectorAll('[data-edit-ticker]').forEach(btn => {
      btn.addEventListener('click', () => editTicker(btn.dataset.editTicker, tickers));
    });
    
  } catch (error) {
    list.innerHTML = '<div class="notice">Error loading tickers: ' + error.message + '</div>';
  }
}

async function createTicker() {
  const text = $('#tickerText').value.trim();
  const priority = parseInt($('#tickerPriority').value) || 1;
  const isActive = $('#tickerStatus').value === 'true';
  
  if (!text) {
    $('#tickerCreateMsg').innerHTML = '<span class="danger">Please enter ticker text</span>';
    return;
  }
  
  $('#tickerCreateMsg').innerHTML = '<span class="muted">Creating...</span>';
  
  try {
    const r = await safeFetch(API_BASE + '/api/admin/newstickers', {
      method: 'POST',
      headers: authHeaders(true),
      body: JSON.stringify({ text, priority, isActive })
    });
    
    if (r._error) {
      $('#tickerCreateMsg').innerHTML = '<span class="danger">' + r.message + '</span>';
    } else {
      $('#tickerCreateMsg').innerHTML = '<span class="ok">Ticker created successfully!</span>';
      $('#tickerText').value = '';
      loadTickers();
      
      setTimeout(() => {
        $('#tickerCreateMsg').innerHTML = '';
      }, 3000);
    }
  } catch (error) {
    $('#tickerCreateMsg').innerHTML = '<span class="danger">Error creating ticker</span>';
  }
}

async function deleteTicker(id) {
  if (!confirm('Are you sure you want to delete this ticker?')) return;
  
  try {
    const r = await safeFetch(API_BASE + '/api/admin/newstickers/' + id, {
      method: 'DELETE',
      headers: authHeaders(false)
    });
    
    if (r._error) {
      alert('Delete failed: ' + r.message);
    } else {
      alert('Ticker deleted successfully!');
      loadTickers();
    }
  } catch (error) {
    alert('Error deleting ticker: ' + error.message);
  }
}

// ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ŸÖÿπŸä ÿßŸÑÿ£ÿ≠ÿØÿßÿ´
$('#btnCreateTicker').addEventListener('click', createTicker);
$('#btnReloadTickers').addEventListener('click', loadTickers);

// ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ŸäŸÉÿ±ÿßÿ™ ÿπŸÜÿØ ŸÅÿ™ÿ≠ ÿßŸÑÿ™ÿ®ŸàŸäÿ®
document.querySelector('[data-tab="tab-tickers"]').addEventListener('click', () => {
  if (isSigned()) {
    loadTickers();
  }
});

  // ========= INIT =========
  updateAuthUI();

  // Auto-load after login if token exists
  if (isSigned()){
    loadStats();
    loadUsersWithDebug();
    loadPayments();
    loadWithdrawals();
    loadNewsList();
    loadBannerList();
    loadAdminDashboard(); 
    loadLotteryList();
    loadTickers();
    loadInvites();
    loadNotificationsList()
  }

  // If the admin navigates into tabs while not signed, we keep UI friendly
  document.addEventListener('click', (e)=>{
    const tab = e.target.closest('.navbtn')?.dataset?.tab || '';
    const needAuthTabs = ['tab-stats','tab-users','tab-payments','tab-withdrawals','tab-news','tab-banners','tab-tickers'];
    if (tab && needAuthTabs.includes(tab) && !isSigned()){
      setTimeout(()=>{ alert('Please sign in as admin first.'); }, 0);
    }
  });
</script>
</body>
  </html>
