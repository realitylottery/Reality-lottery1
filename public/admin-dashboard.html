<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>RealityLottery — Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
/>
<style>
  :root{
    --bg:#000; --panel:#0f0f0f; --muted:#b9b9b9; --gold:#ffd700; --gold2:#ffa500; --red:#ff5252; --green:#23d18b; --blue:#4f8ff7;
  }
  *{box-sizing:border-box; font-family: Arial, Helvetica, sans-serif;}
  body{margin:0; background:var(--bg); color:#fff; min-height:100vh; display:flex; flex-direction:column;}
  header{border-bottom:2px solid var(--gold); background:#111; padding:16px 20px; display:flex; align-items:center; justify-content:space-between;}
  .brand{font-weight:800; letter-spacing:1px; color:var(--gold); font-size:20px;}
  .admin-state{font-size:14px; color:var(--muted);}
  .wrap{display:flex; flex:1; min-height:0;}
  aside{width:280px; background:var(--panel); border-right:1px solid rgba(255,215,0,0.25); padding:14px; overflow:auto;}
  main{flex:1; padding:16px; overflow:auto;}
  .section{background:#111; border:1px solid rgba(255,215,0,0.25); border-radius:10px; padding:16px; margin-bottom:16px;}
  .title{font-weight:700; color:var(--gold); margin-bottom:10px; display:flex; align-items:center; gap:10px;}
  .muted{color:var(--muted); font-size:13px;}
  .btn{background:linear-gradient(45deg, var(--gold), var(--gold2)); color:#000; font-weight:700; border:none; border-radius:8px; padding:10px 14px; cursor:pointer; transition:transform .15s ease, box-shadow .15s ease; box-shadow:0 4px 12px rgba(255,215,0,.25);}
  .btn:hover{transform:translateY(-1px); box-shadow:0 6px 14px rgba(255,215,0,.35);}
  .btn-outline{background:transparent; border:1px solid var(--gold); color:var(--gold);}
  .btn-danger{background:#2b0000; border:1px solid #900; color:#f88;}
  .btn-ok{background:#092; border:1px solid #0f6; color:#eaffea;}
  .btn-info{background:#004080; border:1px solid #4f8ff7; color:#e0f0ff;}
  .row{display:flex; gap:12px; flex-wrap:wrap;}
  .col{flex:1 1 240px; min-width:220px;}
  input, select, textarea{
    width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,215,0,.25);
    background:#0f0f0f; color:#fff; outline:none;
  }
  textarea{min-height:120px; resize:vertical;}
  label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px;}
  table{width:100%; border-collapse:collapse; overflow:auto;}
  th, td{border-bottom:1px solid rgba(255,215,0,.15); padding:10px; text-align:left; font-size:14px;}
  th{color:var(--gold);}
  .chip{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid rgba(255,215,0,.35); color:var(--gold);}
  .grid{display:grid; gap:12px;}
  .grid-2{grid-template-columns:repeat(2, minmax(0, 1fr));}
  .grid-3{grid-template-columns:repeat(3, minmax(0, 1fr));}
  .grid-4{grid-template-columns:repeat(4, minmax(0, 1fr));}
  .stat{background:#0f0f0f; border:1px solid rgba(255,215,0,.2); border-radius:10px; padding:14px;}
  .stat .label{color:var(--muted); font-size:12px;}
  .stat .value{color:#fff; font-size:22px; margin-top:6px;}
  .hidden{display:none !important;}
  .danger{color:#ff8b8b}
  .ok{color:#9effb3}
  .info{color:#4f8ff7}
  .notice{background:#141414; border:1px dashed rgba(255,215,0,.35); border-radius:10px; padding:10px; color:var(--muted); font-size:13px;}
  .top-actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  .small{font-size:12px;}
  .card{border:1px solid rgba(255,215,0,.2); background:#0e0e0e; border-radius:10px; padding:12px;}
  .img-preview{width:100%; max-height:140px; object-fit:cover; border-radius:8px; border:1px solid rgba(255,215,0,.25); background:#000;}
  .pill{border:1px solid rgba(255,215,0,.25); padding:4px 10px; border-radius:999px; font-size:12px; color:var(--muted)}
  .divider{height:1px; background:rgba(255,215,0,.2); margin:10px 0;}
  footer{border-top:1px solid rgba(255,215,0,.25); padding:10px 16px; color:var(--muted); text-align:center; background:#111;}
  .navbtn{width:100%; text-align:left; background:transparent; border:1px solid rgba(255,215,0,.25); color:#fff; padding:10px 12px; border-radius:8px; cursor:pointer; margin-bottom:8px;}
  .navbtn.active{border-color:var(--gold); color:var(--gold); background:#151515;}
  .inline{display:inline-flex; gap:8px; align-items:center;}
  .nowrap{white-space:nowrap;}
  .right{margin-left:auto}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  .filter-bar{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:12px;}
  .filter-select{background:#0f0f0f; border:1px solid rgba(255,215,0,.25); color:#fff; padding:6px 10px; border-radius:6px;}
</style>
</head>
<body>
<header>
  <div class="brand"><i class="fa-solid fa-crown"></i> RealityLottery Admin</div>
  <div class="inline">
    <span id="adminState" class="admin-state">Not signed in</span>
    <button id="btnLogout" class="btn btn-outline hidden"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
  </div>
</header>

<div class="wrap">
  <aside>
    <button class="navbtn active" data-tab="tab-login"><i class="fa-solid fa-lock"></i> Admin Sign-in</button>
    <button class="navbtn" data-tab="tab-stats"><i class="fa-solid fa-chart-line"></i> Stats</button>
    <button class="navbtn" data-tab="tab-lottery"><i class="fa-solid fa-ticket"></i> Lottery</button>
    <button class="navbtn" data-tab="tab-users"><i class="fa-solid fa-users"></i> Users</button>
    <button class="navbtn" data-tab="tab-payments"><i class="fa-solid fa-credit-card"></i> Payments</button>
    <button class="navbtn" data-tab="tab-withdrawals"><i class="fa-solid fa-wallet"></i> Withdrawals</button>
    <button class="navbtn" data-tab="tab-invites"><i class="fa-solid fa-user-plus"></i> Invites & Subscriptions</button>
    <button class="navbtn" data-tab="tab-news"><i class="fa-solid fa-newspaper"></i> News</button>
    <button class="navbtn" data-tab="tab-banners"><i class="fa-solid fa-image"></i> Banners</button>
    <button class="navbtn" data-tab="tab-tickers"><i class="fa-solid fa-scroll"></i> News Tickers</button>
    <button class="navbtn" data-tab="tab-notifications">
  <i class="fa-solid fa-bell"></i> Notifications</button>
    <div class="divider"></div>
    <div class="small muted">All actions require admin token.</div>
  </aside>

  <main>
    <!-- LOGIN -->
    <section id="tab-login" class="section">
      <div class="title"><i class="fa-solid fa-lock"></i> Admin Sign-in</div>
      <div class="row">
        <div class="col card">
          <label>Admin Username</label>
          <input id="adminUser" placeholder="admin" />
          <label style="margin-top:8px">Admin Password</label>
          <input id="adminPass" type="password" placeholder="Your strong password" />
          <div class="row" style="margin-top:12px">
            <button class="btn" id="btnLoginAdmin"><i class="fa-solid fa-right-to-bracket"></i> Sign in</button>
            <span id="loginMsg" class="muted"></span>
          </div>
          <div class="notice" style="margin-top:12px">
            Default (as per server): <span class="mono">a</span>. Y <span class="mono">ADMIN_USER</span> and <span class="mono">ADMIN_PASS</span>.
          </div>
        </div>
        <div class="col">
          <div class="notice">
            Your token is stored in <span class="mono">localStorage.rl_admin_token</span> and attached as <span class="mono">Authorization: Bearer &lt;token&gt;</span> to all admin API calls on the same origin.
          </div>
        </div>
      </div>
    </section>

    <!-- STATS -->
    <section id="tab-stats" class="section hidden">
      <div class="title"><i class="fa-solid fa-chart-line"></i> Platform Stats</div>
      <div id="statsWrap" class="grid grid-4">
        <!-- cards injected -->
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn" id="btnRefreshStats"><i class="fa-solid fa-rotate"></i> Refresh</button>
        <span class="muted">If endpoint is not ready, you'll see a gentle message instead of an error.</span>
      </div>
    </section>
    
    <section id="tab-notifications" class="section hidden">
  <div class="title"><i class="fa-solid fa-bell"></i> Notification Management</div>
  
  <div class="grid grid-2">
    <div class="card">
      <div class="title" style="font-size:16px"><i class="fa-solid fa-plus"></i> Create New Notification</div>
      
      <label>Notification Title</label>
      <input id="notificationTitle" placeholder="Notification title" />
      
      <label style="margin-top:8px">Notification Message</label>
      <textarea id="notificationMessage" placeholder="Notification message..." rows="3"></textarea>
      
      <div class="row" style="margin-top:8px">
        <div class="col">
          <label>Link (Optional)</label>
          <input id="notificationLink" placeholder="https://..." />
        </div>
        <div class="col">
          <label>Link Text (Optional)</label>
          <input id="notificationLinkText" placeholder="Link text" />
        </div>
      </div>
      
      <div class="row" style="margin-top:8px">
        <div class="col">
          <label>Priority</label>
          <input id="notificationPriority" type="number" value="1" min="1" max="10" />
        </div>
        <div class="col">
          <label>Status</label>
          <select id="notificationStatus">
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>
        </div>
      </div>
      
      <div class="row" style="margin-top:12px">
        <button class="btn" id="btnCreateNotification">
          <i class="fa-solid fa-plus"></i> Create Notification
        </button>
        <span id="notificationCreateMsg" class="muted"></span>
      </div>
    </div>

    <div class="card">
      <div class="title" style="font-size:16px"><i class="fa-solid fa-list"></i> Current Notifications</div>
      <div id="notificationsList" class="grid" style="grid-template-columns:1fr; gap:10px;">
        <div class="muted">Loading notifications...</div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnReloadNotifications">
          <i class="fa-solid fa-rotate"></i> Reload
        </button>
        <button class="btn btn-outline" id="btnClearDismissed">
          <i class="fa-solid fa-trash"></i> Clear Dismissed Records
        </button>
      </div>
    </div>
  </div>
    </section>
    
    <!-- DEBUG -->
<section id="tab-debug" class="section hidden">
  <div class="title"><i class="fa-solid fa-bug"></i> Debug & Testing</div>
  
  <div class="grid grid-2">
    <div class="card">
      <div class="title" style="font-size:16px"><i class="fa-solid fa-database"></i> Database Debug</div>
      
      <label>User ID to Test</label>
      <input id="debugUserId" placeholder="Enter user ID" />
      
      <div class="row" style="margin-top:12px">
        <button class="btn" id="btnDebugUser"><i class="fa-solid fa-magnifying-glass"></i> Check User Data</button>
        <button class="btn btn-outline" id="btnDebugAllUsers"><i class="fa-solid fa-users"></i> Check All Users</button>
      </div>
      
      <div id="debugResult" class="notice" style="margin-top:12px; max-height:200px; overflow:auto;">
        Results will appear here...
      </div>
    </div>
    
    <div class="card">
      <div class="title" style="font-size:16px"><i class="fa-solid fa-wrench"></i> Server Testing</div>
      
      <label>Test Endpoint</label>
      <select id="debugEndpoint">
        <option value="/api/admin/users">GET /api/admin/users</option>
        <option value="/api/admin/users/ID">PUT /api/admin/users/ID</option>
        <option value="/api/debug/fields">Debug User Fields</option>
      </select>
      
      <label style="margin-top:8px">Test Data (JSON)</label>
      <textarea id="debugData" placeholder='{"completedTasks": 5}' style="height:60px;"></textarea>
      
      <div class="row" style="margin-top:12px">
        <button class="btn" id="btnTestEndpoint"><i class="fa-solid fa-play"></i> Test Endpoint</button>
      </div>
      
      <div id="debugEndpointResult" class="notice" style="margin-top:12px; max-height:200px; overflow:auto;">
        Endpoint results will appear here...
      </div>
    </div>
  </div>
</section>
      <section id="tab-lottery" class="section hidden">
  <div class="title"><i class="fa-solid fa-ticket"></i> Lottery Management</div>
  
  <div class="filter-bar">
    <select id="lotteryFilter" class="filter-select">
      <option value="all">All Entries</option>
      <option value="active">Active Only</option>
      <option value="winners">Winners</option>
    </select>
    <input id="lotterySearch" placeholder="Search by username..." />
    <button class="btn" id="btnReloadLottery"><i class="fa-solid fa-rotate"></i> Reload</button>
  </div>

  <div class="row" style="overflow:auto">
    <table>
      <thead>
        <tr>
          <th>Username</th>
          <th>Entries</th>
          <th>Prize</th>
          <th>Status</th>
          <th>Draw Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="lotteryTbody">
        <tr><td colspan="6" class="muted">Loading…</td></tr>
      </tbody>
    </table>
  </div>
      </section>
    
    <!-- USERS -->
    <section id="tab-users" class="section hidden">
      <div class="title"><i class="fa-solid fa-users"></i> Users Management</div>
      <div class="row top-actions">
        <input id="userSearch" placeholder="Search by username or email..." class="col" />
        <button class="btn" id="btnReloadUsers"><i class="fa-solid fa-rotate"></i> Reload</button>
        <span class="pill">Tip: use the inline actions to set balance, subscription, and task progress.</span>
      </div>
      <div class="row" style="margin-top:12px; overflow:auto">
        <table>
          <thead>
            <tr>
              <th>username</th>
              <th>Email</th>
              <th>Balance</th>
              <th>Subscription</th>
              <th class="nowrap">Save</th>
            </tr>
          </thead>
          <tbody id="usersTbody">
            <tr><td colspan="6" class="muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- PAYMENTS -->
    <section id="tab-payments" class="section hidden">
      <div class="title"><i class="fa-solid fa-credit-card"></i> Payment Management</div>
      
      <div class="filter-bar">
        <select id="paymentFilter" class="filter-select">
          <option value="all">All Payments</option>
          <option value="pending">Pending</option>
          <option value="verified">Verified</option>
          <option value="rejected">Rejected</option>
        </select>
        <input id="paymentSearch" placeholder="Search by user or transaction ID..." />
        <button class="btn" id="btnReloadPayments"><i class="fa-solid fa-rotate"></i> Reload</button>
      </div>
      
      <div class="row" style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Plan</th>
              <th>Amount</th>
              <th>Transaction ID</th>
              <th>Phone</th>
              <th>Date</th>
              <th>Status</th>
              <th class="nowrap">Actions</th>
            </tr>
          </thead>
          <tbody id="paymentsTbody">
            <tr><td colspan="8" class="muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>
      
      <div class="notice" style="margin-top:12px">
        This section allows you to manage user payment verifications. Verify payments to activate user subscriptions.
      </div>
    </section>

    <!-- WITHDRAWALS -->
    <section id="tab-withdrawals" class="section hidden">
      <div class="title"><i class="fa-solid fa-wallet"></i> Withdrawals</div>
      <div class="row top-actions">
        <button class="btn" id="btnReloadWithdrawals"><i class="fa-solid fa-rotate"></i> Reload</button>
        <span class="pill">Approve or reject user withdrawal requests.</span>
      </div>
      <div class="row" style="margin-top:12px; overflow:auto">
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Amount</th>
              <th>Wallet Address</th>
              <th>Status</th>
              <th class="nowrap">Actions</th>
            </tr>
          </thead>
          <tbody id="withdrawalsTbody">
            <tr><td colspan="5" class="muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>
      <div class="notice" style="margin-top:10px">
        This expects endpoints <span class="mono">GET /api/admin/withdrawals</span>, <span class="mono">POST /api/admin/withdrawals/:id/approve</span> and <span class="mono">POST /api/admin/withdrawals/:id/reject</span>.
        If not implemented yet, you'll see an informational message instead of an error.
      </div>
    </section>

    <!-- أضف هذا القسم بعد قسم Withdrawals -->
<section id="tab-invites" class="section hidden">
  <div class="title"><i class="fa-solid fa-user-plus"></i> Invites & Subscriptions</div>
  
  <div class="filter-bar">
    <select id="invitesFilter" class="filter-select">
      <option value="all">All Users</option>
      <option value="withInvites">With Invites</option>
      <option value="withSubscriptions">With Subscriptions</option>
    </select>
    <input id="invitesSearch" placeholder="Search by username..." />
    <button class="btn" id="btnReloadInvites"><i class="fa-solid fa-rotate"></i> Reload</button>
  </div>
  
  <div class="row" style="overflow:auto">
    <table>
      <thead>
        <tr>
          <th>Username</th>
          <th>Email</th>
          <th>Total Invites</th>
          <th>Successful Invites</th>
          <th>Subscription Type</th>
          <th>Subscription Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="invitesTbody">
        <tr><td colspan="7" class="muted">Loading…</td></tr>
      </tbody>
    </table>
  </div>
  
  <div class="notice" style="margin-top:12px">
    This section shows detailed information about user invites and subscriptions.
  </div>
</section>
    
    <!-- NEWS -->
    <section id="tab-news" class="section hidden">
      <div class="title"><i class="fa-solid fa-newspaper"></i> News Management</div>

      <div class="grid grid-2">
        <div class="card">
          <div class="title" style="font-size:16px"><i class="fa-solid fa-plus"></i> New News Item</div>
          <div class="row">
            <div class="col">
              <label>Title</label>
              <input id="newsTitle" placeholder="Headline…" />
            </div>
            <div class="col">
              <label>Button Text</label>
              <input id="newsBtnText" placeholder="Read more" />
            </div>
          </div>
          <label style="margin-top:8px">Body</label>
          <textarea id="newsBody" placeholder="Short description…"></textarea>
          <div class="row" style="margin-top:8px">
            <div class="col">
              <label>Image URL</label>
              <input id="newsImage" placeholder="https://…" />
            </div>
            <div class="col">
              <label>Button Link URL</label>
              <input id="newsBtnLink" placeholder="https://…" />
            </div>
          </div>
          <div class="row" style="margin-top:10px; align-items:flex-start">
            <div class="col"><img id="newsPreview" class="img-preview" alt="Preview" /></div>
            <div class="col">
              <button class="btn" id="btnCreateNews"><i class="fa-solid fa-floppy-disk"></i> Create</button>
              <div class="small muted" id="newsCreateMsg" style="margin-top:6px;"></div>
            </div>
          </div>
          <div class="notice" style="margin-top:12px">
            Image uploads are via URL for now. If you later add file uploads on the server, you can wire it here easily.
          </div>
        </div>

        <div class="card">
          <div class="title" style="font-size:16px"><i class="fa-solid fa-list"></i> Existing News</div>
          <div id="newsList" class="grid" style="grid-template-columns:1fr; gap:10px;">
            <div class="muted">Loading…</div>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="btnReloadNews"><i class="fa-solid fa-rotate"></i> Reload</button>
          </div>
          <div class="small muted" style="margin-top:8px">
            Endpoints expected: <span class="mono">GET/POST /api/admin/news</span>, <span class="mono">PUT/DELETE /api/admin/news/:id</span>.
          </div>
        </div>
      </div>
    </section>

    <!-- BANNERS -->
    <section id="tab-banners" class="section hidden">
      <div class="title"><i class="fa-solid fa-image"></i> Banner Management</div>

      <div class="grid grid-2">
        <div class="card">
          <div class="title" style="font-size:16px"><i class="fa-solid fa-plus"></i> New Banner</div>
          <div class="row">
            <div class="col">
              <label>Title</label>
              <input id="bannerTitle" placeholder="Banner title…" />
            </div>
            <div class="col">
              <label>Button Text</label>
              <input id="bannerBtnText" placeholder="Click here" />
            </div>
          </div>
          <label style="margin-top:8px">Description</label>
          <textarea id="bannerDescription" placeholder="Banner description…"></textarea>
          <div class="row" style="margin-top:8px">
            <div class="col">
              <label>Image URL</label>
              <input id="bannerImage" placeholder="https://…" />
            </div>
            <div class="col">
              <label>Button Link URL</label>
              <input id="bannerBtnLink" placeholder="https://…" />
            </div>
          </div>
          <div class="row" style="margin-top:10px; align-items:flex-start">
            <div class="col"><img id="bannerPreview" class="img-preview" alt="Preview" /></div>
            <div class="col">
              <button class="btn" id="btnCreateBanner"><i class="fa-solid fa-floppy-disk"></i> Create</button>
              <div class="small muted" id="bannerCreateMsg" style="margin-top:6px;"></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="title" style="font-size:16px"><i class="fa-solid fa-list"></i> Existing Banners</div>
          <div id="bannerList" class="grid" style="grid-template-columns:1fr; gap:10px;">
            <div class="muted">Loading…</div>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="btnReloadBanners"><i class="fa-solid fa-rotate"></i> Reload</button>
          </div>
        </div>
      </div>
    </section>
     
    <section id="tab-tickers" class="section hidden">
  <div class="title"><i class="fa-solid fa-scroll"></i> News Tickers Management</div>
  
  <div class="grid grid-2">
    <div class="card">
      <div class="title" style="font-size:16px"><i class="fa-solid fa-plus"></i> Add New Ticker</div>
      
      <label>Ticker Text</label>
      <textarea id="tickerText" placeholder="Enter ticker text..." rows="3"></textarea>
      
      <div class="row" style="margin-top:8px">
        <div class="col">
          <label>Priority</label>
          <input id="tickerPriority" type="number" value="1" min="1" max="10" />
        </div>
        <div class="col">
          <label>Status</label>
          <select id="tickerStatus">
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>
        </div>
      </div>
      
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnCreateTicker"><i class="fa-solid fa-plus"></i> Add Ticker</button>
        <span id="tickerCreateMsg" class="muted"></span>
      </div>
    </div>

    <div class="card">
      <div class="title" style="font-size:16px"><i class="fa-solid fa-list"></i> Current Tickers</div>
      <div id="tickersList" class="grid" style="grid-template-columns:1fr; gap:10px;">
        <div class="muted">Loading tickers...</div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnReloadTickers"><i class="fa-solid fa-rotate"></i> Reload</button>
      </div>
    </div>
  </div>
    </section>
  </main>
</div>

<footer>
  <div>© <span id="year"></span> RealityLottery — Admin. All rights reserved.</div>
</footer>

<script>
  // ========= CONFIG =========
  const API_BASE = 'https://realitylottery.koyeb.app';
  const LS_TOKEN = 'rl_admin_token';

  const $ = (q)=>document.querySelector(q);
  const $$ = (q)=>Array.from(document.querySelectorAll(q));
  const year = new Date().getFullYear(); $('#year').textContent = year;

  // ========= NAV =========
  $$('.navbtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      $$('.navbtn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      $$('main .section').forEach(s=>s.classList.add('hidden'));
      document.getElementById(tab).classList.remove('hidden');
    });
  });

  // ========= AUTH =========
  const adminState = $('#adminState');
  const btnLogout = $('#btnLogout');

  function getToken(){ return localStorage.getItem(LS_TOKEN) || ''; }
  function setToken(t){
    if (t) localStorage.setItem(LS_TOKEN, t);
    updateAuthUI();
  }
  function clearToken(){
    localStorage.removeItem(LS_TOKEN);
    updateAuthUI();
  }
  function isSigned(){ return !!getToken(); }

  function updateAuthUI(){
    if (isSigned()){
      adminState.innerHTML = '<span class="ok">Signed in</span> — token stored';
      btnLogout.classList.remove('hidden');
    } else {
      adminState.innerHTML = 'Not signed in';
      btnLogout.classList.add('hidden');
    }
  }
  btnLogout.addEventListener('click', ()=>{ clearToken(); info('Signed out.'); });

  // ========= HELPERS =========
  function authHeaders(json=true){
    const h = { 'Authorization':'Bearer ' + getToken() };
    if (json) h['Content-Type'] = 'application/json';
    return h;
  }
  function info(msg){ console.log(msg); }
  function humanErr(e){
    if (e && e.message) return e.message;
    return 'Endpoint not available yet';
  }
  async function safeFetch(url, opts={}){
    try{
      const res = await fetch(url, opts);
      const ct = res.headers.get('content-type') || '';
      const data = ct.includes('application/json') ? await res.json() : await res.text();
      if (!res.ok){
        // Handle 403 Forbidden specifically
        if (res.status === 403) {
          return { _error: true, message: 'Access forbidden. Please check your admin privileges or token.' };
        }
        throw new Error((data && data.message) ? data.message : ('HTTP ' + res.status));
      }
      return data;
    }catch(e){
      console.warn('Fetch error', url, e);
      return { _error: true, message: humanErr(e) };
    }
  }
  function el(tag, attrs={}, children=[]){
    const n = document.createElement(tag);
    Object.entries(attrs||{}).forEach(([k,v])=>{
      if (k==='class') n.className = v;
      else if (k==='html') n.innerHTML = v;
      else n.setAttribute(k,v);
    });
    (children||[]).forEach(c=>{
      if (typeof c==='string') n.appendChild(document.createTextNode(c));
      else if (c) n.appendChild(c);
    });
    return n;
  }

  // ========= LOGIN =========
  $('#btnLoginAdmin').addEventListener('click', async ()=>{
    const username = $('#adminUser').value.trim();
    const password = $('#adminPass').value.trim();
    $('#loginMsg').textContent = 'Signing in…';
    const r = await safeFetch(API_BASE + '/api/admin/login', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ username, password })
    });
    if (r._error){
      $('#loginMsg').innerHTML = '<span class="danger">'+ r.message +'</span>';
    } else {
      setToken(r.token);
      $('#loginMsg').innerHTML = '<span class="ok">Success</span>';
      // Auto-load data after successful login
      loadStats();
      loadUsers();
      loadPayments();
      loadWithdrawals();
      loadNewsList();
      loadBannerList();
    }
  });

  // ========= DEBUG FUNCTIONS =========
async function debugUserData(userId) {
  const resultDiv = $('#debugResult');
  resultDiv.innerHTML = 'Loading user data...';
  
  try {
    const r = await safeFetch(API_BASE + '/api/admin/users/' + userId, { 
      headers: authHeaders(false) 
    });
    
    if (r._error) {
      resultDiv.innerHTML = `<span class="danger">Error: ${r.message}</span>`;
      return;
    }
    
    const user = r.user || r;
    let debugInfo = `
      <strong>User Data for ${user.username || 'Unknown'}:</strong><br>
      <pre style="font-size:12px; overflow:auto;">${JSON.stringify(user, null, 2)}</pre>
      <br>
      <strong>Field Analysis:</strong><br>
    `;
    
    
    // Check for taskProgress field
    if (user.taskProgress !== undefined) {
      debugInfo += `<span class="info">taskProgress: ${user.taskProgress}</span><br>`;
    } else {
      debugInfo += `<span class="muted">taskProgress: UNDEFINED</span><br>`;
    }
    
    resultDiv.innerHTML = debugInfo;
    
  } catch (error) {
    resultDiv.innerHTML = `<span class="danger">Exception: ${error.message}</span>`;
  }
}

async function debugAllUsers() {
  const resultDiv = $('#debugResult');
  resultDiv.innerHTML = 'Loading all users data...';
  
  try {
    const r = await safeFetch(API_BASE + '/api/admin/users', { 
      headers: authHeaders(false) 
    });
    
    if (r._error) {
      resultDiv.innerHTML = `<span class="danger">Error: ${r.message}</span>`;
      return;
    }
    
    const users = r.users || [];
    let debugInfo = `
      <strong>Users Analysis (${users.length} users):</strong><br>
    `;
    
    let hasTaskProgress = 0;
    
    users.forEach(user => {
      if (user.taskProgress !== undefined) hasTaskProgress++;
    });
    
    debugInfo += `
      <span class="${hasTaskProgress > 0 ? 'info' : 'muted'}">
        Users with taskProgress: ${hasTaskProgress}/${users.length}
      </span><br>
      <br>
      <strong>Sample User Fields:</strong><br>
    `;
    
    // Show first 3 users as sample
    users.slice(0, 3).forEach(user => {
      debugInfo += `
        ${user.username}: 
        completedTasks=${user.completedTasks !== undefined ? user.completedTasks : 'UNDEFINED'}, 
        taskProgress=${user.taskProgress !== undefined ? user.taskProgress : 'UNDEFINED'}<br>
      `;
    });
    
    resultDiv.innerHTML = debugInfo;
    
  } catch (error) {
    resultDiv.innerHTML = `<span class="danger">Exception: ${error.message}</span>`;
  }
}

  // ========= LOTTERY =========
async function loadLottery() {
  const tb = $('#lotteryTbody');
  tb.innerHTML = '<tr><td colspan="6" class="muted">Loading…</td></tr>';
  
  try {
    const r = await safeFetch(API_BASE + '/api/admin/lottery', {
      headers: authHeaders(false)
    });
    
    if (r._error) {
      tb.innerHTML = '<tr><td colspan="6"><div class="notice">' + r.message + '</div></td></tr>';
      return;
    }
    
    const entries = r.entries || [];
    if (!entries.length) {
      tb.innerHTML = '<tr><td colspan="6" class="muted">No lottery entries yet.</td></tr>';
      return;
    }
    
    tb.innerHTML = '';
    entries.forEach(entry => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><strong>${entry.username || '-'}</strong></td>
        <td>${entry.entriesCount || 0}</td>
        <td>${entry.prize || 'N/A'}</td>
        <td>${entry.status || 'Active'}</td>
        <td>${entry.drawDate ? new Date(entry.drawDate).toLocaleDateString() : 'N/A'}</td>
        <td class="nowrap">
          <button class="btn small" data-action="view" data-id="${entry._id}">
            <i class="fa-solid fa-eye"></i> View
          </button>
        </td>
      `;
      tb.appendChild(tr);
    });
  } catch (error) {
    console.error('Error loading lottery:', error);
    tb.innerHTML = '<tr><td colspan="6"><div class="notice">Error loading lottery data</div></td></tr>';
  }
}

// إضافة مستمع الحدث لزر إعادة التحميل
$('#btnReloadLottery').addEventListener('click', loadLottery);

  
async function loadLotteryList() {
  try {
    const users = await safeFetch(API_BASE + '/api/admin/users'); // تأكد أن هذه الـ API ترجع كل المستخدمين
    const listEl = document.getElementById('lotteryList');
    if (!users || users.length === 0) {
      listEl.textContent = "No users found.";
      return;
    }

    // بناء جدول أو قائمة
    const table = document.createElement('table');
    table.style.width = "100%";
    table.style.borderCollapse = "collapse";
    table.innerHTML = `
      <thead>
        <tr>
          <th style="text-align:left; padding:6px; border-bottom:1px solid rgba(255,215,0,.25)">Username</th>
          <th style="text-align:right; padding:6px; border-bottom:1px solid rgba(255,215,0,.25)">Lottery Entries</th>
        </tr>
      </thead>
      <tbody>
        ${users.map(u => `
          <tr>
            <td style="padding:6px; border-bottom:1px solid rgba(255,215,0,.1)">${u.username}</td>
            <td style="padding:6px; text-align:right; border-bottom:1px solid rgba(255,215,0,.1)">${u.lotteryEntries || 0}</td>
          </tr>
        `).join('')}
      </tbody>
    `;
    listEl.innerHTML = "";
    listEl.appendChild(table);

  } catch(err) {
    console.error(err);
    document.getElementById('lotteryList').textContent = "Failed to load data.";
  }
}



async function testEndpoint() {
  const endpoint = $('#debugEndpoint').value;
  const data = $('#debugData').value;
  const resultDiv = $('#debugEndpointResult');
  resultDiv.innerHTML = 'Testing endpoint...';
  
  try {
    let url = API_BASE + endpoint;
    let options = { headers: authHeaders(true) };
    
    // Replace ID placeholder if needed
    if (endpoint.includes('ID')) {
      const userId = $('#debugUserId').value.trim();
      if (!userId) {
        resultDiv.innerHTML = '<span class="danger">Please enter a User ID first</span>';
        return;
      }
      url = url.replace('ID', userId);
    }
    
    if (data && data.trim() !== '') {
      options.method = 'POST';
      options.body = data;
    } else if (endpoint.startsWith('PUT')) {
      options.method = 'PUT';
      options.body = JSON.stringify({ completedTasks: 5 }); // Default test
    }
    
    const r = await safeFetch(url, options);
    
    let resultHtml = `
      <strong>Endpoint:</strong> ${url}<br>
      <strong>Method:</strong> ${options.method || 'GET'}<br>
      <strong>Status:</strong> ${r._error ? '<span class="danger">ERROR</span>' : '<span class="ok">SUCCESS</span>'}<br>
      <br>
      <strong>Response:</strong><br>
      <pre style="font-size:12px; overflow:auto;">${JSON.stringify(r, null, 2)}</pre>
    `;
    
    resultDiv.innerHTML = resultHtml;
    
  } catch (error) {
    resultDiv.innerHTML = `<span class="danger">Exception: ${error.message}</span>`;
  }
}

// ========= EVENT LISTENERS FOR DEBUG =========
$('#btnDebugUser').addEventListener('click', () => {
  const userId = $('#debugUserId').value.trim();
  if (!userId) {
    $('#debugResult').innerHTML = '<span class="danger">Please enter a User ID</span>';
    return;
  }
  debugUserData(userId);
});

$('#btnDebugAllUsers').addEventListener('click', debugAllUsers);
$('#btnTestEndpoint').addEventListener('click', testEndpoint);

        
  
  // ========= STATS =========
  async function loadStats(){
    const wrap = $('#statsWrap');
    wrap.innerHTML = '';
    const r = await safeFetch(API_BASE + '/api/admin/stats', { headers: authHeaders(false) });
    if (r._error){
      wrap.appendChild(el('div', {class:'notice'}, [r.message]));
      return;
    }
    const items = [
      { label:'Total Users', value: r.totalUsers },
      { label:'Paid Users', value: r.paidUsers },
      { label:'Wheel Spins', value: r.spins },
      { label:'Successful Invites', value: r.successfulInvites },
      { label:'Total Withdrawals', value: r.totalWithdrawals },
      { label:'Pending Withdrawals', value: r.pendingWithdrawals },
      { label:'Total Payments', value: r.totalPayments || 0 },
      { label:'Pending Payments', value: r.pendingPayments || 0 },
    ];
    items.forEach(it=>{
      const card = el('div', {class:'stat'}, [
        el('div', {class:'label'}, [it.label]),
        el('div', {class:'value'}, [String(it.value ?? 0)])
      ]);
      wrap.appendChild(card);
    });
  }
  $('#btnRefreshStats').addEventListener('click', loadStats);

// ========= USERS =========
async function loadUsers(){
  const tb = $('#usersTbody');
  tb.innerHTML = '<tr><td colspan="7" class="muted">Loading…</td></tr>';
  
  const r = await safeFetch(API_BASE + '/api/admin/users', {
    headers: authHeaders(true)
  });

  if (r._error){
    tb.innerHTML = '<tr><td colspan="7"><div class="notice">'+ r.message +'</div></td></tr>';
    return;
  }

  const users = (r.users || r || []);
  if (!users.length){
    tb.innerHTML = '<tr><td colspan="7" class="muted">No users yet.</td></tr>';
    return;
  }

  const q = $('#userSearch').value.trim().toLowerCase();
  const filtered = q ? users.filter(u => {
    const searchText = (u.username || '') + ' ' + (u.email || '') + ' ' + (u.fullName || '');
    return searchText.toLowerCase().includes(q);
  }) : users;

  tb.innerHTML = '';

  filtered.forEach(u => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${u.username || '-'}</strong></td>
      <td>${u.email || '-'}</td>
      <td><input type="number" data-field="balance" data-id="${u._id || u.id}" value="${u.balance || 0}" style="width: 70px;" /></td>
      <td>
        <select data-field="subscriptionType" data-id="${u._id || u.id}">
          <option value="none" ${(u.subscriptionType || 'none') === 'none' ? 'selected' : ''}>None</option>
          <option value="basic" ${(u.subscriptionType || 'none') === 'basic' ? 'selected' : ''}>Basic</option>
          <option value="premium" ${(u.subscriptionType || 'none') === 'premium' ? 'selected' : ''}>Premium</option>
        </select>
      </td>
      <td>${u.createdAt ? new Date(u.createdAt).toLocaleDateString() : '-'}</td>
      <td class="nowrap">
        <button class="btn small" data-action="save" data-id="${u._id || u.id}">
          <i class="fa-solid fa-save"></i> Save
        </button>
      </td>
    `;
    tb.appendChild(tr);
  });

  // إضافة event listeners لأزرار الحفظ
  tb.querySelectorAll('button[data-action="save"]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.dataset.id;
      const balance = Number(tb.querySelector(`input[data-field="balance"][data-id="${id}"]`).value || 0);
      const subscriptionType = tb.querySelector(`select[data-field="subscriptionType"][data-id="${id}"]`).value;
      
      const updateResult = await safeFetch(API_BASE + '/api/admin/users/' + id, {
        method: 'PUT',
        headers: authHeaders(true),
        body: JSON.stringify({ balance, subscriptionType })
      });
      
      if (updateResult._error) {
        alert('Error updating user: ' + updateResult.message);
      } else {
        alert('User updated successfully!');
        loadUsers(); // إعادة تحميل البيانات
      }
    });
  });
}

$('#btnReloadUsers').addEve
