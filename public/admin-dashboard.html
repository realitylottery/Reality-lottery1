<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¯ÙØ¹</title>
  <style>
    /* Ù†ÙØ³ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø³Ø§Ø¨Ù‚ */
  </style>
</head>
<body>
  <h2>ğŸ“‹ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¯ÙØ¹</h2>
  
  <div class="search-box">
    <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ...">
  </div>
  
  <table>
    <thead>
      <tr>
        <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
        <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
        <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
      </tr>
    </thead>
    <tbody id="paymentTable">
      <tr><td colspan="5">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>
    </tbody>
  </table>
  
  <script>
    let allPayments = [];
    
    // Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
    async function loadPayments() {
      try {
        const response = await fetch("https://realitylottery.koyeb.app/api/pending-payments");
        
        if (!response.ok) {
          throw new Error("ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…");
        }
        
        allPayments = await response.json();
        renderTable(allPayments);
      } catch (err) {
        console.error("Error loading payments:", err);
        document.getElementById("paymentTable").innerHTML = `
          <tr>
            <td colspan="5">
              Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${err.message}
              <button onclick="location.reload()">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
            </td>
          </tr>`;
      }
    }
    
    // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    function renderTable(payments) {
      const table = document.getElementById("paymentTable");
      table.innerHTML = "";
      
      if (!payments || payments.length === 0) {
        table.innerHTML = `<tr><td colspan="5">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¯ÙØ¹ Ø­Ø§Ù„ÙŠØ§Ù‹</td></tr>`;
        return;
      }
      
      payments.forEach(payment => {
        const date = new Date(payment.date).toLocaleString("ar-EG");
        const statusColor = payment.status === "pending" ? "orange" : 
                           payment.status === "approved" ? "green" : "red";
        
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${payment.txid || "-"}</td>
          <td>${payment.phone || "-"}</td>
          <td style="color: ${statusColor}; font-weight: bold;">
            ${payment.status || "pending"}
          </td>
          <td>${date}</td>
          <td>
            <button class="approve" onclick="updateStatus('${payment._id}', 'approved')">
              Ù…ÙˆØ§ÙÙ‚Ø©
            </button>
            <button class="reject" onclick="updateStatus('${payment._id}', 'rejected')">
              Ø±ÙØ¶
            </button>
          </td>
        `;
        table.appendChild(row);
      });
    }
    
    // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹
    async function updateStatus(id, status) {
      try {
        const response = await fetch(`https://realitylottery.koyeb.app/api/payment/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ status })
        });
        
        if (!response.ok) {
          throw new Error("ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©");
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
        loadPayments();
        alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­");
      } catch (err) {
        console.error("Error updating status:", err);
        alert(`Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©: ${err.message}`);
      }
    }
    
    // ÙÙ„ØªØ± Ø§Ù„Ø¨Ø­Ø«
    document.getElementById("searchInput").addEventListener("input", function() {
      const query = this.value.toLowerCase();
      const filtered = allPayments.filter(payment => 
        (payment.txid && payment.txid.toLowerCase().includes(query)) ||
        (payment.phone && payment.phone.toLowerCase().includes(query))
      );
      renderTable(filtered);
    });
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    loadPayments();
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
    setInterval(loadPayments, 30000);
  </script>
</body>
</html>
