<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RealityLottery — Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --bg: #000;
            --panel: #0f0f0f;
            --muted: #b9b9b9;
            --gold: #ffd700;
            --gold2: #ffa500;
            --red: #ff5252;
            --green: #23d18b;
            --blue: #4f8ff7;
        }

        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            border-bottom: 2px solid var(--gold);
            background: #111;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .brand {
            font-weight: 800;
            letter-spacing: 1px;
            color: var(--gold);
            font-size: 20px;
        }

        .admin-state {
            font-size: 14px;
            color: var(--muted);
        }

        .wrap {
            display: flex;
            flex: 1;
            min-height: 0;
        }

        aside {
            width: 280px;
            background: var(--panel);
            border-right: 1px solid rgba(255, 215, 0, 0.25);
            padding: 14px;
            overflow: auto;
        }

        main {
            flex: 1;
            padding: 16px;
            overflow: auto;
        }

        .section {
            background: #111;
            border: 1px solid rgba(255, 215, 0, 0.25);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .title {
            font-weight: 700;
            color: var(--gold);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .muted {
            color: var(--muted);
            font-size: 13px;
        }

        .btn {
            background: linear-gradient(45deg, var(--gold), var(--gold2));
            color: #000;
            font-weight: 700;
            border: none;
            border-radius: 8px;
            padding: 10px 14px;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.25);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 14px rgba(255, 215, 0, 0.35);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--gold);
            color: var(--gold);
        }

        .btn-danger {
            background: #2b0000;
            border: 1px solid #900;
            color: #f88;
        }

        .btn-ok {
            background: #092;
            border: 1px solid #0f6;
            color: #eaffea;
        }

        .btn-info {
            background: #004080;
            border: 1px solid #4f8ff7;
            color: #e0f0ff;
        }

        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .col {
            flex: 1 1 240px;
            min-width: 220px;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 215, 0, 0.25);
            background: #0f0f0f;
            color: #fff;
            outline: none;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        label {
            display: block;
            font-size: 13px;
            color: var(--muted);
            margin-bottom: 6px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            overflow: auto;
        }

        th,
        td {
            border-bottom: 1px solid rgba(255, 215, 0, 0.15);
            padding: 10px;
            text-align: right;
            font-size: 14px;
        }

        th {
            color: var(--gold);
        }

        .chip {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 12px;
            border: 1px solid rgba(255, 215, 0, 0.35);
            color: var(--gold);
        }

        .grid {
            display: grid;
            gap: 12px;
        }

        .grid-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        .grid-4 {
            grid-template-columns: repeat(4, minmax(0, 1fr));
        }

        .stat {
            background: #0f0f0f;
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 10px;
            padding: 14px;
        }

        .stat .label {
            color: var(--muted);
            font-size: 12px;
        }

        .stat .value {
            color: #fff;
            font-size: 22px;
            margin-top: 6px;
        }

        .hidden {
            display: none !important;
        }

        .danger {
            color: #ff8b8b
        }

        .ok {
            color: #9effb3
        }

        .info {
            color: #4f8ff7
        }

        .notice {
            background: #141414;
            border: 1px dashed rgba(255, 215, 0, 0.35);
            border-radius: 10px;
            padding: 10px;
            color: var(--muted);
            font-size: 13px;
        }

        .top-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .small {
            font-size: 12px;
        }

        .card {
            border: 1px solid rgba(255, 215, 0, 0.2);
            background: #0e0e0e;
            border-radius: 10px;
            padding: 12px;
        }

        .img-preview {
            width: 100%;
            max-height: 140px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid rgba(255, 215, 0, 0.25);
            background: #000;
        }

        .pill {
            border: 1px solid rgba(255, 215, 0, 0.25);
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            color: var(--muted)
        }

        .divider {
            height: 1px;
            background: rgba(255, 215, 0, 0.2);
            margin: 10px 0;
        }

        footer {
            border-top: 1px solid rgba(255, 215, 0, 0.25);
            padding: 10px 16px;
            color: var(--muted);
            text-align: center;
            background: #111;
        }

        .navbtn {
            width: 100%;
            text-align: right;
            background: transparent;
            border: 1px solid rgba(255, 215, 0, 0.25);
            color: #fff;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }

        .navbtn:hover {
            background: rgba(255, 215, 0, 0.1);
        }

        .navbtn.active {
            border-color: var(--gold);
            color: var(--gold);
            background: #151515;
        }

        .inline {
            display: inline-flex;
            gap: 8px;
            align-items: center;
        }

        .nowrap {
            white-space: nowrap;
        }

        .right {
            margin-left: auto;
        }

        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        .filter-bar {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .filter-select {
            background: #0f0f0f;
            border: 1px solid rgba(255, 215, 0, 0.25);
            color: #fff;
            padding: 6px 10px;
            border-radius: 6px;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 50%;
            border-top-color: var(--gold);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-pending {
            background-color: rgba(255, 165, 0, 0.2);
            color: #ffa500;
        }

        .status-approved {
            background-color: rgba(35, 209, 139, 0.2);
            color: #23d18b;
        }

        .status-rejected {
            background-color: rgba(255, 82, 82, 0.2);
            color: #ff5252;
        }
    </style>
</head>

<body>
    <header>
        <div class="brand"><i class="fa-solid fa-crown"></i> RealityLottery Admin</div>
        <div class="inline">
            <span id="adminState" class="admin-state">لم يتم تسجيل الدخول</span>
            <button id="btnLogout" class="btn btn-outline hidden"><i class="fa-solid fa-right-from-bracket"></i> تسجيل الخروج</button>
        </div>
    </header>

    <div class="wrap">
        <aside>
            <button class="navbtn active" data-tab="tab-login"><i class="fa-solid fa-lock"></i> تسجيل الدخول</button>
            <button class="navbtn" data-tab="tab-stats"><i class="fa-solid fa-chart-line"></i> الإحصائيات</button>
            <button class="navbtn" data-tab="tab-users"><i class="fa-solid fa-users"></i> المستخدمين</button>
            <button class="navbtn" data-tab="tab-payments"><i class="fa-solid fa-credit-card"></i> المدفوعات</button>
            <button class="navbtn" data-tab="tab-withdrawals"><i class="fa-solid fa-wallet"></i> السحوبات</button>
            <button class="navbtn" data-tab="tab-news"><i class="fa-solid fa-newspaper"></i> الأخبار</button>
            <button class="navbtn" data-tab="tab-banners"><i class="fa-solid fa-image"></i> الإعلانات</button>
            <button class="navbtn" data-tab="tab-content"><i class="fa-solid fa-pen-ruler"></i> محتوى الموقع</button>
            <div class="divider"></div>
            <div class="small muted">جميع الإجراءات تتطلب رمز المسؤول.</div>
        </aside>

        <main>
            <!-- LOGIN -->
            <section id="tab-login" class="section">
                <div class="title"><i class="fa-solid fa-lock"></i> تسجيل الدخول للمسؤول</div>
                <div class="row">
                    <div class="col card">
                        <label>اسم المستخدم</label>
                        <input id="adminUser" placeholder="admin" />
                        <label style="margin-top:8px">كلمة المرور</label>
                        <input id="adminPass" type="password" placeholder="كلمة المرور" />
                        <div class="row" style="margin-top:12px">
                            <button class="btn" id="btnLoginAdmin"><i class="fa-solid fa-right-to-bracket"></i> تسجيل الدخول</button>
                            <span id="loginMsg" class="muted"></span>
                        </div>
                        <div class="notice" style="margin-top:12px">
                            الافتراضي (حسب الخادم): <span class="mono">a</span>. Y <span class="mono">ADMIN_USER</span> and <span class="mono">ADMIN_PASS</span>.
                        </div>
                    </div>
                    <div class="col">
                        <div class="notice">
                            يتم تخزين الرمز المميز في <span class="mono">localStorage.rl_admin_token</span> ويتم إرفاقه كـ <span class="mono">Authorization: Bearer &lt;token&gt;</span> لجميع استدعئات واجهة برمجة التطبيقات الخاصة بالمسؤول على نفس الأصل.
                        </div>
                    </div>
                </div>
            </section>

            <!-- STATS -->
            <section id="tab-stats" class="section hidden">
                <div class="title"><i class="fa-solid fa-chart-line"></i> إحصائيات المنصة</div>
                <div id="statsWrap" class="grid grid-4">
                    <!-- سيتم إضافة البطاقات هنا -->
                </div>
                <div class="row" style="margin-top:12px">
                    <button class="btn" id="btnRefreshStats"><i class="fa-solid fa-rotate"></i> تحديث</button>
                    <span class="muted">إذا لم يكن نقطة النهاية جاهزة، فسترى رسالة لطيفة بدلاً من خطأ.</span>
                </div>
            </section>

            <!-- USERS -->
            <section id="tab-users" class="section hidden">
                <div class="title"><i class="fa-solid fa-users"></i> إدارة المستخدمين</div>
                <div class="row top-actions">
                    <input id="userSearch" placeholder="البحث باسم المستخدم أو البريد الإلكتروني..." class="col" />
                    <button class="btn" id="btnReloadUsers"><i class="fa-solid fa-rotate"></i> إعادة تحميل</button>
                    <span class="pill">نصيحة: استخدم الإجراءات المضمنة لتعيين الرصيد والاشتراك وتقدم المهمة.</span>
                </div>
                <div class="row" style="margin-top:12px; overflow:auto">
                    <table>
                        <thead>
                            <tr>
                                <th>اسم المستخدم</th>
                                <th>البريد الإلكتروني</th>
                                <th>الرصيد</th>
                                <th>الاشتراك</th>
                                <th>تقدم المهمة</th>
                                <th class="nowrap">حفظ</th>
                            </tr>
                        </thead>
                        <tbody id="usersTbody">
                            <tr>
                                <td colspan="6" class="muted">جاري التحميل…</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- سيبقى باقي المحتوى مخفياً للاختصار -->

        </main>
    </div>

    <footer>
        <div>© <span id="year"></span> RealityLottery — Admin. جميع الحقوق محفوظة.</div>
    </footer>

    <script>
        // ========= CONFIG =========
        const API_BASE = 'https://realitylottery.koyeb.app';
        const LS_TOKEN = 'rl_admin_token';

        const $ = (q) => document.querySelector(q);
        const $$ = (q) => Array.from(document.querySelectorAll(q));
        const year = new Date().getFullYear();
        $('#year').textContent = year;

        // ========= NAV =========
        $$('.navbtn').forEach(btn => {
            btn.addEventListener('click', () => {
                $$('.navbtn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const tab = btn.dataset.tab;
                $$('main .section').forEach(s => s.classList.add('hidden'));
                document.getElementById(tab).classList.remove('hidden');
            });
        });

        // ========= AUTH =========
        const adminState = $('#adminState');
        const btnLogout = $('#btnLogout');

        function getToken() {
            return localStorage.getItem(LS_TOKEN) || '';
        }

        function setToken(t) {
            if (t) localStorage.setItem(LS_TOKEN, t);
            updateAuthUI();
        }

        function clearToken() {
            localStorage.removeItem(LS_TOKEN);
            updateAuthUI();
        }

        function isSigned() {
            return !!getToken();
        }

        function updateAuthUI() {
            if (isSigned()) {
                adminState.innerHTML = '<span class="ok">تم تسجيل الدخول</span> — تم تخزين الرمز';
                btnLogout.classList.remove('hidden');
            } else {
                adminState.innerHTML = 'لم يتم تسجيل الدخول';
                btnLogout.classList.add('hidden');
            }
        }
        btnLogout.addEventListener('click', () => {
            clearToken();
            info('تم تسجيل الخروج.');
        });

        // ========= HELPERS =========
        function authHeaders(json = true) {
            const h = {
                'Authorization': 'Bearer ' + getToken()
            };
            if (json) h['Content-Type'] = 'application/json';
            return h;
        }

        function info(msg) {
            console.log(msg);
        }

        function humanErr(e) {
            if (e && e.message) return e.message;
            return 'نقطة النهاية غير متاحة بعد';
        }

        async function safeFetch(url, opts = {}) {
            try {
                const res = await fetch(url, opts);
                const ct = res.headers.get('content-type') || '';
                const data = ct.includes('application/json') ? await res.json() : await res.text();
                if (!res.ok) {
                    // Handle 403 Forbidden specifically
                    if (res.status === 403) {
                        return {
                            _error: true,
                            message: 'تم الرفض. يرجى التحقق من صلاحيات المسؤول أو الرمز المميز.'
                        };
                    }
                    throw new Error((data && data.message) ? data.message : ('HTTP ' + res.status));
                }
                return data;
            } catch (e) {
                console.warn('Fetch error', url, e);
                return {
                    _error: true,
                    message: humanErr(e)
                };
            }
        }

        function el(tag, attrs = {}, children = []) {
            const n = document.createElement(tag);
            Object.entries(attrs || {}).forEach(([k, v]) => {
                if (k === 'class') n.className = v;
                else if (k === 'html') n.innerHTML = v;
                else n.setAttribute(k, v);
            });
            (children || []).forEach(c => {
                if (typeof c === 'string') n.appendChild(document.createTextNode(c));
                else if (c) n.appendChild(c);
            });
            return n;
        }

        // ========= LOGIN =========
        $('#btnLoginAdmin').addEventListener('click', async () => {
            const username = $('#adminUser').value.trim();
            const password = $('#adminPass').value.trim();
            $('#loginMsg').textContent = 'جاري تسجيل الدخول…';
            const r = await safeFetch(API_BASE + '/api/admin/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username,
                    password
                })
            });
            if (r._error) {
                $('#loginMsg').innerHTML = '<span class="danger">' + r.message + '</span>';
            } else {
                setToken(r.token);
                $('#loginMsg').innerHTML = '<span class="ok">تم بنجاح</span>';
                // التحميل التلقائي للبيانات بعد تسجيل الدخول الناجح
                loadStats();
                loadUsers();
            }
        });

        // ========= STATS =========
        async function loadStats() {
            const wrap = $('#statsWrap');
            wrap.innerHTML = '';
            const r = await safeFetch(API_BASE + '/api/admin/stats', {
                headers: authHeaders(false)
            });
            if (r._error) {
                wrap.appendChild(el('div', {
                    class: 'notice'
                }, [r.message]));
                return;
            }
            const items = [{
                    label: 'إجمالي المستخدمين',
                    value: r.totalUsers || 0
                },
                {
                    label: 'المستخدمون المدفوعون',
                    value: r.paidUsers || 0
                },
                {
                    label: 'دورات العجلة',
                    value: r.spins || 0
                },
                {
                    label: 'الدعوات الناجحة',
                    value: r.successfulInvites || 0
                },
                {
                    label: 'إجمالي السحوبات',
                    value: r.totalWithdrawals || 0
                },
                {
                    label: 'السحوبات المعلقة',
                    value: r.pendingWithdrawals || 0
                },
                {
                    label: 'إجمالي المدفوعات',
                    value: r.totalPayments || 0
                },
                {
                    label: 'المدفوعات المعلقة',
                    value: r.pendingPayments || 0
                },
            ];
            items.forEach(it => {
                const card = el('div', {
                    class: 'stat'
                }, [
                    el('div', {
                        class: 'label'
                    }, [it.label]),
                    el('div', {
                        class: 'value'
                    }, [String(it.value)])
                ]);
                wrap.appendChild(card);
            });
        }
        $('#btnRefreshStats').addEventListener('click', loadStats);

        // ========= USERS =========
        async function loadUsers() {
            const tb = $('#usersTbody');
            tb.innerHTML = '<tr><td colspan="6" class="muted">جاري التحميل…</td></tr>';
            const r = await safeFetch(API_BASE + '/api/admin/users', {
                headers: authHeaders(false)
            });
            if (r._error) {
                tb.innerHTML = '<tr><td colspan="6"><div class="notice">' + r.message + '</div></td></tr>';
                return;
            }
            const users = (r.users || []);
            if (!users.length) {
                tb.innerHTML = '<tr><td colspan="6" class="muted">لا يوجد مستخدمون بعد.</td></tr>';
                return;
            }
            const q = $('#userSearch').value.trim().toLowerCase();
            const filtered = q ? users.filter(u => {
                const x = (u.username || '') + ' ' + (u.email || '');
                return x.toLowerCase().includes(q);
            }) : users;

            tb.innerHTML = '';
            filtered.forEach(u => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div><strong>${u.username || '-'}</strong></div>
                        <div class="small muted mono">${u._id || ''}</div>
                    </td>
                    <td>${u.email || '-'}</td>
                    <td>
                        <input data-field="balance" data-id="${u._id}" value="${Number(u.balance || 0)}" />
                    </td>
                    <td>
                        <select data-field="subscriptionType" data-id="${u._id}">
                            <option value="">لا شيء</option>
                            <option value="BASIC" ${u.subscriptionType==='BASIC' ? ' selected' : ''}>BASIC</option>
                            <option value="PRO" ${u.subscriptionType==='PRO' ? ' selected' : ''}>PRO</option>
                            <option value="VIP" ${u.subscriptionType==='VIP' ? ' selected' : ''}>VIP</option>
                        </select>
                    </td>
                    <td>
                        <select data-field="taskProgress" data-id="${u._id}">
                            ${[0,1,2,3,4,5,6].map(n => `<option value="${n}" ${Number(u.taskProgress || 0)===n ? ' selected' : ''}>${n}/6</option>`).join('')}
                        </select>
                    </td>
                    <td class="nowrap">
                        <button class="btn small" data-action="save" data-id="${u._id}"><i class="fa-solid fa-floppy-disk"></i> حفظ</button>
                    </td>
                `;
                tb.appendChild(tr);
            });

            tb.querySelectorAll('button[data-action="save"]').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.dataset.id;
                    const balance = Number(tb.querySelector(`input[data-field="balance"][data-id="${id}"]`).value || 0);
                    const subscriptionType = tb.querySelector(`select[data-field="subscriptionType"][data-id="${id}"]`).value;
                    const taskProgress = Number(tb.querySelector(`select[data-field="taskProgress"][data-id="${id}"]`).value || 0);

                    btn.disabled = true;
                    btn.textContent = 'جاري الحفظ…';
                    const r = await safeFetch(API_BASE + '/api/admin/users/' + id, {
                        method: 'PUT',
                        headers: authHeaders(true),
                        body: JSON.stringify({
                            balance,
                            subscriptionType,
                            taskProgress
                        })
                    });
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> حفظ';
                    if (r._error) {
                        alert('فشل التحديث: ' + r.message);
                    } else {
                        alert('تم الحفظ!');
                    }
                });
            });
        }
        $('#btnReloadUsers').addEventListener('click', loadUsers);
        $('#userSearch').addEventListener('input', loadUsers);

        // ========= INIT =========
        updateAuthUI();

        // التحميل التلقائي بعد تسجيل الدخول إذا كان الرمز موجودًا
        if (isSigned()) {
            loadStats();
            loadUsers();
        }

        // إذا انتقل المسؤول إلى علامات التبويب أثناء عدم تسجيل الدخول، نحافظ على واجهة المستخدم صديقة
        document.addEventListener('click', (e) => {
            const tab = e.target.closest('.navbtn')?.dataset?.tab || '';
            const needAuthTabs = ['tab-stats', 'tab-users', 'tab-payments', 'tab-withdrawals', 'tab-news', 'tab-banners', 'tab-content'];
            if (tab && needAuthTabs.includes(tab) && !isSigned()) {
                setTimeout(() => {
                    alert('يرجى تسجيل الدخول كمسؤول أولاً.');
                }, 0);
            }
        });
    </script>
</body>
</html>
