<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RealityLottery — Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    :root{
      --bg:#0a0a0a;
      --panel:#121212;
      --muted:#9f9f9f;
      --gold:#ffd700;
      --gold-2:#ffb400;
      --red:#ff4d4f;
      --green:#2ecc71;
      --amber:#f1c40f;
      --card:#121212;
      --border:rgba(255,215,0,.2);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:#fff; display:flex; flex-direction:column;
    }

    /* Top Bar */
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 18px; background:#111; border-bottom:2px solid var(--gold);
      position:sticky; top:0; z-index:20;
    }
    .brand{font-weight:800; letter-spacing:.5px; color:var(--gold); font-size:20px}
    .top-actions{display:flex; align-items:center; gap:10px}
    .pill{
      padding:8px 12px; border:1px solid var(--border); border-radius:999px; color:#fff;
      background:linear-gradient(180deg,#151515,#0d0d0d);
      display:flex; align-items:center; gap:8px; font-size:14px
    }
    .btn{
      background:linear-gradient(45deg,var(--gold),var(--gold-2));
      color:#000; border:none; padding:10px 14px; border-radius:10px; font-weight:700;
      cursor:pointer; transition:.15s transform; box-shadow:0 6px 18px rgba(255,215,0,.15)
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.secondary{background:#1a1a1a;color:#fff;border:1px solid var(--border);box-shadow:none}
    .btn.danger{background:linear-gradient(45deg,#ff9b9b,#ff4d4f); color:#000}
    .btn.success{background:linear-gradient(45deg,#b2ffcf,#2ecc71); color:#000}
    .btn.warning{background:linear-gradient(45deg,#fff0b3,#f1c40f); color:#000}

    /* Layout */
    .wrap{display:flex; min-height:calc(100% - 62px)}
    .sidebar{
      width:260px; background:#0f0f0f; border-right:1px solid var(--border);
      padding:16px; position:sticky; top:62px; height:calc(100vh - 62px); overflow:auto;
    }
    .nav-link{
      display:flex; align-items:center; gap:10px; padding:12px 10px; margin-bottom:6px;
      color:#ddd; text-decoration:none; border-radius:10px; border:1px solid transparent;
    }
    .nav-link:hover{background:#121212;border-color:var(--border)}
    .nav-link.active{background:#151515;border-color:var(--gold); color:#fff}
    .content{flex:1; padding:20px; display:flex; flex-direction:column; gap:18px}

    /* Cards / grids */
    .grid{display:grid; gap:16px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    @media (max-width:1100px){.grid.cols-4{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:800px){.grid.cols-3,.grid.cols-2,.grid.cols-4{grid-template-columns:1fr}.sidebar{position:static;width:100%;height:auto}}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px;
    }
    .card h3{margin:0 0 8px 0; color:var(--gold)}
    .muted{color:var(--muted); font-size:13px}

    /* Tables */
    table{width:100%; border-collapse:separate; border-spacing:0 8px}
    thead th{font-size:13px; color:var(--muted); font-weight:600; text-align:left; padding:6px 10px}
    tbody td{background:#111; border:1px solid var(--border); border-left:none; border-right:none; padding:10px; font-size:14px}
    tbody tr{border-radius:10px; overflow:hidden}
    tbody td:first-child{border-left:1px solid var(--border); border-radius:10px 0 0 10px}
    tbody td:last-child{border-right:1px solid var(--border); border-radius:0 10px 10px 0}
    .tag{display:inline-flex; align-items:center; gap:6px; padding:5px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); color:#eee; background:#141414}

    /* Forms */
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .row-3{display:grid; grid-template-columns:repeat(3,1fr); gap:12px}
    .field{display:flex; flex-direction:column; gap:6px}
    .field label{font-size:13px; color:#ddd}
    .field input,.field select,.field textarea{
      background:#0f0f0f; color:#fff; border:1px solid var(--border); padding:10px 12px; border-radius:10px; outline:none
    }
    .field textarea{min-height:120px; resize:vertical}
    .hr{height:1px; background:var(--border); margin:6px 0 14px}

    /* Login gate */
    #loginGate{max-width:420px; margin:60px auto; text-align:center}
    #loginGate .logo{font-size:32px; color:var(--gold); font-weight:800; margin-bottom:10px}
    .error{color:#ff9b9b; font-size:13px}
    .success{color:#b2ffcf; font-size:13px}
    .right{display:flex; gap:10px; justify-content:flex-end}
    .stack{display:flex; flex-direction:column; gap:10px}
    .empty{padding:18px; border:1px dashed var(--border); border-radius:12px; text-align:center; color:var(--muted)}
    .toolbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .inline{display:flex; align-items:center; gap:8px}
  </style>
</head>
<body>
  <!-- Top bar -->
  <div class="topbar">
    <div class="brand"><i class="fa-solid fa-crown"></i> RealityLottery — Admin</div>
    <div class="top-actions">
      <div class="pill"><i class="fa-solid fa-user-shield"></i> <span id="adminName">Not signed in</span></div>
      <button class="btn secondary" id="logoutBtn" title="Log out" style="display:none"><i class="fa-solid fa-right-from-bracket"></i></button>
    </div>
  </div>

  <!-- Login gate -->
  <div id="loginGate" class="content" style="max-width:640px">
    <div class="card">
      <div class="logo"><i class="fa-solid fa-crown"></i></div>
      <h2>Admin Sign in</h2>
      <p class="muted">Use the admin credentials configured on the server.</p>
      <div class="hr"></div>
      <div class="stack">
        <div class="field">
          <label>Username</label>
          <input id="adminUser" placeholder="admin" autocomplete="username">
        </div>
        <div class="field">
          <label>Password</label>
          <input id="adminPass" type="password" placeholder="••••••••" autocomplete="current-password">
        </div>
        <button class="btn" id="adminLoginBtn"><i class="fa-solid fa-right-to-bracket"></i> Sign in</button>
        <div id="loginMsg" class="muted"></div>
      </div>
    </div>
  </div>

  <!-- App -->
  <div class="wrap" id="app" style="display:none">
    <aside class="sidebar">
      <a href="#overview" class="nav-link active"><i class="fa-solid fa-gauge"></i> Overview</a>
      <a href="#users" class="nav-link"><i class="fa-solid fa-users"></i> Users</a>
      <a href="#withdrawals" class="nav-link"><i class="fa-solid fa-money-bill-transfer"></i> Withdrawals</a>
      <a href="#news" class="nav-link"><i class="fa-solid fa-newspaper"></i> News</a>
      <a href="#content" class="nav-link"><i class="fa-solid fa-pen-to-square"></i> Site Content</a>
    </aside>

    <main class="content">
      <!-- OVERVIEW -->
      <section id="panel-overview" class="panel">
        <div class="grid cols-4">
          <div class="card">
            <h3>Total Users</h3>
            <div class="hr"></div>
            <div style="font-size:28px;font-weight:800" id="stat-users">—</div>
            <div class="muted">Registered accounts</div>
          </div>
          <div class="card">
            <h3>Paid Users</h3>
            <div class="hr"></div>
            <div style="font-size:28px;font-weight:800" id="stat-paid">—</div>
            <div class="muted">Users with active subscription</div>
          </div>
          <div class="card">
            <h3>Pending Withdrawals</h3>
            <div class="hr"></div>
            <div style="font-size:28px;font-weight:800" id="stat-wd-pending">—</div>
            <div class="muted">Awaiting approval</div>
          </div>
          <div class="card">
            <h3>News Posts</h3>
            <div class="hr"></div>
            <div style="font-size:28px;font-weight:800" id="stat-news">—</div>
            <div class="muted">Published items</div>
          </div>
        </div>
      </section>

      <!-- USERS -->
      <section id="panel-users" class="panel" style="display:none">
        <div class="card">
          <div class="toolbar">
            <h3 style="margin:0">Users</h3>
            <span class="muted">Edit balances, subscription, and task progress.</span>
            <div style="flex:1"></div>
            <div class="inline">
              <input id="usersSearch" placeholder="Search by username/email..." />
              <button class="btn secondary" id="reloadUsers"><i class="fa-solid fa-rotate"></i></button>
            </div>
          </div>
          <div class="hr"></div>
          <div id="usersWrap" class="empty">Loading users…</div>
        </div>
      </section>

      <!-- WITHDRAWALS -->
      <section id="panel-withdrawals" class="panel" style="display:none">
        <div class="card">
          <div class="toolbar">
            <h3 style="margin:0">Withdrawals</h3>
            <span class="muted">Review and approve or reject requests.</span>
            <div style="flex:1"></div>
            <button class="btn secondary" id="reloadWD"><i class="fa-solid fa-rotate"></i></button>
          </div>
          <div class="hr"></div>
          <div id="wdWrap" class="empty">Loading…</div>
        </div>
      </section>

      <!-- NEWS -->
      <section id="panel-news" class="panel" style="display:none">
        <div class="grid cols-2">
          <div class="card">
            <h3>Create / Update News</h3>
            <div class="hr"></div>
            <div class="row">
              <div class="field">
                <label>Title</label>
                <input id="newsTitle" placeholder="Title">
              </div>
              <div class="field">
                <label>Image URL</label>
                <input id="newsImage" placeholder="https://…">
              </div>
            </div>
            <div class="field">
              <label>Text</label>
              <textarea id="newsText" placeholder="Content…"></textarea>
            </div>
            <div class="row">
              <div class="field">
                <label>Button Label</label>
                <input id="newsBtnLabel" placeholder="Learn more">
              </div>
              <div class="field">
                <label>Button Link</label>
                <input id="newsBtnUrl" placeholder="https://…">
              </div>
            </div>
            <div class="right">
              <button class="btn" id="createNews"><i class="fa-solid fa-plus"></i> Publish</button>
              <button class="btn secondary" id="resetNews"><i class="fa-solid fa-eraser"></i> Clear</button>
            </div>
          </div>
          <div class="card">
            <h3>All News</h3>
            <div class="hr"></div>
            <div id="newsList" class="empty">No news yet.</div>
          </div>
        </div>
      </section>

      <!-- CONTENT (home) -->
      <section id="panel-content" class="panel" style="display:none">
        <div class="card">
          <h3>Homepage Content</h3>
          <div class="hr"></div>
          <div class="row">
            <div class="field">
              <label>Hero Title</label>
              <input id="c_heroTitle" placeholder="Welcome to RealityLottery">
            </div>
            <div class="field">
              <label>Main Button Text</label>
              <input id="c_mainButton" placeholder="Get Started">
            </div>
          </div>
          <div class="field">
            <label>Hero Subtitle</label>
            <textarea id="c_heroSubtitle" placeholder="Subtitle…"></textarea>
          </div>
          <div class="row">
            <div class="field">
              <label>Hero Image URL</label>
              <input id="c_heroImage" placeholder="/media/hero.png">
            </div>
            <div class="field">
              <label>About Image URL</label>
              <input id="c_aboutImage" placeholder="/media/about.png">
            </div>
          </div>
          <div class="field">
            <label>About Text</label>
            <textarea id="c_aboutText" placeholder="About…"></textarea>
          </div>
          <div class="row-3">
            <div class="field">
              <label>Slide 1 Image URL</label>
              <input id="c_slide1Url" placeholder="https://…">
            </div>
            <div class="field">
              <label>Slide 1 Title</label>
              <input id="c_slide1Title" placeholder="Title">
            </div>
            <div class="field">
              <label>Partners (JSON array)</label>
              <input id="c_partners" placeholder='[{"name":"X","logo":"https://…"}]'>
            </div>
          </div>
          <div class="row-3">
            <div class="field">
              <label>Slide 2 Image URL</label>
              <input id="c_slide2Url" placeholder="https://…">
            </div>
            <div class="field">
              <label>Slide 2 Title</label>
              <input id="c_slide2Title" placeholder="Title">
            </div>
            <div class="field">
              <label>Countries (JSON array)</label>
              <input id="c_countries" placeholder='[{"code":"US","participants":120}]'>
            </div>
          </div>
          <div class="right">
            <button class="btn" id="saveContent"><i class="fa-solid fa-floppy-disk"></i> Save</button>
            <button class="btn secondary" id="reloadContent"><i class="fa-solid fa-rotate"></i> Reload</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ===== CONFIG =====
    const API_BASE = 'https://realitylottery.koyeb.app';
    const LS_ADMIN_TOKEN = 'rl_admin_token';
    const qs = (s, p=document)=>p.querySelector(s);
    const qsa = (s, p=document)=>[...p.querySelectorAll(s)];

    // ===== Auth State =====
    const state = {
      token: localStorage.getItem(LS_ADMIN_TOKEN) || null,
      users: [],
      withdrawals: [],
      news: [],
      content: {},
    };

    function setLoggedInUI(name){
      qs('#adminName').textContent = name || 'Admin';
      qs('#logoutBtn').style.display = 'inline-flex';
      qs('#loginGate').style.display = 'none';
      qs('#app').style.display = 'flex';
    }
    function setLoggedOutUI(){
      qs('#adminName').textContent = 'Not signed in';
      qs('#logoutBtn').style.display = 'none';
      qs('#loginGate').style.display = 'block';
      qs('#app').style.display = 'none';
    }

    // ===== Helpers =====
    async function api(path, opts={}){
      const headers = Object.assign(
        { 'Content-Type':'application/json' },
        opts.headers || {}
      );
      if(state.token) headers['Authorization'] = 'Bearer ' + state.token;
      const res = await fetch(API_BASE + path, { ...opts, headers });
      if(!res.ok){
        const txt = await res.text().catch(()=> '');
        throw new Error(`HTTP ${res.status} — ${txt || res.statusText}`);
      }
      const ct = res.headers.get('content-type')||'';
      return ct.includes('application/json') ? res.json() : res.text();
    }
    function fmtMoney(n){ return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}) }
    function toast(el, msg, ok=false){ el.textContent = msg; el.className = ok?'success':'error'; setTimeout(()=>{ el.textContent=''; el.className='muted'; }, 3500); }

    // ===== Navigation =====
    function switchPanel(hash){
      qsa('.nav-link').forEach(a=>a.classList.toggle('active', a.getAttribute('href')===hash));
      qsa('.panel').forEach(p=>p.style.display='none');
      const id = hash.replace('#','panel-') || 'panel-overview';
      const el = qs('#'+(id || 'panel-overview'));
      (el||qs('#panel-overview')).style.display = 'block';
    }
    window.addEventListener('hashchange', ()=> switchPanel(location.hash || '#overview'));

    // ===== Login =====
    qs('#adminLoginBtn').addEventListener('click', async ()=>{
      const u = qs('#adminUser').value.trim();
      const p = qs('#adminPass').value;
      const msg = qs('#loginMsg');
      msg.textContent = 'Signing in…';
      try{
        const r = await api('/api/admin/login', {
          method:'POST',
          body: JSON.stringify({ username:u, password:p })
        });
        state.token = r.token;
        localStorage.setItem(LS_ADMIN_TOKEN, state.token);
        setLoggedInUI(u);
        await Promise.all([loadUsers(), loadWithdrawals(), loadNews(), loadContent(), paintOverview()]);
        switchPanel('#overview');
        msg.textContent = '';
      }catch(e){
        toast(msg, e.message);
      }
    });
    qs('#logoutBtn').addEventListener('click', ()=>{
      localStorage.removeItem(LS_ADMIN_TOKEN);
      state.token = null;
      setLoggedOutUI();
    });

    // ===== Overview =====
    async function paintOverview(){
      qs('#stat-users').textContent = state.users.length;
      const paid = state.users.filter(x=> (x.subscription && x.subscription!=='none') || x.isPaid).length;
      qs('#stat-paid').textContent = paid;
      qs('#stat-wd-pending').textContent = state.withdrawals.filter(w=>w.status==='pending').length;
      qs('#stat-news').textContent = state.news.length;
    }

    // ===== Users =====
    async function loadUsers(){
      const r = await api('/api/admin/users');
      state.users = r.users || [];
      renderUsers();
      paintOverview();
    }
    function renderUsers(){
      const wrap = qs('#usersWrap');
      if(!state.users.length){ wrap.className='empty'; wrap.textContent='No users'; return; }
      wrap.className='';
      const q = qs('#usersSearch').value?.toLowerCase()||'';
      const list = state.users.filter(u=>{
        return !q || (u.username?.toLowerCase().includes(q) || u.email?.toLowerCase().includes(q));
      });
      wrap.innerHTML = `
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>User</th><th>Email</th><th>Balance</th><th>Subscription</th><th>Task Progress</th><th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${list.map(u=>`
                <tr>
                  <td>
                    <div style="font-weight:700">${u.username||'-'}</div>
                    <div class="muted" style="font-size:12px">${u.fullName||''}</div>
                    <div class="tag" style="margin-top:6px"><i class="fa-regular fa-clock"></i> ${new Date(u.registeredAt||u.createdAt||Date.now()).toLocaleString()}</div>
                  </td>
                  <td>${u.email||'-'}</td>
                  <td style="min-width:180px">
                    <div class="inline">
                      <input type="number" step="0.01" value="${Number(u.balance||0)}" id="bal-${u._id}" style="max-width:120px">
                      <span class="muted">$</span>
                    </div>
                  </td>
                  <td>
                    <select id="sub-${u._id}">
                      ${['none','basic','silver','gold','vip'].map(s=>`<option ${String(u.subscription||'none')===s?'selected':''} value="${s}">${s.toUpperCase()}</option>`).join('')}
                    </select>
                  </td>
                  <td>
                    <div class="inline">
                      <input id="task-${u._id}" type="number" min="0" max="6" value="${Number(u.taskProgress||0)}" style="width:90px">
                      <span class="muted">/ 6</span>
                    </div>
                  </td>
                  <td>
                    <div class="inline">
                      <button class="btn success" onclick="saveUser('${u._id}')"><i class="fa-solid fa-floppy-disk"></i></button>
                      <button class="btn secondary" onclick="impersonate('${u._id}','${u.username||''}')"><i class="fa-solid fa-user-secret"></i></button>
                    </div>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>`;
    }
    window.saveUser = async function(id){
      const balance = parseFloat(qs('#bal-'+id).value||'0');
      const subscription = qs('#sub-'+id).value;
      const taskProgress = parseInt(qs('#task-'+id).value||'0',10);
      try{
        await api('/api/admin/users/'+id, {
          method:'PATCH',
          body: JSON.stringify({ balance, subscription, taskProgress })
        });
        await loadUsers();
      }catch(e){ alert(e.message); }
    }
    window.impersonate = function(id, username){
      alert(`(Mock) Impersonate ${username} — Add a real token endpoint on the server if you want one.`);
    }
    qs('#reloadUsers').addEventListener('click', loadUsers);
    qs('#usersSearch').addEventListener('input', renderUsers);

    // ===== Withdrawals =====
    async function loadWithdrawals(){
      const r = await api('/api/admin/withdrawals'); // expected: {items:[{_id,user,amount,address,status,createdAt}]}
      state.withdrawals = r.items || [];
      renderWithdrawals();
      paintOverview();
    }
    function renderWithdrawals(){
      const wrap = qs('#wdWrap');
      if(!state.withdrawals.length){ wrap.className='empty'; wrap.textContent='No withdrawal requests'; return; }
      wrap.className='';
      wrap.innerHTML = `
        <div style="overflow:auto">
          <table>
            <thead>
              <tr><th>User</th><th>Amount</th><th>Wallet</th><th>Status</th><th>Requested</th><th>Actions</th></tr>
            </thead>
            <tbody>
              ${state.withdrawals.map(w=>`
                <tr>
                  <td>
                    <div style="font-weight:700">${w.user?.username||'-'}</div>
                    <div class="muted" style="font-size:12px">${w.user?.email||''}</div>
                  </td>
                  <td>$ ${fmtMoney(w.amount)}</td>
                  <td><code>${w.address||'-'}</code></td>
                  <td>
                    <span class="tag"><i class="fa-solid fa-circle-${w.status==='approved'?'check':(w.status==='rejected'?'xmark':'dot')}"></i> ${String(w.status||'pending').toUpperCase()}</span>
                  </td>
                  <td>${new Date(w.createdAt||Date.now()).toLocaleString()}</td>
                  <td>
                    <div class="inline">
                      <button class="btn success" ${w.status!=='pending'?'disabled':''} onclick="approveWD('${w._id}')"><i class="fa-solid fa-check"></i></button>
                      <button class="btn danger" ${w.status!=='pending'?'disabled':''} onclick="rejectWD('${w._id}')"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>`;
    }
    window.approveWD = async function(id){
      try{
        await api('/api/admin/withdrawals/'+id, { method:'PATCH', body: JSON.stringify({ status:'approved' }) });
        await loadWithdrawals();
      }catch(e){ alert(e.message); }
    }
    window.rejectWD = async function(id){
      try{
        await api('/api/admin/withdrawals/'+id, { method:'PATCH', body: JSON.stringify({ status:'rejected' }) });
        await loadWithdrawals();
      }catch(e){ alert(e.message); }
    }
    qs('#reloadWD').addEventListener('click', loadWithdrawals);

    // ===== News =====
    function clearNewsForm(){
      qs('#newsTitle').value='';
      qs('#newsImage').value='';
      qs('#newsText').value='';
      qs('#newsBtnLabel').value='';
      qs('#newsBtnUrl').value='';
    }
    qs('#resetNews').addEventListener('click', clearNewsForm);

    async function loadNews(){
      const r = await api('/api/news'); // expected: {items:[{_id,title,text,image,buttonLabel,buttonUrl,createdAt}]}
      state.news = r.items || [];
      renderNews();
      paintOverview();
    }
    function renderNews(){
      const box = qs('#newsList');
      if(!state.news.length){ box.className='empty'; box.textContent='No news published yet.'; return; }
      box.className='';
      box.innerHTML = `
        <div class="grid cols-2">
          ${state.news.map(n=>`
            <div class="card">
              <div style="display:flex; gap:14px">
                <img src="${n.image||''}" alt="" style="width:96px;height:96px;object-fit:cover;border-radius:10px;border:1px solid var(--border)">
                <div style="flex:1">
                  <div style="font-weight:800;color:var(--gold);font-size:16px">${n.title||'-'}</div>
                  <div class="muted" style="margin:6px 0 10px">${n.text||''}</div>
                  <div class="inline" style="gap:12px;flex-wrap:wrap">
                    ${n.buttonLabel?`<a class="btn" href="${n.buttonUrl||'#'}" target="_blank" rel="noopener">${n.buttonLabel}</a>`:''}
                    <button class="btn secondary" onclick='editNews(${JSON.stringify(n)})'><i class="fa-solid fa-pen"></i> Edit</button>
                    <button class="btn danger" onclick="deleteNews('${n._id}')"><i class="fa-solid fa-trash"></i> Delete</button>
                  </div>
                </div>
              </div>
              <div class="hr"></div>
              <div class="muted">Published: ${new Date(n.createdAt||Date.now()).toLocaleString()}</div>
            </div>
          `).join('')}
        </div>
      `;
    }
    window.editNews = function(n){
      qs('#newsTitle').value = n.title||'';
      qs('#newsImage').value = n.image||'';
      qs('#newsText').value = n.text||'';
      qs('#newsBtnLabel').value = n.buttonLabel||'';
      qs('#newsBtnUrl').value = n.buttonUrl||'';
      qs('#createNews').dataset.editId = n._id;
      qs('#createNews').textContent = 'Update';
    }
    window.deleteNews = async function(id){
      if(!confirm('Delete this news item?')) return;
      try{
        await api('/api/admin/news/'+id, { method:'DELETE' });
        await loadNews();
      }catch(e){ alert(e.message); }
    }
    qs('#createNews').addEventListener('click', async ()=>{
      const payload = {
        title: qs('#newsTitle').value.trim(),
        image: qs('#newsImage').value.trim(),
        text: qs('#newsText').value.trim(),
        buttonLabel: qs('#newsBtnLabel').value.trim(),
        buttonUrl: qs('#newsBtnUrl').value.trim(),
      };
      try{
        const editId = qs('#createNews').dataset.editId;
        if(editId){
          await api('/api/admin/news/'+editId, { method:'PUT', body: JSON.stringify(payload) });
          qs('#createNews').textContent = 'Publish';
          delete qs('#createNews').dataset.editId;
        }else{
          await api('/api/admin/news', { method:'POST', body: JSON.stringify(payload) });
        }
        clearNewsForm();
        await loadNews();
      }catch(e){ alert(e.message); }
    });

    // ===== Content =====
    async function loadContent(){
      const r = await api('/api/content'); // expected: JSON blob of fields
      state.content = r || {};
      // paint form
      const set = (id,val)=>{ const el=qs('#'+id); if(el) el.value = val || '' }
      set('c_heroTitle', r.heroTitle);
      set('c_mainButton', r.mainButton);
      set('c_heroSubtitle', r.heroSubtitle);
      set('c_heroImage', r.heroImage);
      set('c_aboutImage', r.aboutImage);
      set('c_aboutText', r.aboutText);
      set('c_slide1Url', r.slide1Url);
      set('c_slide1Title', r.slide1Title);
      set('c_slide2Url', r.slide2Url);
      set('c_slide2Title', r.slide2Title);
      set('c_partners', typeof r.partners==='string'? r.partners : JSON.stringify(r.partners||[]));
      set('c_countries', typeof r.countries==='string'? r.countries : JSON.stringify(r.countries||[]));
    }
    async function saveContent(){
      const payload = {
        heroTitle: qs('#c_heroTitle').value.trim(),
        mainButton: qs('#c_mainButton').value.trim(),
        heroSubtitle: qs('#c_heroSubtitle').value.trim(),
        heroImage: qs('#c_heroImage').value.trim(),
        aboutImage: qs('#c_aboutImage').value.trim(),
        aboutText: qs('#c_aboutText').value.trim(),
        slide1Url: qs('#c_slide1Url').value.trim(),
        slide1Title: qs('#c_slide1Title').value.trim(),
        slide2Url: qs('#c_slide2Url').value.trim(),
        slide2Title: qs('#c_slide2Title').value.trim(),
        partners: qs('#c_partners').value.trim(),
        countries: qs('#c_countries').value.trim(),
      };
      try{
        await api('/api/admin/content', { method:'PUT', body: JSON.stringify(payload) });
        alert('Content saved.');
      }catch(e){ alert(e.message); }
    }
    qs('#saveContent').addEventListener('click', saveContent);
    qs('#reloadContent').addEventListener('click', loadContent);

    // ===== Boot =====
    qsa('.sidebar .nav-link').forEach(a=>{
      a.addEventListener('click', (e)=>{
        qsa('.nav-link').forEach(x=>x.classList.remove('active'));
        a.classList.add('active');
        switchPanel(a.getAttribute('href'));
      });
    });

    (async function init(){
      switchPanel(location.hash || '#overview');
      if(state.token){
        setLoggedInUI('Admin');
        try{
          await Promise.all([loadUsers(), loadWithdrawals(), loadNews(), loadContent(), paintOverview()]);
        }catch(e){
          // If token invalid
          console.error(e);
          localStorage.removeItem(LS_ADMIN_TOKEN);
          state.token = null;
          setLoggedOutUI();
        }
      }else{
        setLoggedOutUI();
      }
    })();
  </script>
</body>
</html>
