<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lucky Wheel - RealityLottery</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    :root {
      --primary-color: #ffd700;
      --secondary-color: #ffa500;
      --dark-bg: #000;
      --text-light: #eee;
      --success-color: #2ed573;
      --error-color: #ff4757;
      --section-1: #e74c3c;
      --section-2: #2ecc71;
      --section-3: #3498db;
      --section-4: #f1c40f;
      --section-5: #9b59b6;
      --section-6: #1abc9c;
    }
    body { background:#111; color:var(--text-light); font-family:Arial,sans-serif; padding:20px; padding-top:70px; }
    .home-btn { position:fixed; top:20px; left:20px; background:var(--primary-color); color:#000; width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:20px; z-index:100; }
    .container { max-width:700px; margin:0 auto; display:flex; flex-direction:column; align-items:center; gap:20px; }
    header { width:100%; text-align:center; font-size:24px; font-weight:bold; color:var(--primary-color); margin-bottom:20px; }
    .wheel-container { position:relative; width:320px; height:320px; border-radius:50%; overflow:hidden; border:10px solid #222; margin-bottom:15px; }
    .wheel { width:100%; height:100%; border-radius:50%; position:relative; transition: transform 5s cubic-bezier(0.17, 0.67, 0.21, 0.99); }
    .wheel-section-item { position:absolute; width:50%; height:50%; transform-origin:100% 100%; left:0; top:0; display:flex; align-items:center; justify-content:center; font-weight:bold; text-shadow:1px 1px 3px rgba(0,0,0,0.7); font-size:16px; color:#fff; }
    .section-1 { transform: rotate(0deg);   background: var(--section-1); }
    .section-2 { transform: rotate(60deg);  background: var(--section-2); }
    .section-3 { transform: rotate(120deg); background: var(--section-3); }
    .section-4 { transform: rotate(180deg); background: var(--section-4); }
    .section-5 { transform: rotate(240deg); background: var(--section-5); }
    .section-6 { transform: rotate(300deg); background: var(--section-6); }
    .center-circle { position:absolute; width:60px; height:60px; background:var(--primary-color); border-radius:50%; top:50%; left:50%; transform:translate(-50%,-50%); display:flex; align-items:center; justify-content:center; color:#000; font-weight:bold; font-size:14px; cursor:pointer; z-index:10; }
    .pointer { position:absolute; top:-30px; left:50%; transform:translateX(-50%); width:0; height:0; border-left:20px solid transparent; border-right:20px solid transparent; border-bottom:35px solid var(--primary-color); z-index:20; }
    .spin-btn { background:linear-gradient(to bottom,var(--primary-color),var(--secondary-color)); color:#000; padding:15px 30px; font-size:18px; font-weight:bold; border-radius:50px; border:none; cursor:pointer; margin-bottom:10px; }
    .spin-btn:disabled { background:#444; color:#999; cursor:not-allowed; }
    .result { font-size:20px; font-weight:bold; text-align:center; min-height:35px; margin-top:10px; }
    .user-info { background:rgba(255,215,0,0.1); padding:12px; border-radius:10px; font-size:14px; }
  </style>
</head>
<body>

<a href="index.html" class="home-btn"><i class="fas fa-home"></i></a>

<div class="container">
  <header><i class="fas fa-star"></i> Lucky Wheel <i class="fas fa-star"></i></header>

  <div class="wheel-container">
    <div class="wheel" id="wheel">
      <div class="wheel-section-item section-1" data-prize="$3" data-type="money" data-amount="3">$3</div>
      <div class="wheel-section-item section-2" data-prize="$2" data-type="money" data-amount="2">$2</div>
      <div class="wheel-section-item section-3" data-prize="$1" data-type="money" data-amount="1">$1</div>
      <div class="wheel-section-item section-4" data-prize="lose" data-type="lose" data-amount="0">Better Luck</div>
      <div class="wheel-section-item section-5" data-prize="lose" data-type="lose" data-amount="0">Better Luck</div>
      <div class="wheel-section-item section-6" data-prize="extra" data-type="extra" data-amount="0">Extra Spin</div>
      <div class="center-circle">SPIN</div>
    </div>
    <div class="pointer"></div>
  </div>

  <button id="spinBtn" class="spin-btn">Spin Now</button>
  <div class="result" id="result">Subscribe to unlock your spin!</div>

  <div class="user-info">
    <div id="userStatus">Checking your status...</div>
    <div id="userBalance">Balance: $0</div>
    <div id="availableSpins">Available Spins: 0</div>
  </div>
</div>

<script>
const API_BASE = "https://realitylottery.koyeb.app";
const token = localStorage.getItem("rl_token");

const wheel = document.getElementById("wheel");
const spinBtn = document.getElementById("spinBtn");
const result = document.getElementById("result");
const userStatus = document.getElementById("userStatus");
const userBalance = document.getElementById("userBalance");
const availableSpinsDisplay = document.getElementById("availableSpins");

let availableSpins = 0;
let canSpin = false;

// تحقق من حالة المستخدم
async function checkEligibility() {
  if (!token) {
    spinBtn.disabled = true;
    result.textContent = "Login & subscribe to unlock your spin!";
    userStatus.textContent = "Not logged in";
    return;
  }
  try {
    const res = await fetch(`${API_BASE}/api/auth/me`, {
      headers: { Authorization: "Bearer " + token }
    });
    if (!res.ok) throw new Error("Failed to fetch user data");
    const data = await res.json();

    availableSpins = data.availableSpins ?? 0;
    availableSpinsDisplay.textContent = `Available Spins: ${availableSpins}`;
    userBalance.textContent = `Balance: $${data.balance ?? 0}`;

    if (availableSpins > 0) {
      canSpin = true;
      spinBtn.disabled = false;
      result.textContent = `You have ${availableSpins} spin${availableSpins > 1 ? 's' : ''} available 🎉`;
      userStatus.textContent = "You can spin now";
      userStatus.style.color = "var(--success-color)";
    } else {
      canSpin = false;
      spinBtn.disabled = true;
      result.textContent = "No spins available ❌";
      userStatus.textContent = "No spins available";
      userStatus.style.color = "var(--error-color)";
    }
  } catch (err) {
    console.error("Eligibility error:", err);
    spinBtn.disabled = true;
    result.textContent = "Error checking eligibility ❌";
    userStatus.textContent = "Error loading status";
    userStatus.style.color = "var(--error-color)";
  }
}

// دوران العجلة
spinBtn.addEventListener("click", async () => {
  if (!canSpin) return;

  const sectors = document.querySelectorAll(".wheel-section-item");
  const sectorCount = sectors.length;
  const sectorDeg = 360 / sectorCount;

  const extraRotation = Math.floor(Math.random() * 360);
  const deg = 2000 + extraRotation;
  wheel.style.transition = 'transform 5s cubic-bezier(0.17,0.67,0.21,0.99)';
  wheel.style.transform = `rotate(${deg}deg)`;

  spinBtn.disabled = true;
  result.textContent = "Spinning...";

  setTimeout(async () => {
    const normalizedDeg = deg % 360;
    const sectorIndex = Math.floor(((360 - normalizedDeg + sectorDeg/2) % 360) / sectorDeg);
    const winningSector = sectors[sectorIndex];

    const prize = {
      prize: winningSector.dataset.prize,
      type: winningSector.dataset.type,
      amount: parseInt(winningSector.dataset.amount)
    };

    try {
      const response = await fetch(`${API_BASE}/api/wheel/spin`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token
        },
        body: JSON.stringify(prize)
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.msg || "Server error");
      }

      const spinResult = await response.json();

      availableSpins = spinResult.availableSpins ?? 0;
      availableSpinsDisplay.textContent = `Available Spins: ${availableSpins}`;
      userBalance.textContent = `Balance: $${spinResult.balance ?? 0}`;
      canSpin = availableSpins > 0;
      spinBtn.disabled = !canSpin;

      result.textContent = spinResult.message;

      // تحديث بيانات المستخدم
      const currentUser = JSON.parse(localStorage.getItem("rl_user") || "{}");
      const updatedUser = {
        ...currentUser,
        balance: spinResult.balance ?? currentUser.balance,
        availableSpins: spinResult.availableSpins ?? currentUser.availableSpins
      };
      localStorage.setItem("rl_user", JSON.stringify(updatedUser));

    } catch (err) {
      console.error("Spin error:", err);
      result.textContent = err.message || "Error processing spin";
      spinBtn.disabled = true;
      setTimeout(checkEligibility, 2000);
    }
  }, 5000);
});

checkEligibility();
</script>

</body>
</html>
