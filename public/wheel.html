<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lucky Wheel - RealityLottery</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    :root {
      --primary-color: #ffd700;  /* Ø°Ù‡Ø¨ÙŠ */
      --secondary-color: #ffa500;
      --dark-bg: #000;           /* Ø£Ø³ÙˆØ¯ */
      --card-bg: #111;
      --text-light: #eee;
    }

    body {
      background: var(--dark-bg);
      color: var(--text-light);
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
    }

    header {
      padding: 15px;
      background: var(--card-bg);
      font-size: 24px;
      font-weight: bold;
      color: var(--primary-color);
      box-shadow: 0 2px 10px rgba(255,215,0,0.3);
    }

    .wheel-container {
      position: relative;
      width: 360px;
      height: 360px;
      margin: 50px auto 20px;
      border-radius: 50%;
      overflow: hidden;
      box-shadow: 0 0 25px rgba(255,215,0,0.4);
    }

    .wheel {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 10px solid var(--primary-color);
      background: conic-gradient(
        #1a1a1a 0deg 60deg,
        #2b2b2b 60deg 120deg,
        #1a1a1a 120deg 180deg,
        #2b2b2b 180deg 240deg,
        #1a1a1a 240deg 300deg,
        #2b2b2b 300deg 360deg
      );
      transition: transform 6s cubic-bezier(0.25, 1, 0.5, 1);
      position: relative;
    }

    .wheel::after {
      content: "$1  $2  $3  âŒ  ğŸ”„  âŒ";
      font-size: 26px;
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: space-around;
      align-items: center;
      flex-wrap: wrap;
      color: var(--primary-color);
      text-shadow: 0 0 8px rgba(255,215,0,0.8);
    }

    .pointer {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 25px solid transparent;
      border-right: 25px solid transparent;
      border-bottom: 35px solid var(--primary-color);
      filter: drop-shadow(0 0 5px var(--primary-color));
    }

    .spin-btn {
      margin-top: 25px;
      background: var(--primary-color);
      color: #000;
      padding: 14px 35px;
      font-size: 20px;
      font-weight: bold;
      border-radius: 35px;
      border: none;
      cursor: pointer;
      transition: 0.3s;
      box-shadow: 0 0 15px rgba(255,215,0,0.5);
    }

    .spin-btn:hover:enabled {
      transform: scale(1.05);
      background: var(--secondary-color);
    }

    .spin-btn:disabled {
      background: #444;
      color: #999;
      cursor: not-allowed;
      box-shadow: none;
    }

    .result {
      margin-top: 30px;
      font-size: 22px;
      font-weight: bold;
      color: var(--primary-color);
      min-height: 30px;
    }
  </style>
</head>
<body>

<header>ğŸ¡ Lucky Wheel</header>

<div class="wheel-container">
  <div class="wheel" id="wheel"></div>
  <div class="pointer"></div>
</div>

<button id="spinBtn" class="spin-btn">Spin Now</button>

<div class="result" id="result">Subscribe to unlock your spin!</div>

<script>
  const API_BASE = "https://realitylottery.koyeb.app";
  const token = localStorage.getItem("rl_token");

  const wheel = document.getElementById("wheel");
  const spinBtn = document.getElementById("spinBtn");
  const result = document.getElementById("result");
  let canSpin = false;

  const prizes = [
    { label: "$1", type: "money", amount: 1 },
    { label: "$2", type: "money", amount: 2 },
    { label: "$3", type: "money", amount: 3 },
    { label: "âŒ Better Luck", type: "lose" },
    { label: "ğŸ”„ Extra Spin", type: "extra" },
    { label: "âŒ Better Luck", type: "lose" }
  ];

  // ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ø¯ÙˆØ±Ø§Ù†
  async function checkEligibility() {
    if (!token) {
      spinBtn.disabled = true;
      result.textContent = "Login & subscribe to unlock your spin!";
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/api/auth/me`, {
        headers: { Authorization: "Bearer " + token }
      });
      if (!res.ok) throw new Error("Failed to fetch user");

      const data = await res.json();
      localStorage.setItem("rl_user", JSON.stringify(data));

      if (data.subscriptionActive && !data.hasSpunWheel) {
        canSpin = true;
        spinBtn.disabled = false;
        result.textContent = "You have 1 spin available ğŸ‰";
      } else if (data.subscriptionActive && data.hasSpunWheel) {
        spinBtn.disabled = true;
        result.textContent = "You already used your spin this subscription âŒ";
      } else {
        spinBtn.disabled = true;
        result.textContent = "Subscribe to unlock your spin!";
      }
    } catch (err) {
      console.error(err);
      spinBtn.disabled = true;
      result.textContent = "Error checking spin eligibility.";
    }
  }

  spinBtn.addEventListener("click", async () => {
  if (!canSpin) return;

  const deg = Math.floor(2000 + Math.random() * 2000);
  wheel.style.transform = `rotate(${deg}deg)`;
  spinBtn.disabled = true;

  setTimeout(async () => {
    const sector = ((deg % 360) / 60) | 0;
    const prize = prizes[5 - sector];

    try {
      // Ø£Ø±Ø³Ù„ Ø§Ù„Ø¯ÙˆØ±Ø§Ù† Ù„Ù„Ø³ÙŠØ±ÙØ± Ø¯Ø§Ø¦Ù…Ù‹Ø§
      const response = await fetch(`${API_BASE}/api/wheel/spin`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token
        },
        body: JSON.stringify({
          prize: prize.type,
          amount: prize.amount || 0
        })
      });

      if (!response.ok) throw new Error("Spin API failed");

      const updatedUser = await response.json(); // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
      localStorage.setItem("rl_user", JSON.stringify(updatedUser));

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
      if (prize.type === "money") {
  result.textContent = `ğŸ You won $${prize.amount}! Balance updated.`;
} else if (prize.type === "extra") {
  result.textContent = `ğŸ”„ Congrats! You earned an Extra Spin`;
  canSpin = true;
  spinBtn.disabled = false;
} else {
  result.textContent = `âŒ Better Luck Next Time`;
      }
      // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø± Ø¨Ø¹Ø¯ ÙƒÙ„ Ù„ÙØ©
      await checkEligibility();

    } catch (err) {
      console.error("Error processing spin:", err);
      result.textContent = "Error processing spin.";
    }
  }, 6000);
});
  // ØªØ­Ù‚Ù‚ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
  checkEligibility();
</script>

</body>
</html>
